
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatability definitions
    \def\gt{>}
    \def\lt{<}
    % Document parameters
    \title{007\_Multiplicative\_Conserving\_NN}
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    tgb - 3/19/2019 - This script aims at introducing a
multiplicative-conserving network. For each conservation step, the
vertical profiles are isolated on one side while the scalars are
isolated on the other side. The vertical profiles are then multiplied by
the right constant so that the invariant is conserved: \textbf{\emph{
{[}PHQ, PHCLDLIQ, PHCLDICE, TPHYSTND, DTVKE, FSNT, FSNS, FLNT, FLNS,
PRECT, PRECTEND, PRECST, PRECSTEN{]} as a function of:\\
{[}QBP, QCBP, QIBP, TBP, VBP, Qdt\_adiabatic, QCdt\_adiabatic,
QIdt\_adiabatic, Tdt\_adiabatic, Vdt\_adiabatic, PS, SOLIN, SHFLX,
LHFLX{]}\\
}} to now predict: \textbf{\emph{ {[}PHQ, PHCLDLIQ, PHCLDICE, TPHYSTND,
QRL, QRS, DTVKE, FSNT, FSNS, FLNT, FLNS, PRECT, PRECTEND, PRECST,
PRECSTEN{]} as a function of:\\
{[}QBP, QCBP, QIBP, TBP, VBP, Qdt\_adiabatic, QCdt\_adiabatic,
QIdt\_adiabatic, Tdt\_adiabatic, Vdt\_adiabatic, PS, SOLIN, SHFLX,
LHFLX{]} }}\\
Two remarks:\\
1) The energy conservation constraint will now involve a mass-weighted
integral of QRL and QRS, knowing that:\\
\[
\int_{0}^{p_{s}}\frac{dp}{g}c_{p}QRL\left(p\right)=FLNS-FLNT
\] \[
\int_{0}^{p_{s}}\frac{dp}{g}c_{p}QRS\left(p\right)=FSNT-FSNS
\]\\
2) For consistency, we shoud calculate FLNS, FSNS as residuals from
(QRL,FLNT) and (QRS,FSNS) respectively

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{c+ch}{\PYZsh{}!ln \PYZhy{}s /filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/cbrain \PYZbs{}}
        \PY{c+c1}{\PYZsh{}/filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/notebooks/tbeucler\PYZus{}devlog/cbrain}
        \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{imports} \PY{k}{import} \PY{o}{*}
        \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{data\PYZus{}generator} \PY{k}{import} \PY{o}{*}
        \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{o}{*}
        \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{losses} \PY{k}{import} \PY{o}{*}
        \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{utils} \PY{k}{import} \PY{n}{limit\PYZus{}mem}
        \PY{k+kn}{import} \PY{n+nn}{tensorflow} \PY{k}{as} \PY{n+nn}{tf}
        \PY{k+kn}{import} \PY{n+nn}{tensorflow}\PY{n+nn}{.}\PY{n+nn}{math} \PY{k}{as} \PY{n+nn}{tfm}
        \PY{k+kn}{from} \PY{n+nn}{tensorflow}\PY{n+nn}{.}\PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{layers} \PY{k}{import} \PY{o}{*}
        \PY{k+kn}{from} \PY{n+nn}{tensorflow}\PY{n+nn}{.}\PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{o}{*}
        \PY{k+kn}{import} \PY{n+nn}{xarray} \PY{k}{as} \PY{n+nn}{xr}
        \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{c+c1}{\PYZsh{} Otherwise tensorflow will use ALL your GPU RAM for no reason}
        \PY{n}{limit\PYZus{}mem}\PY{p}{(}\PY{p}{)}
        \PY{n}{TRAINDIR} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/local/Tom.Beucler/SPCAM\PYZus{}PHYS/}\PY{l+s+s1}{\PYZsq{}}
        \PY{n}{DATADIR} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/project/meteo/w2w/A6/S.Rasp/SP\PYZhy{}CAM/sp32fbp\PYZus{}andkua/}\PY{l+s+s1}{\PYZsq{}}
        \PY{n}{PREFIX} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{32\PYZus{}col\PYZus{}rad\PYZus{}12m\PYZus{}}\PY{l+s+s1}{\PYZsq{}}
        \PY{o}{\PYZpc{}}\PY{k}{cd} /filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/home/t/Tom.Beucler/miniconda3/lib/python3.6/importlib/\_bootstrap.py:219: RuntimeWarning: compiletime version 3.5 of module 'tensorflow.python.framework.fast\_tensor\_util' does not match runtime version 3.6
  return f(*args, **kwds)

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
/filer/z-sv-pool12c/t/Tom.Beucler/SPCAM/CBRAIN-CAM

    \end{Verbatim}

    \hypertarget{create-data-generator-and-produce-data-sample}{%
\subsection{1) Create data generator and produce data
sample}\label{create-data-generator-and-produce-data-sample}}

    \hypertarget{create-data-generator-from-training-dataset}{%
\subsubsection{1.1) Create data generator from training
dataset}\label{create-data-generator-from-training-dataset}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{n}{train\PYZus{}gen\PYZus{}obj} \PY{o}{=} \PY{n}{DataGenerator}\PY{p}{(}
            \PY{n}{data\PYZus{}dir}\PY{o}{=}\PY{n}{TRAINDIR}\PY{p}{,} 
            \PY{n}{feature\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}shuffle\PYZus{}features.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{target\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}shuffle\PYZus{}targets.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{batch\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{512}\PY{p}{,}
            \PY{n}{norm\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{fsub}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}   \PY{c+c1}{\PYZsh{} Subtract the mean}
            \PY{n}{fdiv}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} Then divide by Std}
            \PY{n}{tmult}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}conv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} For targets/output: use values from preprocess\PYZus{}aqua.}
            \PY{n}{shuffle}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}
        \PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Generator will have 9338880 samples in 18240 batches
Features have shape 304; targets have shape 218

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{n}{gen} \PY{o}{=} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{return\PYZus{}generator}\PY{p}{(}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} Produce data sample}
        \PY{n}{x}\PY{p}{,} \PY{n}{y} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} and check its shape}
        \PY{n}{x}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{y}\PY{o}{.}\PY{n}{shape}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}4}]:} ((512, 304), (512, 218))
\end{Verbatim}
            
    \hypertarget{create-data-generator-from-validation-dataset-and-produce-sample}{%
\subsubsection{1.2) Create data generator from validation dataset and
produce
sample}\label{create-data-generator-from-validation-dataset-and-produce-sample}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{n}{valid\PYZus{}gen\PYZus{}obj} \PY{o}{=} \PY{n}{DataGenerator}\PY{p}{(}
            \PY{n}{data\PYZus{}dir}\PY{o}{=}\PY{n}{TRAINDIR}\PY{p}{,} 
            \PY{n}{feature\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{valid\PYZus{}shuffle\PYZus{}features.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{target\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{valid\PYZus{}shuffle\PYZus{}targets.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{batch\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{512}\PY{p}{,}
            \PY{n}{norm\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{fsub}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}   \PY{c+c1}{\PYZsh{} Subtracct the mean}
            \PY{n}{fdiv}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} Then divide by Std}
            \PY{n}{tmult}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}conv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} For targets/output: use values from preprocess\PYZus{}aqua.}
            \PY{n}{shuffle}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}
        \PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Generator will have 3514368 samples in 6864 batches
Features have shape 304; targets have shape 218

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}6}]:} \PY{n}{validgen} \PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{return\PYZus{}generator}\PY{p}{(}\PY{p}{)}
        
        \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{validgen}\PY{p}{)}
        
        \PY{n}{xval}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{yval}\PY{o}{.}\PY{n}{shape}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}6}]:} ((512, 304), (512, 218))
\end{Verbatim}
            
    \hypertarget{building-the-custom-layers-for-massenergy-multiplicative-conserving-neural-networks}{%
\subsection{2) Building the custom layers for mass/energy
multiplicative-conserving neural
networks}\label{building-the-custom-layers-for-massenergy-multiplicative-conserving-neural-networks}}

    \hypertarget{load-all-the-normalization-variables}{%
\subsection{2.1) Load all the normalization
variables}\label{load-all-the-normalization-variables}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}8}]:} \PY{c+c1}{\PYZsh{} 1) Open the file containing the normalization of the targets}
        \PY{n}{ds} \PY{o}{=} \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{TRAINDIR} \PY{o}{+} \PY{n}{PREFIX} \PY{o}{+} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} 2) Open the pickle files containing the pressure converters}
        \PY{k}{with} \PY{n+nb}{open}\PY{p}{(}\PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/cbrain}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai\PYZus{}hybi.pkl}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rb}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{k}{as} \PY{n}{f}\PY{p}{:}
                    \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi} \PY{o}{=} \PY{n}{pickle}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{n}{f}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} 3) Define fsub, fdiv, normq}
        \PY{n}{fsub} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}means}\PY{o}{.}\PY{n}{values}
        \PY{n}{fdiv} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{o}{.}\PY{n}{values}
        \PY{n}{normq} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}\PY{o}{.}\PY{n}{values}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fsub.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{fsub}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fdiv.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{fdiv}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{normq.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{normq}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{hyai}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hybi.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{hybi}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        
        \PY{n}{ds}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
fsub.shape= (304,)
fdiv.shape= (304,)
normq.shape= (218,)
hyai.shape= (31,)
hybi.shape= (31,)

    \end{Verbatim}

    \hypertarget{check-radiative-integrals-in-numpy}{%
\subsection{2.2) Check radiative integrals in
numpy}\label{check-radiative-integrals-in-numpy}}

tgb - 2/8/2019 - We are checking that: \[
\int_{0}^{p_{s}}\frac{dp}{g}c_{p}QRL\left(p\right)=FLNS-FLNT
\] \[
\int_{0}^{p_{s}}\frac{dp}{g}c_{p}QRS\left(p\right)=FSNT-FSNS
\]\\
Using the normalization to units W/m2, we are checking that:\\
\[
\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta QRL=FLNS-FLNT
\] \[
\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta QRS=FSNT-FSNS
\] x = {[}QBP, QCBP, QIBP, TBP, VBP, Qdt\_adiabatic, QCdt\_adiabatic,
QIdt\_adiabatic, Tdt\_adiabatic, Vdt\_adiabatic, PS, SOLIN, SHFLX,
LHFLX{]}\\
y = {[}PHQ, PHCLDLIQ, PHCLDICE, TPHYSTND, QRL, QRS, DTVKE, FSNT, FSNS,
FLNT, FLNS, PRECT, PRECTEND, PRECST, PRECSTEN{]}\\
In this sub-section we have several objectives:\\
1) Making sure that for y, the integral relation holds\\
2) Coding the surface radiation layer in numpy\\
3) Convert the surface radiation layer to tensorflow

    \hypertarget{checking-consistency-of-radiative-integrals}{%
\subsubsection{2.2.1) Checking consistency of
radiative-integrals}\label{checking-consistency-of-radiative-integrals}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}7}]:} \PY{n}{x}\PY{p}{,}\PY{n}{y} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)} \PY{c+c1}{\PYZsh{} x.shape = 304 \PYZam{} y.shape = 218}
        \PY{k+kn}{import} \PY{n+nn}{copy}
        \PY{n}{inp} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{x}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} 0) Constants}
        \PY{n}{C\PYZus{}P} \PY{o}{=} \PY{l+m+mf}{1.00464e3} \PY{c+c1}{\PYZsh{} Specific heat capacity of air at constant pressure}
        \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
        \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
                
        \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
        \PY{n}{PS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
        \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                    \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
        \PY{n}{dP} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
        \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                             \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                   \PY{n}{G}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
        \PY{c+c1}{\PYZsh{} Wondering about broadcasting here...}
        \PY{c+c1}{\PYZsh{} tf.div or simply \PYZbs{} would support broadcasting }
        \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} 2) Radiative integrals}
        \PY{n}{SWVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{150}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]}\PY{p}{)}
        \PY{n}{SWINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{SWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
        \PY{n}{SWNET} \PY{o}{=} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{210}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{211}\PY{p}{]} \PY{c+c1}{\PYZsh{} FSNT\PYZhy{}FSNS}
        
        \PY{n}{LWVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
        \PY{n}{LWINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{LWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{} LW integral}
        \PY{n}{LWNET} \PY{o}{=} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{213}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{212}\PY{p}{]} \PY{c+c1}{\PYZsh{} FLNS\PYZhy{}FLNT}
        
        \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{SWINT}\PY{o}{\PYZhy{}}\PY{n}{SWNET}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}7}]:} (array([  1.,   5.,  20., 305., 127.,  37.,   9.,   5.,   2.,   1.]),
         array([-7.37983379e-05, -5.51983819e-05, -3.65984259e-05, -1.79984699e-05,
                 6.01486124e-07,  1.92014421e-05,  3.78013981e-05,  5.64013541e-05,
                 7.50013101e-05,  9.36012661e-05,  1.12201222e-04]),
         <a list of 10 Patch objects>)
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_14_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{coding-surface-radiation-layer-in-numpy}{%
\subsubsection{2.2.2) Coding surface radiation layer in
numpy}\label{coding-surface-radiation-layer-in-numpy}}

tgb - 3/19/2019 - The multiplicative conserving layer is simple in that
the dimension of the layer remains unchanged.\\
From: y = {[}PHQ(0-29), PHCLDLIQ(30-59), PHCLDICE(60-89),
TPHYSTND(90-119), QRL(120-149), QRS(150-179), DTVKE(180-209), FSNT(210),
FSNS(211), FLNT(212), FLNS(213), PRECT(214), PRECTEND(215), PRECST(216),
PRECSTEN(217){]}, we need to isolate:\\
y\_left = QRS(150-179) \& y\_right = FSNT(210), FSNS(211)\\
y\_left = QRL(120-149) \& y\_right = FLNT(212), FLNS(213)

y\_right may be 0 in the shortwave case at night; in that particular
case, it is OK to multiply y\_left by 0 because y\_left is identically 0
throughout the column at night. **** To be consistent, the radiative
integrals need to verify: \[
\int sw\frac{dp}{g}=\mathrm{NETSW},
\] \[
\int lw\frac{dp}{g}=\mathrm{NETLW}.
\] Starting from the profiles
\(sw_{0}\left(p\right),lw_{0}\left(p\right)\\)and the net radiative
fluxes \(\mathrm{NETSW}_{0},\mathrm{NETLW}_{0}\), we simply multiply the
profiles by a constant to satisfy the radiative integral relation: \[
sw=sw_{0}\times\frac{\mathrm{NETSW}_{0}}{\int sw_{0}dp/g},
\] \[
lw=lw_{0}\times\frac{\mathrm{NETLW}_{0}}{\int lw_{0}dp/g}.
\]

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}8}]:} \PY{n}{x}\PY{p}{,}\PY{n}{y} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)} \PY{c+c1}{\PYZsh{} x.shape = 304 \PYZam{} y.shape = 218}
        \PY{k+kn}{import} \PY{n+nn}{copy}
        \PY{n}{inp} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{x}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Mimic vector that comes in}
        \PY{n}{ybef} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{y}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} Introduce random noise to mimic the effect of a NN that deviates from the truth}
        \PY{n}{ybef} \PY{o}{=} \PY{n}{ybef}\PY{o}{+}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{normal}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{(}\PY{n}{ybef}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{ybef}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
        \PY{n}{yaft} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{ybef}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} 0) Constants}
        \PY{n}{C\PYZus{}P} \PY{o}{=} \PY{l+m+mf}{1.00464e3} \PY{c+c1}{\PYZsh{} Specific heat capacity of air at constant pressure}
        \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
        \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
                
        \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
        \PY{n}{PS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
        \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                    \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
        \PY{n}{dP} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
        \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                             \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                   \PY{n}{G}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
        \PY{c+c1}{\PYZsh{} Wondering about broadcasting here...}
        \PY{c+c1}{\PYZsh{} tf.div or simply \PYZbs{} would support broadcasting }
        \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} 2) Radiative integrals}
        \PY{n}{SWVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{150}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]}\PY{p}{)}
        \PY{n}{SWINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{SWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
        \PY{n}{SWNET} \PY{o}{=} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{210}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{211}\PY{p}{]} \PY{c+c1}{\PYZsh{} FSNT\PYZhy{}FSNS}
        \PY{n}{SWRAT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{SWNET}\PY{p}{,} \PY{n}{SWINT}\PY{p}{)}
        \PY{n}{yaft}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{150}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{SWRAT}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{150}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}print(SWRAT)}
        
        \PY{n}{LWVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
        \PY{n}{LWINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{LWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{} LW integral}
        \PY{n}{LWNET} \PY{o}{=} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{213}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{212}\PY{p}{]} \PY{c+c1}{\PYZsh{} FLNS\PYZhy{}FLNT}
        \PY{n}{LWRAT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{LWNET}\PY{p}{,} \PY{n}{LWINT}\PY{p}{)}
        \PY{n}{yaft}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{LWRAT}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}print(LWRAT)}
        
        \PY{c+c1}{\PYZsh{} 3) Check energy conservation after multiplication}
        \PY{n}{SWVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{yaft}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{150}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]}\PY{p}{)}
        \PY{n}{SWINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{SWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
        \PY{n}{SWNET} \PY{o}{=} \PY{n}{yaft}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{210}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{yaft}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{211}\PY{p}{]} \PY{c+c1}{\PYZsh{} FSNT\PYZhy{}FSNS}
        
        \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{SWINT}\PY{o}{\PYZhy{}}\PY{n}{SWNET}\PY{p}{)}
        
        \PY{n}{LWVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{yaft}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
        \PY{n}{LWINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{LWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{} LW integral}
        \PY{n}{LWNET} \PY{o}{=} \PY{n}{yaft}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{213}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{yaft}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{212}\PY{p}{]} \PY{c+c1}{\PYZsh{} FLNS\PYZhy{}FLNT}
        
        \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{LWINT}\PY{o}{\PYZhy{}}\PY{n}{LWNET}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}plt.hist(yaft[:,210]\PYZhy{}y[:,210])}
        \PY{c+c1}{\PYZsh{}plt.hist(yaft[:,211]\PYZhy{}y[:,211])}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}8}]:} (array([  8.,  34.,   2., 106.,  15., 211.,  97.,   0.,  33.,   6.]),
         array([-8.52651283e-14, -6.82121026e-14, -5.11590770e-14, -3.41060513e-14,
                -1.70530257e-14,  0.00000000e+00,  1.70530257e-14,  3.41060513e-14,
                 5.11590770e-14,  6.82121026e-14,  8.52651283e-14]),
         <a list of 10 Patch objects>)
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_16_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{port-the-surface-radiation-layer-to-tensorflow}{%
\subsubsection{3.2.3) Port the surface radiation layer to
tensorflow}\label{port-the-surface-radiation-layer-to-tensorflow}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}25}]:} \PY{k}{class} \PY{n+nc}{MulSurRadLay}\PY{p}{(}\PY{n}{Layer}\PY{p}{)}\PY{p}{:}
             
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{p}{,} \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{p}{,} \PY{n}{eps}\PY{p}{,} \PY{n}{output\PYZus{}dim}\PY{p}{,} \PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub} \PY{o}{=} \PY{n}{fsub} \PY{c+c1}{\PYZsh{} Subtraction for normalization of inputs }
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv} \PY{o}{=} \PY{n}{fdiv} \PY{c+c1}{\PYZsh{} Division for normalization of inputs}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq} \PY{o}{=} \PY{n}{normq} \PY{c+c1}{\PYZsh{} Normalization of output\PYZsq{}s water concentration}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai} \PY{o}{=} \PY{n}{hyai} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi} \PY{o}{=} \PY{n}{hybi} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{eps} \PY{o}{=} \PY{n}{eps} \PY{c+c1}{\PYZsh{} Minimal denominator when calculating ratio (W/m2)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{n}{output\PYZus{}dim} \PY{c+c1}{\PYZsh{} Dimension of output}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n+nf+fm}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{build}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{build}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{)}  \PY{c+c1}{\PYZsh{} Be sure to call this somewhere!}
             
             \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/6/2019 \PYZhy{} following https://github.com/keras\PYZhy{}team/keras/issues/4871}
             \PY{k}{def} \PY{n+nf}{get\PYZus{}config}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{n}{config} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fsub}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fdiv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{normq}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hybi}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{eps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{eps}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{output\PYZus{}dim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{\PYZcb{}}
                 \PY{n}{base\PYZus{}config} \PY{o}{=} \PY{n+nb}{super}\PY{p}{(}\PY{n}{MulSurRadLay}\PY{p}{,} \PY{n+nb+bp}{self}\PY{p}{)}\PY{o}{.}\PY{n}{get\PYZus{}config}\PY{p}{(}\PY{p}{)}
                 \PY{k}{return} \PY{n+nb}{dict}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{base\PYZus{}config}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n+nb}{list}\PY{p}{(}\PY{n}{config}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             
             \PY{k}{def} \PY{n+nf}{call}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{arrs}\PY{p}{)}\PY{p}{:}
             
                 \PY{c+c1}{\PYZsh{} Split between the inputs inp \PYZam{} the output of the densely connected}
                 \PY{c+c1}{\PYZsh{} neural network, massout}
                 \PY{n}{inp}\PY{p}{,} \PY{n}{densout} \PY{o}{=} \PY{n}{arrs}
                 
                 \PY{c+c1}{\PYZsh{} 0) Constants}
                 \PY{n}{C\PYZus{}P} \PY{o}{=} \PY{l+m+mf}{1.00464e3} \PY{c+c1}{\PYZsh{} Specific heat capacity of air at constant pressure}
                 \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
                 \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
                 \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
         
                 \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
                 \PY{n}{PS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
                 \PY{n}{P} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                             \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{)}
                 \PY{n}{dP} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
                 \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                                   \PY{n}{G}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                      \PY{n}{L\PYZus{}V}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
                 \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} 2) Radiative integrals}
                 \PY{n}{SWVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{150}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]}\PY{p}{)}
                 \PY{n}{SWINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{SWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{n}{LWVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
                 \PY{n}{LWINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{LWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{} LW integral}
         
                 \PY{c+c1}{\PYZsh{} 3) Calculate SW/LW ratio to match the radiative integral}
                 \PY{n}{SWRAT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{210}\PY{p}{]}\PY{p}{,}\PYZbs{}
                                                  \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{211}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                    \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{sign}\PY{p}{(}\PY{n}{SWINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                 \PY{n}{tfm}\PY{o}{.}\PY{n}{maximum}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{SWINT}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{eps}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                 \PY{n}{LWRAT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{213}\PY{p}{]}\PY{p}{,}\PYZbs{}
                                                  \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{212}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                    \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{sign}\PY{p}{(}\PY{n}{LWINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                 \PY{n}{tfm}\PY{o}{.}\PY{n}{maximum}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{LWINT}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{eps}\PY{p}{)}\PY{p}{)}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} 4) Multiply the vertical SW/LW profiles to match the net flux}
                 \PY{n}{out} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{,}\PYZbs{}
                                  \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,}\PY{n}{tf}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{LWRAT}\PY{p}{,}\PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                  \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]}\PY{p}{,}\PY{n}{tf}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{SWRAT}\PY{p}{,}\PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                 \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{180}\PY{p}{:}\PY{l+m+mi}{218}\PY{p}{]}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{k}{return} \PY{n}{out}
             
             \PY{k}{def} \PY{n+nf}{compute\PYZus{}output\PYZus{}shape}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/7/2019 \PYZhy{} Wrap the returned output shape in Tensorshape}
                 \PY{c+c1}{\PYZsh{} to avoid problems with custom layers \PYZam{} eager execution}
                 \PY{c+c1}{\PYZsh{} https://github.com/tensorflow/tensorflow/issues/20805}
                 \PY{k}{return} \PY{n}{tf}\PY{o}{.}\PY{n}{TensorShape}\PY{p}{(}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{)}\PY{p}{)} 
             \PY{c+c1}{\PYZsh{} The layer takes inputs from the previous layer that have shape 124}
             \PY{c+c1}{\PYZsh{} and outputs y of shape 126 to be fed to the mass cons. layers}
\end{Verbatim}


    \hypertarget{code-multiplicative-conserving-mass-enthalpy-layer}{%
\subsection{3.3) Code multiplicative-conserving mass-enthalpy
layer}\label{code-multiplicative-conserving-mass-enthalpy-layer}}

The dimensionless water and enthalpy conservation equations have the
following form: \[
\int\left(\dot{q_{v}}+\dot{q_{l}}+\dot{q_{i}}\right)dp=LHF-P=MAS
\] \[
\int\left(\dot{T}-\dot{T_{KE}}+\frac{L_{f}}{L_{v}}\dot{q_{l}}+\frac{L_{s}}{L_{v}}\dot{q_{v}}\right)dp=RAD+SHF+PHAS+\frac{L_{s}}{L_{v}}LHF=ENT
\] Because there are two constraints involving the same variables with
different coefficients, we'll multiply the water tendency profiles by
one constant \(\alpha\\)and the non-radiative temperature tendency
profiles by a different constant \(\beta\\)such that: \[
MAS_{0}=\int\left(\dot{q_{v}}+\dot{q_{l}}+\dot{q_{i}}\right)dp=\alpha\int\left(\dot{q_{v}}+\dot{q_{l}}+\dot{q_{i}}\right)_{0}dp
\] \[
\alpha=\frac{MAS_{0}}{\int\left(\dot{q_{v}}+\dot{q_{l}}+\dot{q_{i}}\right)_{0}dp}
\] \[
\begin{aligned}ENT_{0} & =\int\left(\dot{T}-\dot{T_{KE}}+\frac{L_{f}}{L_{v}}\dot{q_{l}}+\frac{L_{s}}{L_{v}}\dot{q_{v}}\right)dp\\
 & =\beta\int\left(\dot{T}-\dot{T_{KE}}\right)_{0}dp+\alpha\int\left(\frac{L_{f}}{L_{v}}\dot{q_{l}}+\frac{L_{s}}{L_{v}}\dot{q_{v}}\right)_{0}dp\\
\beta & =\frac{ENT_{0}}{\int\left(\dot{T}-\dot{T_{KE}}\right)_{0}dp}-\alpha\frac{\int\left(L_{f}\dot{q_{l}}/L_{v}+L_{s}\dot{q_{v}}/L_{v}\right)_{0}dp}{\int\left(\dot{T}-\dot{T_{KE}}\right)_{0}dp}
\end{aligned}
\] \#\#\# 3.3.1) Develop it in numpy

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}10}]:} \PY{n}{x}\PY{p}{,}\PY{n}{y} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)} \PY{c+c1}{\PYZsh{} x.shape = 304 \PYZam{} y.shape = 218}
         \PY{k+kn}{import} \PY{n+nn}{copy}
         \PY{n}{inp} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{x}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Mimic vector that comes in}
         \PY{n}{ybef} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{y}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} Introduce random noise to mimic the effect of a NN that deviates from the truth}
         \PY{n}{ybef} \PY{o}{=} \PY{n}{ybef}\PY{o}{+}\PY{l+m+mi}{0}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{normal}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{(}\PY{n}{ybef}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{ybef}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} 0) Constants}
         \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
         \PY{n}{L\PYZus{}F} \PY{o}{=} \PY{l+m+mf}{3.337e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of fusion of water [W.kg\PYZhy{}1]}
         \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
         \PY{n}{L\PYZus{}S} \PY{o}{=} \PY{n}{L\PYZus{}F}\PY{o}{+}\PY{n}{L\PYZus{}V}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of sublimation of water [W.kg\PYZhy{}1]}
         \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]   }
         
         \PY{c+c1}{\PYZsh{} WATER\PYZam{}ENTHALPY) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
         \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
         \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
         \PY{n}{PS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
         \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
         \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
         \PY{n}{dP} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
         \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
         \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                   \PY{n}{G}\PY{p}{)}\PY{p}{,}\PYZbs{}
         \PY{n}{L\PYZus{}V}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
         \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} WATER.1) Calculate water vertical integral from level 1 to level 30}
         \PY{n}{WATVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]} \PY{o}{+} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]} \PY{o}{+} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}
         \PY{n}{WATINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{WATVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} WATER.2) Calculate forcing on the right\PYZhy{}hand side (Net Evaporation\PYZhy{}Precipitation)}
         \PY{c+c1}{\PYZsh{} E\PYZhy{}P is already normalized to units W.m\PYZhy{}2 in the output vector}
         \PY{c+c1}{\PYZsh{} so all we need to do is input\PYZhy{}unnormalize LHF that is taken from the input vector}
         \PY{n}{LHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} Note that total precipitation = PRECT + 1e\PYZhy{}3*PRECTEND in the CAM model}
         \PY{c+c1}{\PYZsh{} PRECTEND already multiplied by 1e\PYZhy{}3 in output vector so no need to redo it}
         \PY{n}{PREC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{214}\PY{p}{]}\PY{p}{,} \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{215}\PY{p}{]}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} WATER.FINAL) Ratio = (E\PYZhy{}P)/(DWATER/DT)}
         \PY{n}{WATRAT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{n}{LHF}\PY{p}{,}\PY{n}{PREC}\PY{p}{)}\PY{p}{,}\PYZbs{}
                            \PY{n}{WATINT}\PY{p}{)}
         \PY{n}{yint} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{WATRAT}\PY{p}{,}\PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{ybef}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} ENTHALPY.1) Calculate net energy input from phase change and precipitation}
         \PY{c+c1}{\PYZsh{} PHAS = Lf/Lv*((PRECST+PRECSTEN)\PYZhy{}(PRECT+PRECTEND))}
         \PY{n}{PHAS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                               \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{216}\PY{p}{]}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{217}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                               \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{214}\PY{p}{]}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{215}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                       \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                          \PY{n}{L\PYZus{}V}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} ENTHALPY.2) Calculate net energy input from radiation, sensible heat flux and turbulent KE}
         \PY{c+c1}{\PYZsh{} 2.1) RAD = FSNT\PYZhy{}FSNS\PYZhy{}FLNT+FLNS}
         \PY{n}{RAD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                 \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{210}\PY{p}{]}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{211}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                 \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{213}\PY{p}{]}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{212}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} 2.2) Unnormalize sensible heat flux}
         \PY{n}{SHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} 2.3) Net turbulent kinetic energy dissipative heating is the column\PYZhy{}integrated }
         \PY{c+c1}{\PYZsh{} turbulent kinetic energy energy dissipative heating}
         \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{180}\PY{p}{:}\PY{l+m+mi}{210}\PY{p}{]}\PY{p}{)}
         \PY{n}{KEDINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} ENTHALPY.3) Calculate tendency of normalized column water vapor due to phase change}
         \PY{c+c1}{\PYZsh{} 3.1) Column water vapor is the column integral of specific humidity}
         \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
         \PY{n}{PHQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} 3.2) Multiply by L\PYZus{}S/L\PYZus{}V to normalize (explanation above)}
         \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                      \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                         \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PYZbs{}
                            \PY{n}{L\PYZus{}V}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} ENTHALPY.4) Same operation for liquid water tendency but multiplied by L\PYZus{}F/L\PYZus{}V}
         \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PYZbs{}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PYZbs{}
                                              \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                              \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                       \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                          \PY{n}{L\PYZus{}V}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} ENTHALPY.5) Same operation for temperature tendency}
         \PY{n}{DTINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} ENTHALPY.FINAL) Ratio \PYZdq{}beta\PYZdq{} given above script}
         \PY{n}{ENTRAT1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{RAD}\PY{p}{,}\PY{n}{SHF}\PY{p}{)}\PY{p}{,}\PY{n}{PHAS}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                   \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{LHF}\PY{p}{,}\PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PY{n}{L\PYZus{}V}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                             \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{DTINT}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{KEDINT}\PY{p}{)}\PY{p}{)}\PY{p}{)}
         \PY{n}{ENTRAT2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{PHQINT}\PY{p}{,}\PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PY{n}{L\PYZus{}V}\PY{p}{)}\PY{p}{,}\PY{n}{SPDQCINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                            \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{DTINT}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{KEDINT}\PY{p}{)}\PY{p}{)}\PY{p}{)}
         \PY{n}{ENTRAT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{ENTRAT1}\PY{p}{,} \PY{n}{ENTRAT2}\PY{p}{)}
         \PY{n}{yaft} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{,}\PYZbs{}
                               \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{ENTRAT}\PY{p}{,}\PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]}\PY{p}{,}\PYZbs{}
                               \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{180}\PY{p}{:}\PY{l+m+mi}{210}\PY{p}{]}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{ENTRAT}\PY{p}{,}\PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{210}\PY{p}{:}\PY{l+m+mi}{218}\PY{p}{]}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{}print(ENTRAT)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{DTINT}\PY{o}{\PYZhy{}}\PY{n}{KEDINT}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
[-1.20952299e+02  2.54533699e+01 -1.29459029e+02 -4.83170181e+01
 -1.43279905e+02 -6.94117056e+01  2.54524702e+01  1.09682119e+01
 -1.20417076e+02 -3.32522004e+01 -7.31815887e+01 -1.62000419e+02
  3.44269495e+01  4.84963749e+01 -1.37379117e+02 -7.40621004e+00
 -2.26700706e+02 -5.91127682e+01  6.94439265e+00 -2.02681962e+02
 -3.74923511e+01  1.41808385e+02  5.00299704e+00 -9.48785512e+01
 -8.23489110e+01  1.66350401e+01 -7.05599358e+01  4.80454926e+01
 -9.84057888e+00  5.15962488e+02  5.68247975e+00 -1.96292032e+02
 -1.69299416e+02 -1.50953000e+02 -2.50703575e+02  9.26821843e+01
 -4.35784115e+01  7.54412828e+00  1.43020804e+02 -4.03942216e+01
 -1.25713777e+02 -1.11094240e+02  2.56455595e+01  3.32252808e+01
 -1.29181432e+02 -1.14787581e+02  4.56664560e+02 -1.88492679e+02
 -1.65009625e+01 -1.35426509e+02 -7.19206590e+01 -1.84190095e+02
  3.59888010e+01 -5.00788205e+01 -1.14046718e+01 -4.06222136e+01
  2.70616549e+01 -2.31733127e+01  3.67540530e+01  4.68235575e+02
 -5.25701536e+01  5.74678076e+02  2.99922333e+02 -9.93956421e+01
 -6.58363630e+01 -1.90402976e+02 -7.82170558e+01 -7.00344820e+01
  2.20497730e+01  1.88202234e+02 -9.43377791e+01 -1.26960328e+02
 -2.15232145e+01 -1.18629436e+02 -4.39408606e+01 -1.44276033e+02
 -9.40274542e+00 -1.75868913e+02 -9.32243459e+01 -1.30029800e+02
 -5.15699413e+01 -1.52523606e+02 -1.18465881e+02 -1.07560835e+02
 -1.50027613e+02 -5.84232280e+01 -3.24468211e+01 -1.48334553e+02
 -1.05339710e+02 -1.15720572e+02  4.65792452e+02 -9.21238932e+01
 -1.79939997e+02  5.41812123e+01  4.54301133e+00 -3.29472725e+01
 -2.12374040e+02 -1.64425259e+02  1.65792801e+01  5.28118100e+02
 -7.04884152e+01  1.44492235e+02 -1.18774512e+02 -1.86123975e+02
 -8.52158902e+01 -1.78897732e+02 -7.79060489e+01 -4.70444668e+01
  3.36184209e+01 -8.55636146e+00  6.62999344e+00  2.94512463e+01
  1.97973579e+02  1.32615141e+01 -6.84371133e+01 -7.42081515e+01
  4.91134739e+01 -6.54227052e+01 -1.08955008e+02 -9.48949768e+00
 -1.65220800e+02 -9.35936984e+01 -8.78270158e+01 -1.20623541e+02
 -4.15065044e+01 -5.56206091e+01 -3.03512364e+01 -2.12304228e+02
  2.62308589e+01 -1.03302345e+02 -1.26228543e+02  3.06319354e+00
 -7.42402397e+01 -8.53239605e+01  7.80195104e+01 -6.27906559e+01
  1.63821417e+01  2.37631437e+01 -1.39877471e+02  4.12697538e+00
 -1.77056898e+02  1.92670532e+02 -6.94934578e+01  9.73008468e+01
 -2.16910342e+00  5.77480549e-01 -7.38459232e+01 -6.66026045e+01
 -4.89913531e+01 -6.33543540e+01  5.60164890e+01 -1.53306308e+02
  1.73812969e+01 -2.54323953e+01  1.43822386e+01 -6.16767358e+00
 -1.70917794e+02 -1.34353924e+02 -2.51349397e+02  3.41597597e+01
  5.03568438e-01 -6.05371618e-01 -1.08705352e+02 -7.52059164e+01
 -1.81076634e+01  1.04461310e+02 -1.01104944e+02 -1.30515464e+02
 -3.84574410e+01 -1.87484173e+02 -1.33110276e+02 -1.04122750e+02
  2.52575049e+02  1.36236857e+01 -5.91243459e+01 -1.70494279e+02
 -1.82184461e+02 -1.14384392e+02 -6.18305065e+01 -8.37354192e+01
  7.76368191e+02 -1.34930004e+02  2.95190636e+01 -9.80110592e+01
 -8.12069222e+01 -8.63614112e+01  6.95886023e+01 -2.01345186e+02
  1.26589864e+02 -9.36972870e+01 -7.10316319e+01 -1.81619270e+02
 -9.71016330e+01  9.42256249e+01 -2.12920584e+01 -8.52620081e+01
 -7.09556366e+01  7.50934633e-02 -2.77136551e+01  8.23547793e+01
 -9.07208566e+01 -1.59346234e+02 -2.50121580e+02 -9.56380044e+01
 -2.68343931e+01  7.52667276e+01  5.71337955e+02 -2.05731924e+02
 -7.54059957e+01 -1.98728357e+02  9.51178801e+02 -1.99020441e+02
  2.44801986e+00 -1.64376070e+02  5.77132181e+01 -1.19847141e+02
 -1.94449040e+02 -1.93497858e+02 -1.71455590e+02  7.13888840e+02
 -5.86651046e+00 -2.31991271e+02 -3.72915806e+01 -1.29825588e+02
 -1.81789025e+02  1.66972281e+01 -1.50009610e+02 -1.16088293e+02
  2.94288327e+01 -1.55887215e+02  1.25848943e+02 -8.99517554e+01
  9.98263741e+00 -9.17193202e+01 -3.10288732e+01  4.49567208e+01
  2.65902645e+01  2.35492731e+01  1.23566421e+01 -2.35777528e+02
 -3.10451223e+01 -1.15528045e+02  6.72031659e+01 -1.05885358e+02
 -7.03876753e+01 -7.80590352e+01  4.22286662e+01 -1.79574459e+01
 -2.14094245e+02  6.41005307e+01 -8.71818097e+01 -1.31752469e+02
 -1.47202626e+02 -7.30478282e+01 -1.89090533e+02 -1.37216702e+02
 -4.87514429e+01 -1.79362999e+02 -5.95050913e+01 -2.38315021e+02
 -8.56960504e+01  1.76053260e+02  3.96177759e+01 -3.81925655e+01
 -2.45510234e+02 -1.63372804e+00  3.32640466e+02  3.28316395e+02
  1.09383767e+01 -4.87256565e+01 -1.21573710e+02 -5.29573333e+00
 -3.43511471e+01  5.05323920e+01 -2.67208253e+01 -1.51772284e+02
  2.15586024e+02  1.90052727e+02 -8.46102221e+01 -1.06796518e+02
 -1.43527854e+02 -1.13264018e+02 -1.21521409e+02 -5.08937972e+01
 -1.28949057e+02 -4.18535688e+01 -1.08611171e+02 -8.29272326e+01
 -2.31235319e+01  5.51091491e+00 -1.98194667e+02 -8.80405081e+01
 -1.84571047e+02  5.92869370e+01 -1.96100904e+02 -2.08997549e+02
 -1.85696693e+02 -1.66651938e+02 -1.95799503e+02 -3.08588171e+01
 -3.07447537e+01 -1.26347056e+02 -2.00854410e+02  3.28772096e+02
 -4.94124060e+01  7.70397660e+00 -1.47475905e+01 -2.11106761e+01
 -1.55714236e+02  1.08105841e+03 -1.57289833e+01  8.21617210e+01
 -9.38006566e+01 -2.01584212e+02  5.38829474e+02  6.94615571e+02
  1.60388516e+02  2.81091979e+01  8.05976522e+02 -2.33686313e-01
  1.03102173e+01 -8.49568239e+01 -1.30852278e+02  5.14423973e+01
 -1.23154531e+02 -5.79939674e+01 -5.36106173e+01 -5.93764997e+01
 -1.17597665e+02  1.18798511e+02 -2.30189110e+02  2.13221881e+01
 -1.29769091e+02  1.80587735e+03  4.00284072e+02  3.83779663e+01
 -1.20425386e+02  2.87624065e+03 -1.13450034e+02  1.04352058e+01
 -7.55711734e+01 -9.51336470e+01 -2.30352720e+02 -3.53387971e+01
 -1.22288698e+02 -1.58354574e+02 -1.09216543e+02 -6.53359878e+01
 -1.15971883e+02 -2.14514960e+02  1.05218374e+01 -7.59134898e+01
 -1.26860748e+02  2.20899467e+00 -7.32851087e+01 -2.02275416e+02
 -1.62278084e+02  9.32340603e+01 -2.68993870e+02 -1.13997717e+02
  4.09228476e+01 -1.56094074e+01  3.53527246e+01 -1.09826472e+02
 -1.30323216e+02 -1.83163816e+02 -2.35902820e+01 -3.41793449e+01
 -3.63236720e+00  7.09011328e+01 -2.39145672e+01 -9.27672650e+01
  2.16396385e+02  2.75232568e+02 -1.44350098e+01  1.24981498e+03
 -4.29997014e+01 -1.79502052e+02 -2.66473338e+01  1.30773028e+02
 -1.40858138e+02  1.40175364e+02 -3.65640694e+01 -2.43307290e+01
  3.12123679e+01 -1.17979176e+02 -1.21433339e+02  2.85572487e+01
  5.82076654e+01 -2.27451557e+02 -3.81482029e+01 -2.32217928e+02
 -6.34508215e+01 -1.09707734e+01 -1.68061167e+02  1.61714653e+03
 -1.84510724e+02 -9.42171369e+01  1.14677970e+03 -1.39184310e+02
  1.43271590e+01  3.01001158e+01 -9.68167456e+01 -1.49257028e+02
 -2.00436816e+02  1.70158076e+02 -1.86395604e+02  7.87666360e+01
 -1.09328702e+01  4.08366825e+02 -9.86481843e+01  8.23950210e+01
  8.69472279e+01  4.62382584e+01 -1.79837804e+02 -1.63569854e+02
 -1.06059895e+02 -3.36389855e+01 -5.60826327e+02 -4.93697514e+01
 -6.27082306e+01  2.14376153e+01 -2.01086539e+02 -8.72897165e+01
  2.71025799e+02 -2.56696920e+02  5.16897418e+00  1.01386225e+02
 -1.72424468e+02 -2.27666564e+02  4.57221309e+02 -2.01306212e+01
 -3.20553296e+01  9.28515988e+02 -1.29783461e+02 -1.34019132e+02
 -3.34618118e+00  1.08928524e+01  2.28421584e+03 -1.03234179e+01
 -2.75303128e+01 -2.33871024e+02 -1.86495616e+02 -8.94857476e+01
 -1.71906863e+02 -1.74553816e+02 -2.13521073e+02  6.33530055e+02
 -1.56454997e+02  1.23841671e+02  5.70971108e+00 -2.32082835e+01
 -9.95967524e+00  4.65985119e+01  3.51305006e+02 -7.70475039e+00
  7.32163152e+02 -1.37552534e+01  6.29738034e+01  9.72642070e+01
  1.21710475e+02 -1.25133776e+02 -1.02359841e+02  8.27076497e+00
  3.57108438e+01 -7.89834772e+01 -1.89307860e+02  6.59769338e+00
 -7.24799509e+01 -1.32619465e+02 -2.36384553e+02 -1.75820604e+02
 -8.55639555e+01  3.60494482e+01 -2.28984791e+02 -1.68962360e+02
  4.42696527e+01  2.07305635e+00 -6.83073163e+01 -1.27993145e+02
  9.42369648e+00 -2.10361190e+02 -1.39905452e+02  4.52698151e+02
  3.04615635e+02 -1.18730890e+01 -1.43315451e+02  2.19739915e+01
 -5.32663001e+01 -8.55991727e+01  6.73011617e+02  1.10909964e+02
  3.11438498e+02 -1.91152240e+02  7.55166639e+02 -1.97572671e+02
 -1.14395758e+02 -2.00116747e+02 -1.35587186e+02 -2.38311563e+02
 -7.06958508e+01 -9.55634680e+01  2.86275397e+01 -2.22447455e+01
  3.45444492e+01 -1.04818938e+02  5.99927825e+00 -1.43116333e+02
  6.48603818e+01 -2.48165034e+01  1.45366332e+02 -1.26666430e+02]

    \end{Verbatim}

    \hypertarget{function-checking-mass-and-enthalpy-conservation}{%
\subsubsection{3.3.2) Function checking mass and enthalpy
conservation}\label{function-checking-mass-and-enthalpy-conservation}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}16}]:} \PY{k}{def} \PY{n+nf}{massent\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,}\PY{n}{outtype}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{graph}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}\PY{p}{:}
             \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
             \PY{c+c1}{\PYZsh{} 0) Constants}
             \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
             \PY{n}{L\PYZus{}F} \PY{o}{=} \PY{l+m+mf}{3.337e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of fusion of water [W.kg\PYZhy{}1]}
             \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
             \PY{n}{L\PYZus{}S} \PY{o}{=} \PY{n}{L\PYZus{}F}\PY{o}{+}\PY{n}{L\PYZus{}V}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of sublimation of water [W.kg\PYZhy{}1]}
             \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]   }
         
             \PY{c+c1}{\PYZsh{} WATER\PYZam{}ENTHALPY) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
             \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
             \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
             \PY{n}{PS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
             \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
             \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
             \PY{n}{dP} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
             \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
             \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                       \PY{n}{G}\PY{p}{)}\PY{p}{,}\PYZbs{}
             \PY{n}{L\PYZus{}V}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
             \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} WATER.1) Calculate water vertical integral from level 1 to level 30}
             \PY{n}{WATVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]} \PY{o}{+} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]} \PY{o}{+} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}
             \PY{n}{WATINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{WATVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} WATER.2) Calculate forcing on the right\PYZhy{}hand side (Net Evaporation\PYZhy{}Precipitation)}
             \PY{c+c1}{\PYZsh{} E\PYZhy{}P is already normalized to units W.m\PYZhy{}2 in the output vector}
             \PY{c+c1}{\PYZsh{} so all we need to do is input\PYZhy{}unnormalize LHF that is taken from the input vector}
             \PY{n}{LHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} Note that total precipitation = PRECT + 1e\PYZhy{}3*PRECTEND in the CAM model}
             \PY{c+c1}{\PYZsh{} PRECTEND already multiplied by 1e\PYZhy{}3 in output vector so no need to redo it}
             \PY{n}{PREC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{214}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{215}\PY{p}{]}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} WATER.FINAL) Residual = E\PYZhy{}P\PYZhy{}DWATER/DT}
             \PY{n}{WATRES} \PY{o}{=} \PY{n}{LHF}\PY{o}{\PYZhy{}}\PY{n}{PREC}\PY{o}{\PYZhy{}}\PY{n}{WATINT}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.1) Calculate net energy input from phase change and precipitation}
             \PY{c+c1}{\PYZsh{} PHAS = Lf/Lv*((PRECST+PRECSTEN)\PYZhy{}(PRECT+PRECTEND))}
             \PY{n}{PHAS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                   \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{216}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{217}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                   \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{214}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{215}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                           \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                              \PY{n}{L\PYZus{}V}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.2) Calculate net energy input from radiation, sensible heat flux and turbulent KE}
             \PY{c+c1}{\PYZsh{} 2.1) RAD = FSNT\PYZhy{}FSNS\PYZhy{}FLNT+FLNS}
             \PY{n}{RAD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                     \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{210}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{211}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                     \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{213}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{212}\PY{p}{]}\PY{p}{)}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} 2.2) Unnormalize sensible heat flux}
             \PY{n}{SHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} 2.3) Net turbulent kinetic energy dissipative heating is the column\PYZhy{}integrated }
             \PY{c+c1}{\PYZsh{} turbulent kinetic energy energy dissipative heating}
             \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{180}\PY{p}{:}\PY{l+m+mi}{210}\PY{p}{]}\PY{p}{)}
             \PY{n}{KEDINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.3) Calculate tendency of normalized column water vapor due to phase change}
             \PY{c+c1}{\PYZsh{} 3.1) Column water vapor is the column integral of specific humidity}
             \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
             \PY{n}{PHQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} 3.2) Multiply by L\PYZus{}S/L\PYZus{}V to normalize (explanation above)}
             \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                          \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                             \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{L\PYZus{}V}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.4) Same operation for liquid water tendency but multiplied by L\PYZus{}F/L\PYZus{}V}
             \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PYZbs{}
                                           \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PYZbs{}
                                                  \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                  \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                           \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                              \PY{n}{L\PYZus{}V}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.5) Same operation for temperature tendency}
             \PY{n}{DTINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.FINAL) Residual = SPDQ+SPDQC+DTINT\PYZhy{}RAD\PYZhy{}SHF\PYZhy{}PHAS}
             \PY{n}{ENTRES} \PY{o}{=} \PY{n}{SPDQINT}\PY{o}{+}\PY{n}{SPDQCINT}\PY{o}{+}\PY{n}{DTINT}\PY{o}{\PYZhy{}}\PY{n}{RAD}\PY{o}{\PYZhy{}}\PY{n}{SHF}\PY{o}{\PYZhy{}}\PY{n}{PHAS}\PY{o}{\PYZhy{}}\PY{n}{KEDINT}
             
             \PY{k}{if} \PY{n}{outtype}\PY{o}{==}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{graph}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}
             
                 \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
                 \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
                 \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
                 \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{121}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{WATRES}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ Residual}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[W.m\PYZca{}}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZhy{}2\PYZcb{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
         
                 \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{122}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{ENTRES}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Enthalpy}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ Residual}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[W.m\PYZca{}}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZhy{}2\PYZcb{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             
             \PY{k}{elif} \PY{n}{outtype}\PY{o}{==}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{list}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}
             
                 \PY{k}{return} \PY{n}{WATRES}\PY{p}{,}\PY{n}{ENTRES} 
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}44}]:} \PY{n}{massent\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{yaft}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,}\PY{n}{outtype}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{graph}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_23_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{adapt-mass-enthalpy-conservation-layer-to-new-output-format}{%
\subsection{3.4) Adapt mass-enthalpy conservation layer to new output
format}\label{adapt-mass-enthalpy-conservation-layer-to-new-output-format}}

tgb - 3/20/2019 - Adapt section above once works to correct random noise

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}27}]:} \PY{k}{class} \PY{n+nc}{MulEntConsLay}\PY{p}{(}\PY{n}{Layer}\PY{p}{)}\PY{p}{:}
             
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{p}{,} \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{p}{,} \PY{n}{eps}\PY{p}{,} \PY{n}{output\PYZus{}dim}\PY{p}{,} \PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub} \PY{o}{=} \PY{n}{fsub} \PY{c+c1}{\PYZsh{} Subtraction for normalization of inputs }
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv} \PY{o}{=} \PY{n}{fdiv} \PY{c+c1}{\PYZsh{} Division for normalization of inputs}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq} \PY{o}{=} \PY{n}{normq} \PY{c+c1}{\PYZsh{} Normalization of output\PYZsq{}s water concentration}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai} \PY{o}{=} \PY{n}{hyai} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi} \PY{o}{=} \PY{n}{hybi} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{eps} \PY{o}{=} \PY{n}{eps} \PY{c+c1}{\PYZsh{} Minimal denominator when calculating a ratio}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{n}{output\PYZus{}dim} \PY{c+c1}{\PYZsh{} Dimension of output}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n+nf+fm}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{build}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{build}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{)}  \PY{c+c1}{\PYZsh{} Be sure to call this somewhere!}
             
             \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/6/2019 \PYZhy{} following https://github.com/keras\PYZhy{}team/keras/issues/4871}
             \PY{k}{def} \PY{n+nf}{get\PYZus{}config}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{n}{config} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fsub}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fdiv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{normq}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hybi}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{eps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{eps}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{output\PYZus{}dim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{\PYZcb{}}
                 \PY{n}{base\PYZus{}config} \PY{o}{=} \PY{n+nb}{super}\PY{p}{(}\PY{n}{MulEntConsLay}\PY{p}{,} \PY{n+nb+bp}{self}\PY{p}{)}\PY{o}{.}\PY{n}{get\PYZus{}config}\PY{p}{(}\PY{p}{)}
                 \PY{k}{return} \PY{n+nb}{dict}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{base\PYZus{}config}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n+nb}{list}\PY{p}{(}\PY{n}{config}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{call}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{arrs}\PY{p}{)}\PY{p}{:}        
                 \PY{c+c1}{\PYZsh{} Split between the inputs inp \PYZam{} the output of the densely connected}
                 \PY{c+c1}{\PYZsh{} neural network, sradout}
                 \PY{n}{inp}\PY{p}{,} \PY{n}{sradout} \PY{o}{=} \PY{n}{arrs}
                 
                 \PY{c+c1}{\PYZsh{} 0) Constants}
                 \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
                 \PY{n}{L\PYZus{}F} \PY{o}{=} \PY{l+m+mf}{3.337e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of fusion of water [W.kg\PYZhy{}1]}
                 \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
                 \PY{n}{L\PYZus{}S} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{L\PYZus{}F}\PY{p}{,}\PY{n}{L\PYZus{}V}\PY{p}{)}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of sublimation of water [W.kg\PYZhy{}1]}
                 \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]   }
                 
                 \PY{c+c1}{\PYZsh{} Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
                 \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
                 \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
                 \PY{n}{PS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
                 \PY{n}{P} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                             \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{)}
                 \PY{n}{dP} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
                 \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                            \PY{n}{G}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
                 \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} WATER.1) Calculate water vertical integral from level 1 to level 30}
                 \PY{n}{WATVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{sradout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,}\PYZbs{}
                                                                \PY{n}{sradout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                        \PY{n}{sradout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{WATINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{WATVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} WATER.2) Calculate forcing on the right\PYZhy{}hand side (Net Evaporation\PYZhy{}Precipitation)}
                 \PY{c+c1}{\PYZsh{} E\PYZhy{}P is already normalized to units W.m\PYZhy{}2 in the output vector}
                 \PY{c+c1}{\PYZsh{} so all we need to do is input\PYZhy{}unnormalize LHF that is taken from the input vector}
                 \PY{n}{LHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Note that total precipitation = PRECT + 1e\PYZhy{}3*PRECTEND in the CAM model}
                 \PY{c+c1}{\PYZsh{} PRECTEND already multiplied by 1e\PYZhy{}3 in output vector so no need to redo it}
                 \PY{n}{PREC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{sradout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{214}\PY{p}{]}\PY{p}{,} \PY{n}{sradout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{215}\PY{p}{]}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} WATER.FINAL) Ratio = (E\PYZhy{}P)/(DWATER/DT)}
                 \PY{n}{WATRAT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{n}{LHF}\PY{p}{,}\PY{n}{PREC}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                    \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{sign}\PY{p}{(}\PY{n}{WATINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                 \PY{n}{tfm}\PY{o}{.}\PY{n}{maximum}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{WATINT}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{eps}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                 \PY{n}{yint} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{sradout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{,}\PYZbs{}
                                                \PY{n}{tf}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{WATRAT}\PY{p}{,}\PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                   \PY{n}{sradout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.1) Calculate net energy input from phase change and precipitation}
                 \PY{c+c1}{\PYZsh{} PHAS = Lf/Lv*((PRECST+PRECSTEN)\PYZhy{}(PRECT+PRECTEND))}
                 \PY{n}{PHAS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                       \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{216}\PY{p}{]}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{217}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                       \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{214}\PY{p}{]}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{215}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                               \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                  \PY{n}{L\PYZus{}V}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.2) Calculate net energy input from radiation, sensible heat flux and turbulent KE}
                 \PY{c+c1}{\PYZsh{} 2.1) RAD = FSNT\PYZhy{}FSNS\PYZhy{}FLNT+FLNS}
                 \PY{n}{RAD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                         \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{210}\PY{p}{]}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{211}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                         \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{213}\PY{p}{]}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{212}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 2.2) Unnormalize sensible heat flux}
                 \PY{n}{SHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 2.3) Net turbulent kinetic energy dissipative heating is the column\PYZhy{}integrated }
                 \PY{c+c1}{\PYZsh{} turbulent kinetic energy energy dissipative heating}
                 \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{180}\PY{p}{:}\PY{l+m+mi}{210}\PY{p}{]}\PY{p}{)}
                 \PY{n}{KEDINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.3) Calculate tendency of normalized column water vapor due to phase change}
                 \PY{c+c1}{\PYZsh{} 3.1) Column water vapor is the column integral of specific humidity}
                 \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
                 \PY{n}{PHQINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 3.2) Multiply by L\PYZus{}S/L\PYZus{}V to normalize (explanation above)}
                 \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                                  \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                    \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                      \PY{n}{L\PYZus{}V}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.4) Same operation for liquid water tendency but multiplied by L\PYZus{}F/L\PYZus{}V}
                 \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PYZbs{}
                                                     \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(}\PYZbs{}
                                                                    \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,}\PYZbs{}
                                                                                 \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                                    \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                     \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                       \PY{n}{L\PYZus{}V}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.5) Same operation for temperature tendency}
                 \PY{n}{DTINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,}\PYZbs{}
                                                      \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                        \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.FINAL) Ratio \PYZdq{}beta\PYZdq{} given above script}
                 \PY{n}{DEN} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{DTINT}\PY{p}{,}\PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{KEDINT}\PY{p}{)}\PY{p}{)}
                 \PY{n}{ENTRAT1} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{RAD}\PY{p}{,}\PY{n}{SHF}\PY{p}{)}\PY{p}{,}\PY{n}{PHAS}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                              \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{LHF}\PY{p}{,}\PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PY{n}{L\PYZus{}V}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{sign}\PY{p}{(}\PY{n}{DEN}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                   \PY{n}{tfm}\PY{o}{.}\PY{n}{maximum}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{eps}\PY{p}{,}\PY{n}{tfm}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{DEN}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                 \PY{n}{ENTRAT2} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{PHQINT}\PY{p}{,}\PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PY{n}{L\PYZus{}V}\PY{p}{)}\PY{p}{,}\PY{n}{SPDQCINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{sign}\PY{p}{(}\PY{n}{DEN}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                   \PY{n}{tfm}\PY{o}{.}\PY{n}{maximum}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{eps}\PY{p}{,}\PY{n}{tfm}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{DEN}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                 \PY{n}{ENTRAT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{ENTRAT1}\PY{p}{,} \PY{n}{ENTRAT2}\PY{p}{)}
                 \PY{n}{out} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{,}\PYZbs{}
                                   \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{,}\PY{n}{tf}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{ENTRAT}\PY{p}{,}\PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                   \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]}\PY{p}{,}\PYZbs{}
                                   \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{180}\PY{p}{:}\PY{l+m+mi}{210}\PY{p}{]}\PY{p}{,}\PY{n}{tf}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{ENTRAT}\PY{p}{,}\PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                   \PY{n}{yint}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{210}\PY{p}{:}\PY{l+m+mi}{218}\PY{p}{]}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
                 
                 \PY{k}{return} \PY{n}{out}
             
             \PY{k}{def} \PY{n+nf}{compute\PYZus{}output\PYZus{}shape}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/7/2019 \PYZhy{} Wrap the returned output shape in Tensorshape}
                 \PY{c+c1}{\PYZsh{} to avoid problems with custom layers \PYZam{} eager execution}
                 \PY{c+c1}{\PYZsh{} https://github.com/tensorflow/tensorflow/issues/20805}
                 \PY{k}{return} \PY{n}{tf}\PY{o}{.}\PY{n}{TensorShape}\PY{p}{(}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{)}\PY{p}{)} 
\end{Verbatim}


    \hypertarget{build-neural-networks}{%
\section{4) Build neural networks}\label{build-neural-networks}}

    \hypertarget{formulate-multiplicative-conserving-model}{%
\subsection{4.1) Formulate multiplicative-conserving
model}\label{formulate-multiplicative-conserving-model}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}37}]:} \PY{c+c1}{\PYZsh{} Conserving model with 5 dense layers}
         \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
             \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{218}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{sradout} \PY{o}{=} \PY{n}{MulSurRadLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{218}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{1e\PYZhy{}2}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{218}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{MulEntConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{218}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{1e\PYZhy{}2}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{218}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{sradout}\PY{p}{]}\PY{p}{)}
         \PY{n}{CM\PYZus{}rad\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \hypertarget{compile-the-models}{%
\subsection{4.2) Compile the models}\label{compile-the-models}}

\hypertarget{use-mean-square-error-as-loss-function}{%
\subsubsection{4.2.1) Use mean square error as loss
function}\label{use-mean-square-error-as-loss-function}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}38}]:} \PY{n}{CM\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rmsprop}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mse}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


    \hypertarget{check-model-summary}{%
\subsubsection{4.2.2) Check model summary}\label{check-model-summary}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}39}]:} \PY{n}{CM\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{summary}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
Layer (type)                    Output Shape         Param \#     Connected to                     
==================================================================================================
input\_10 (InputLayer)           (None, 304)          0                                            
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_54 (Dense)                (None, 512)          156160      input\_10[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_54 (LeakyReLU)      (None, 512)          0           dense\_54[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_55 (Dense)                (None, 512)          262656      leaky\_re\_lu\_54[0][0]             
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_55 (LeakyReLU)      (None, 512)          0           dense\_55[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_56 (Dense)                (None, 512)          262656      leaky\_re\_lu\_55[0][0]             
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_56 (LeakyReLU)      (None, 512)          0           dense\_56[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_57 (Dense)                (None, 512)          262656      leaky\_re\_lu\_56[0][0]             
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_57 (LeakyReLU)      (None, 512)          0           dense\_57[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_58 (Dense)                (None, 512)          262656      leaky\_re\_lu\_57[0][0]             
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_58 (LeakyReLU)      (None, 512)          0           dense\_58[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_59 (Dense)                (None, 218)          111834      leaky\_re\_lu\_58[0][0]             
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_59 (LeakyReLU)      (None, 218)          0           dense\_59[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
mul\_sur\_rad\_lay\_8 (MulSurRadLay (None, 218)          0           input\_10[0][0]                   
                                                                 leaky\_re\_lu\_59[0][0]             
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
mul\_ent\_cons\_lay\_6 (MulEntConsL (512, 218)           0           input\_10[0][0]                   
                                                                 mul\_sur\_rad\_lay\_8[0][0]          
==================================================================================================
Total params: 1,318,618
Trainable params: 1,318,618
Non-trainable params: 0
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

    \end{Verbatim}

    \hypertarget{train-the-models}{%
\subsection{4.3) Train the models}\label{train-the-models}}

    \hypertarget{train-compiled-models}{%
\subsubsection{4.3.1) Train compiled
models}\label{train-compiled-models}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}40}]:} \PY{n}{Nep} \PY{o}{=} \PY{l+m+mi}{2}
         \PY{n}{hCM\PYZus{}rad\PYZus{}5dens} \PY{o}{=} \PY{n}{CM\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{n}{Nep}\PY{p}{,} \PYZbs{}
                              \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Epoch 1/2
18240/18240 [==============================] - 330s 18ms/step - loss: 157141.8613 - val\_loss: 47164.6214
Epoch 2/2
18240/18240 [==============================] - 301s 17ms/step - loss: 169381260.3321 - val\_loss: 1027648.6252

    \end{Verbatim}

    \hypertarget{save-models-in-.h5-format}{%
\subsubsection{4.3.2) Save models in .h5
format}\label{save-models-in-.h5-format}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}13}]:} \PY{o}{\PYZpc{}}\PY{k}{cd} \PYZdl{}TRAINDIR/HDF5\PYZus{}DATA
         \PY{o}{!}pwd
         \PY{c+c1}{\PYZsh{} CM\PYZus{}rad\PYZus{}5dens.save(\PYZsq{}CM\PYZus{}rad\PYZus{}5dens.h5\PYZsq{})}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/data/Tom.Beucler/SPCAM\_PHYS/HDF5\_DATA
/data/Tom.Beucler/SPCAM\_PHYS/HDF5\_DATA

    \end{Verbatim}

    \hypertarget{loss-and-validation-curves}{%
\subsubsection{4.3.3) Loss and validation
curves}\label{loss-and-validation-curves}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}41}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
         
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         
         \PY{k}{for} \PY{n}{index} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
             \PY{k}{if} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hCM\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bo}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{b}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{1}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hU\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{U}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{2}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hW001\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{go}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W001}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{3}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hW05\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{co}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{c}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W05}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{4}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hW099\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mo}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{m}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W099}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
                 
             
             \PY{n}{train\PYZus{}loss\PYZus{}values} \PY{o}{=} \PY{n}{hdict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{valid\PYZus{}loss\PYZus{}values} \PY{o}{=} \PY{n}{hdict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{epochs} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
         
             \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values}\PY{p}{,} \PY{n}{colo}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ Train}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values}\PY{p}{,} \PY{n}{col}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ Valid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{}plt.title(\PYZsq{}Training and validation loss\PYZsq{})}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Epochs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Loss (W/m\PYZca{}2)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{125}\PY{p}{)}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} https://stackoverflow.com/questions/4700614/how\PYZhy{}to\PYZhy{}put\PYZhy{}the\PYZhy{}legend\PYZhy{}out\PYZhy{}of\PYZhy{}the\PYZhy{}plot}
         \PY{c+c1}{\PYZsh{} for legend at the right place}
         \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper center}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{;} 
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]

        ---------------------------------------------------------------------------

        CalledProcessError                        Traceback (most recent call last)

        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/texmanager.py in \_run\_checked\_subprocess(self, command, tex)
        297                                              cwd=self.texcache,
    --> 298                                              stderr=subprocess.STDOUT)
        299         except subprocess.CalledProcessError as exc:


        \textasciitilde{}/miniconda3/lib/python3.6/subprocess.py in check\_output(timeout, *popenargs, **kwargs)
        355     return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,
    --> 356                **kwargs).stdout
        357 


        \textasciitilde{}/miniconda3/lib/python3.6/subprocess.py in run(input, timeout, check, *popenargs, **kwargs)
        437             raise CalledProcessError(retcode, process.args,
    --> 438                                      output=stdout, stderr=stderr)
        439     return CompletedProcess(process.args, retcode, stdout, stderr)


        CalledProcessError: Command '['latex', '-interaction=nonstopmode', '--halt-on-error', '/tmp/matplotlib-y89yomes/tex.cache/fb5674ba346253e626ee9dfbf1012164.tex']' returned non-zero exit status 1.

        
    During handling of the above exception, another exception occurred:


        RuntimeError                              Traceback (most recent call last)

        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/IPython/core/formatters.py in \_\_call\_\_(self, obj)
        339                 pass
        340             else:
    --> 341                 return printer(obj)
        342             \# Finally look for special method names
        343             method = get\_real\_method(obj, self.print\_method)


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/IPython/core/pylabtools.py in <lambda>(fig)
        242 
        243     if 'png' in formats:
    --> 244         png\_formatter.for\_type(Figure, lambda fig: print\_figure(fig, 'png', **kwargs))
        245     if 'retina' in formats or 'png2x' in formats:
        246         png\_formatter.for\_type(Figure, lambda fig: retina\_figure(fig, **kwargs))


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/IPython/core/pylabtools.py in print\_figure(fig, fmt, bbox\_inches, **kwargs)
        126 
        127     bytes\_io = BytesIO()
    --> 128     fig.canvas.print\_figure(bytes\_io, **kw)
        129     data = bytes\_io.getvalue()
        130     if fmt == 'svg':


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/backend\_bases.py in print\_figure(self, filename, dpi, facecolor, edgecolor, orientation, format, bbox\_inches, **kwargs)
       2047                         orientation=orientation,
       2048                         dryrun=True,
    -> 2049                         **kwargs)
       2050                     renderer = self.figure.\_cachedRenderer
       2051                     bbox\_artists = kwargs.pop("bbox\_extra\_artists", None)


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/backends/backend\_agg.py in print\_png(self, filename\_or\_obj, *args, **kwargs)
        508 
        509         """
    --> 510         FigureCanvasAgg.draw(self)
        511         renderer = self.get\_renderer()
        512 


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/backends/backend\_agg.py in draw(self)
        400         toolbar = self.toolbar
        401         try:
    --> 402             self.figure.draw(self.renderer)
        403             \# A GUI class may be need to update a window using this draw, so
        404             \# don't forget to call the superclass.


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/artist.py in draw\_wrapper(artist, renderer, *args, **kwargs)
         48                 renderer.start\_filter()
         49 
    ---> 50             return draw(artist, renderer, *args, **kwargs)
         51         finally:
         52             if artist.get\_agg\_filter() is not None:


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/figure.py in draw(self, renderer)
       1647 
       1648             mimage.\_draw\_list\_compositing\_images(
    -> 1649                 renderer, self, artists, self.suppressComposite)
       1650 
       1651             renderer.close\_group('figure')


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/image.py in \_draw\_list\_compositing\_images(renderer, parent, artists, suppress\_composite)
        136     if not\_composite or not has\_images:
        137         for a in artists:
    --> 138             a.draw(renderer)
        139     else:
        140         \# Composite any adjacent images together


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/artist.py in draw\_wrapper(artist, renderer, *args, **kwargs)
         48                 renderer.start\_filter()
         49 
    ---> 50             return draw(artist, renderer, *args, **kwargs)
         51         finally:
         52             if artist.get\_agg\_filter() is not None:


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/axes/\_base.py in draw(self, renderer, inframe)
       2626             renderer.stop\_rasterizing()
       2627 
    -> 2628         mimage.\_draw\_list\_compositing\_images(renderer, self, artists)
       2629 
       2630         renderer.close\_group('axes')


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/image.py in \_draw\_list\_compositing\_images(renderer, parent, artists, suppress\_composite)
        136     if not\_composite or not has\_images:
        137         for a in artists:
    --> 138             a.draw(renderer)
        139     else:
        140         \# Composite any adjacent images together


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/artist.py in draw\_wrapper(artist, renderer, *args, **kwargs)
         48                 renderer.start\_filter()
         49 
    ---> 50             return draw(artist, renderer, *args, **kwargs)
         51         finally:
         52             if artist.get\_agg\_filter() is not None:


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/axis.py in draw(self, renderer, *args, **kwargs)
       1197         self.\_update\_label\_position(renderer)
       1198 
    -> 1199         self.label.draw(renderer)
       1200 
       1201         self.\_update\_offset\_text\_position(ticklabelBoxes, ticklabelBoxes2)


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/artist.py in draw\_wrapper(artist, renderer, *args, **kwargs)
         48                 renderer.start\_filter()
         49 
    ---> 50             return draw(artist, renderer, *args, **kwargs)
         51         finally:
         52             if artist.get\_agg\_filter() is not None:


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/text.py in draw(self, renderer)
        707 
        708         with \_wrap\_text(self) as textobj:
    --> 709             bbox, info, descent = textobj.\_get\_layout(renderer)
        710             trans = textobj.get\_transform()
        711 


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/text.py in \_get\_layout(self, renderer)
        311                 w, h, d = renderer.get\_text\_width\_height\_descent(clean\_line,
        312                                                         self.\_fontproperties,
    --> 313                                                         ismath=ismath)
        314             else:
        315                 w, h, d = 0, 0, 0


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/backends/backend\_agg.py in get\_text\_width\_height\_descent(self, s, prop, ismath)
        207             fontsize = prop.get\_size\_in\_points()
        208             w, h, d = texmanager.get\_text\_width\_height\_descent(
    --> 209                 s, fontsize, renderer=self)
        210             return w, h, d
        211 


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/texmanager.py in get\_text\_width\_height\_descent(self, tex, fontsize, renderer)
        462         else:
        463             \# use dviread. It sometimes returns a wrong descent.
    --> 464             dvifile = self.make\_dvi(tex, fontsize)
        465             with dviread.Dvi(dvifile, 72 * dpi\_fraction) as dvi:
        466                 page = next(iter(dvi))


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/texmanager.py in make\_dvi(self, tex, fontsize)
        326                 self.\_run\_checked\_subprocess(
        327                     ["latex", "-interaction=nonstopmode", "--halt-on-error",
    --> 328                      texfile], tex)
        329             for fname in glob.glob(basefile + '*'):
        330                 if not fname.endswith(('dvi', 'tex')):


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/matplotlib/texmanager.py in \_run\_checked\_subprocess(self, command, tex)
        305                     prog=command[0],
        306                     tex=tex.encode('unicode\_escape'),
    --> 307                     exc=exc.output.decode('utf-8')))
        308         \_log.debug(report)
        309         return report


        RuntimeError: latex was not able to process the following string:
    b'Loss (W/m\^{}2)'
    
    Here is the full report generated by latex:
    This is pdfTeX, Version 3.14159265-2.6-1.40.16 (TeX Live 2015/Debian) (preloaded format=latex)
     restricted \textbackslash{}write18 enabled.
    entering extended mode
    (/tmp/matplotlib-y89yomes/tex.cache/fb5674ba346253e626ee9dfbf1012164.tex
    LaTeX2e <2016/02/01>
    Babel <3.9q> and hyphenation patterns for 10 language(s) loaded.
    (/usr/share/texlive/texmf-dist/tex/latex/base/article.cls
    Document Class: article 2014/09/29 v1.4h Standard LaTeX document class
    (/usr/share/texlive/texmf-dist/tex/latex/base/size10.clo))
    (/usr/share/texlive/texmf-dist/tex/latex/type1cm/type1cm.sty)
    (/usr/share/texlive/texmf-dist/tex/latex/base/textcomp.sty
    (/usr/share/texlive/texmf-dist/tex/latex/base/ts1enc.def))
    (/usr/share/texlive/texmf-dist/tex/latex/base/inputenc.sty
    (/usr/share/texlive/texmf-dist/tex/latex/base/utf8.def
    (/usr/share/texlive/texmf-dist/tex/latex/base/t1enc.dfu)
    (/usr/share/texlive/texmf-dist/tex/latex/base/ot1enc.dfu)
    (/usr/share/texlive/texmf-dist/tex/latex/base/omsenc.dfu)
    (/usr/share/texlive/texmf-dist/tex/latex/base/ts1enc.dfu)))
    (/usr/share/texlive/texmf-dist/tex/latex/geometry/geometry.sty
    (/usr/share/texlive/texmf-dist/tex/latex/graphics/keyval.sty)
    (/usr/share/texlive/texmf-dist/tex/generic/oberdiek/ifpdf.sty)
    (/usr/share/texlive/texmf-dist/tex/generic/oberdiek/ifvtex.sty)
    (/usr/share/texlive/texmf-dist/tex/generic/ifxetex/ifxetex.sty)
    
    Package geometry Warning: Over-specification in `h'-direction.
        `width' (5058.9pt) is ignored.
    
    
    Package geometry Warning: Over-specification in `v'-direction.
        `height' (5058.9pt) is ignored.
    
    ) (./fb5674ba346253e626ee9dfbf1012164.aux)
    (/usr/share/texlive/texmf-dist/tex/latex/base/ts1cmr.fd)
    *geometry* driver: auto-detecting
    *geometry* detected driver: dvips
    ! Missing \$ inserted.
    <inserted text> 
                    \$
    l.14 {\ldots}10.000000\}\{12.500000\}\{\textbackslash{}rmfamily Loss (W/m\^{}
                                                      2)\}
    No pages of output.
    Transcript written on fb5674ba346253e626ee9dfbf1012164.log.
    
    


    \end{Verbatim}

    
    \begin{verbatim}
<Figure size 432x288 with 1 Axes>
    \end{verbatim}

    
    \hypertarget{test-predictions-on-one-batch}{%
\subsubsection{4.3.4) Test predictions on one
batch}\label{test-predictions-on-one-batch}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}23}]:} \PY{n}{pred\PYZus{}cons} \PY{o}{=} \PY{n}{CM\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{x}\PY{p}{)}
         \PY{n}{ind\PYZus{}test} \PY{o}{=} \PY{l+m+mi}{150}\PY{p}{;}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred\PYZus{}cons}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{conserving}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{y}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}\PY{p}{;}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_41_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{check-performances-regarding-massenergy-conservation-and-mean-square-error}{%
\subsection{4.4) Check performances regarding mass/energy conservation
and mean square
error}\label{check-performances-regarding-massenergy-conservation-and-mean-square-error}}

tgb - 2/9/2019 - Adapted mass/energy conservation check to new output
vector containing 60 more variables (longwave and shortwave heating
profiles)

    \hypertarget{massenthalpy-conservation}{%
\subsubsection{4.4.1) Mass/enthalpy
conservation}\label{massenthalpy-conservation}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}28}]:} \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{validgen}\PY{p}{)}
         \PY{n}{watres}\PY{p}{,}\PY{n}{entres} \PY{o}{=} \PY{n}{massent\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{yval}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,}\PY{n}{outtype}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{list}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}\PY{p}{;}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{watres}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{entres}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
[ 6.18218541e-06 -3.62231227e-06  3.01862873e-06  1.48028206e-05
 -1.77397528e-05  5.73493472e-06 -1.84131817e-06 -3.06033769e-06
 -5.36547003e-06  3.69375047e-06  3.51215739e-07  1.84152078e-05
 -1.17641766e-06 -3.66041281e-06 -1.23043492e-06 -2.42369387e-06
 -8.51148607e-06 -1.12099237e-06 -4.62391594e-06  4.06213803e-06
 -6.16809302e-07 -8.39637752e-06  7.46351640e-06 -1.30527059e-06
  9.69236232e-06 -1.69989448e-05 -1.89040775e-06  1.36581469e-07
  1.78542662e-07 -2.18636700e-07  1.61298279e-06  1.64922257e-06
 -1.14914060e-06 -2.43718453e-06  1.43827156e-06 -9.52250539e-07
  9.27454940e-06  3.14079817e-07  3.12846890e-07  5.94551260e-06
  1.56130549e-05  6.97460714e-06 -3.61450489e-06  4.92597220e-06
 -3.25596034e-06 -3.43917307e-07  1.58050186e-06 -4.03532504e-06
  4.21205610e-06  2.09266030e-06 -3.33906607e-05 -3.18008711e-06
  6.10945129e-07  4.40447343e-06 -4.60314563e-06 -2.20304853e-05
 -3.19277251e-06 -1.02213505e-05 -9.57491244e-06 -6.87257465e-07
 -6.46314256e-07 -2.06690938e-06 -4.29534772e-08  1.03235277e-06
 -2.10875460e-06  2.92355237e-06  8.51393366e-06 -4.80949717e-06
 -9.08983742e-06 -7.84699890e-06 -5.49964864e-06  3.97741646e-06
  4.84479469e-05  5.08442995e-06 -6.56656960e-06 -1.10104936e-07
 -7.25790795e-07 -2.61507456e-07  8.06043943e-07  2.05039656e-06
  7.82919534e-06  1.44831966e-06 -1.54394723e-05  3.07616259e-06
  9.15713585e-08  4.73855917e-06 -5.18448003e-07  5.32394433e-06
  2.67399696e-06 -1.47659016e-05  4.29847233e-08  1.51879493e-05
  2.50999534e-07 -5.21811693e-06 -1.87690442e-06  1.47982705e-06
 -1.28498648e-07 -3.43241431e-05  1.28654462e-06  3.94609514e-07
 -2.75612323e-06 -1.42419891e-06  8.30378082e-06  2.24733216e-06
  1.80732366e-06  3.46497866e-06  1.53216159e-06 -2.83928643e-06
 -5.10068723e-07 -2.43800926e-05  7.78788582e-07  1.00869021e-06
 -2.87163823e-06 -2.60695327e-06  1.31487263e-06 -2.42524000e-05
  1.15471506e-07  1.77946987e-06  8.86757313e-06 -5.24881524e-06
  1.81634952e-06  2.15116759e-06  8.30595561e-06 -2.18361255e-06
 -4.26908150e-06 -2.03006957e-06 -1.57181627e-05 -1.26114334e-06
  1.38699773e-05 -1.54829465e-06 -2.23735408e-06 -8.27647675e-07
 -8.38679077e-06  3.37473116e-06  1.27669956e-06 -5.24119057e-07
 -7.44273365e-07  1.02995274e-05  2.40469293e-06 -3.29587277e-06
 -6.65668826e-06  1.00741332e-07  1.01064275e-05  3.41770981e-06
  2.52150921e-06 -1.65375976e-05 -3.59173059e-06  5.23436740e-06
  3.96703561e-06  3.42548577e-06  3.51217466e-07 -2.26720719e-06
  2.81345549e-06  2.54629003e-06 -7.51746845e-06 -6.74848413e-06
 -6.14582103e-06 -1.68810880e-06  1.25531940e-06  1.07780689e-07
  3.70701815e-05 -2.01591201e-06  3.79042397e-06  1.45218412e-06
 -3.49746705e-06 -2.46898118e-06  6.43392516e-06 -3.00734698e-06
 -1.77294861e-07 -3.39399507e-06 -1.32611972e-05 -1.67149018e-06
 -2.33378261e-07  1.01403129e-05 -2.58180140e-07  3.25522670e-06
 -1.17704573e-05  3.49644305e-06  1.36300279e-05  6.42290928e-07
  3.49655956e-06 -5.30421085e-07  4.58062152e-06 -6.63089427e-06
  3.75605489e-06  1.87136692e-06 -7.71344338e-05 -2.13179646e-07
  2.80385044e-05 -3.13958800e-06  2.91824380e-06 -2.72549773e-07
  2.62779436e-05 -9.89244043e-07 -1.05848824e-06  3.49547952e-06
 -2.73641635e-06  2.46334983e-06  1.20754580e-06 -2.26668686e-06
 -3.33771061e-06  1.14734006e-06  7.53902297e-07 -5.12358282e-06
 -1.85885519e-07 -1.31714606e-06 -5.36301261e-07  6.01888672e-07
 -9.42857889e-06  2.07332521e-06  2.58237220e-06  6.92393350e-07
  9.88139635e-06  7.25779942e-06 -1.11262015e-06 -7.61997245e-06
 -3.38968857e-06  1.00640509e-06 -6.82395394e-07 -7.36762719e-06
 -1.09048808e-06  4.44160893e-06 -1.14424554e-06  3.94502891e-06
  3.51519289e-06 -6.04743192e-07  9.91980977e-06  2.92891528e-06
  9.76075679e-06  1.97001113e-06  2.73768308e-07 -7.18336537e-08
 -7.21512241e-06 -1.60264686e-05 -1.50911052e-05  5.35742308e-06
 -2.83601900e-06 -2.88937645e-05  3.04041702e-07 -5.87773503e-06
 -1.64920070e-06  3.14546125e-06  8.92564586e-07 -3.54129909e-07
 -1.53466830e-06 -1.37444235e-06 -4.28529626e-06  3.70666563e-06
  8.58267559e-07  5.15860044e-07 -2.32548075e-07  3.10717636e-06
 -7.11313564e-06  1.95234082e-06 -6.29598325e-07 -4.09039261e-06
 -1.12793623e-05 -1.11960462e-05 -1.46321531e-06 -2.62938453e-06
  3.00103966e-06 -5.89476775e-06 -2.19871878e-05 -1.26346821e-05
 -7.58071728e-06 -1.61764355e-06  1.02533305e-06  1.65263903e-06
  1.83151844e-06 -1.95967556e-06  4.43106683e-06  9.99764225e-07
 -7.79928158e-07 -1.06907422e-06 -2.38904362e-05  1.04264744e-06
 -3.49534029e-06 -6.51141903e-07 -4.99189824e-06  7.90671288e-07
 -5.58745676e-06  8.17869100e-06  9.68172010e-06  7.68667761e-08
 -8.83535022e-06  2.97711815e-06 -1.06338723e-06  8.04641358e-06
 -5.01472423e-07  8.20054423e-07  8.05482003e-06 -1.36842497e-06
  6.25135185e-06  4.59068372e-06 -3.73896361e-06 -1.36051070e-05
  4.80340810e-06 -9.77223345e-06 -5.90130098e-06  3.37824777e-06
 -2.38525882e-06  5.95147744e-06 -1.38321060e-06  5.35303150e-06
 -4.90776240e-06  3.21274066e-05  2.10429885e-05  4.39364776e-06
  9.06122401e-05 -2.63289549e-06  5.80197600e-06  5.34497538e-06
  8.69950899e-07  8.06692306e-07 -9.93931897e-06 -3.56251277e-06
 -4.96229686e-06  1.09693890e-05 -3.24798469e-06 -1.49444207e-05
 -2.09479846e-05 -2.31493300e-06  2.13080203e-06  1.11248590e-06
  3.48670602e-06 -2.28531066e-06  5.01114899e-06  1.38861925e-06
  2.26768104e-06 -1.72162094e-05  1.85558224e-06  3.16152279e-06
 -1.78198505e-07 -2.24989794e-05 -1.63805136e-05  2.26015096e-06
 -1.25218042e-05 -1.56741076e-06  6.46177912e-06  3.71986440e-06
  1.84227937e-06  4.84233939e-05  1.98253784e-05 -3.08961754e-06
  6.41377883e-06 -1.45764984e-06  1.34256695e-06 -2.28499445e-07
 -1.60630847e-06  4.15418034e-07  9.72282373e-06  7.27768186e-06
  5.05401512e-06  1.35322894e-05  1.58434969e-06  1.54979706e-06
  1.85585813e-06 -1.77104791e-07  1.09462950e-04 -5.14131848e-07
 -1.25724203e-06 -1.81135991e-07  5.70202480e-06  6.70778206e-06
  3.86436285e-06  2.83723975e-05  2.13253574e-06  4.54636766e-06
 -2.83268764e-06 -1.84681343e-06  4.08222047e-06 -6.05840354e-06
 -4.58931235e-05 -6.57770028e-06  7.04210690e-06 -1.60006099e-06
 -1.97633753e-06 -1.48423328e-06 -5.68162673e-05 -4.34935593e-07
  1.42523625e-06 -6.71119350e-06 -7.98974558e-07 -1.85131305e-06
  2.34345379e-07  4.74584519e-06 -7.76050551e-06 -1.25758967e-06
 -1.52495852e-06  6.38198750e-06  2.19916501e-06 -2.90864976e-06
 -5.32706658e-07 -2.43886221e-06  6.68160673e-07  6.73547724e-07
 -5.31797635e-06  2.28111508e-06 -9.90062445e-06 -3.25167210e-07
 -1.03264416e-05 -5.84406422e-07 -9.95778546e-07  1.68969057e-05
 -6.21930376e-07 -1.72087790e-06 -1.22670412e-05 -3.04803009e-08
  4.39066937e-07 -6.75738477e-06  5.40666224e-06 -1.39056060e-07
 -1.35677747e-06  8.38300949e-08 -2.34131277e-06 -1.62435314e-06
  4.53892716e-07 -3.71951828e-06 -6.83297529e-07 -1.40297357e-06
 -2.23384987e-05  3.25687719e-06 -1.79546283e-05  9.99908741e-06
  5.21350506e-06 -2.06876121e-06  1.46567097e-06 -3.11902413e-06
  3.62233532e-05 -3.38000969e-06  3.83875538e-07  4.78414488e-07
 -2.37914639e-05  2.93210070e-06 -1.22650698e-06 -3.45889536e-07
  6.51047586e-07 -7.89861709e-06 -5.09892774e-06 -8.12541751e-06
  2.21380295e-06 -3.21352724e-06  7.12460997e-06  3.69241242e-06
 -1.63598593e-05 -1.88173386e-06  1.36607543e-05 -3.33420319e-06
  6.41651702e-07  1.23677135e-06  1.40971702e-07  4.08978146e-07
  3.31570909e-06  2.46653489e-06 -1.23257625e-06 -8.98080970e-06
 -6.73349877e-07 -2.79323242e-06 -4.74603716e-08 -4.58200263e-07
  4.50008714e-05  7.93021165e-05  4.96489905e-06 -1.19980393e-07
  5.77483359e-07 -8.79804412e-06  2.35427275e-06 -7.29179615e-06
  3.51451850e-06  9.80084014e-08 -1.83744281e-06 -7.32854500e-06
 -1.30678163e-06 -4.37333702e-06  8.45243448e-06 -1.11928180e-06
 -2.37802765e-06 -1.80935740e-06 -3.73862918e-06 -1.52705203e-05
 -5.21735237e-06  7.45801238e-06  2.46369203e-06  8.74950450e-06
 -2.21194125e-05 -7.04502867e-07  1.03469004e-05  1.20564619e-06
 -1.09858549e-05 -7.48414466e-07 -4.30772022e-06  4.32854434e-06
 -1.10133104e-06  1.39692391e-06 -4.27876919e-06 -4.49785634e-06
  2.25650269e-05  1.54696671e-06 -2.05382530e-06 -1.57516147e-06
  1.68169903e-05 -3.76013755e-06  2.38437385e-06 -1.06944039e-05
 -1.41419993e-06 -1.08613816e-05 -8.03234383e-06 -3.76903996e-06
 -1.63136436e-06 -1.77832672e-06  3.79294263e-07  1.81854646e-06]
[ 1.33606184e-06  7.48023453e-06 -8.81609129e-06 -3.12311351e-06
 -3.22617686e-06 -1.13420275e-05 -1.41125886e-05  1.65076189e-05
 -1.53318128e-05  2.37985358e-07  1.21440374e-05 -6.36614677e-06
 -1.59798169e-05 -2.33548063e-05 -8.62773408e-06 -1.28768773e-05
 -1.60342141e-05 -1.93315769e-05 -1.25884590e-05 -1.16523892e-05
 -1.78669384e-05 -4.69812141e-06  7.11536966e-06 -5.51913012e-06
 -1.34751928e-05 -2.26877445e-05 -5.93541061e-07 -1.29189320e-06
 -3.05804188e-06 -1.31596908e-05  9.71593345e-06 -3.33957935e-06
  1.69768796e-05  8.36857869e-06 -1.66326793e-05 -8.58909648e-06
  9.50526766e-06  1.61136968e-05 -8.94654692e-06  8.45472236e-06
 -1.96292032e-05 -5.72434264e-06 -3.14121365e-06 -9.25515681e-06
 -5.89512910e-06 -2.10543790e-05 -5.31573905e-06  8.86980843e-06
 -7.97296899e-06 -2.35156180e-05  1.15497347e-05  7.40086469e-06
  2.11176561e-07  1.97103831e-05  2.02608989e-05 -1.94916372e-06
  1.14003983e-06 -8.26610286e-06  4.63844842e-05 -8.33125900e-06
  2.46693592e-08  1.92669341e-05  1.03597787e-05  1.69021584e-05
 -1.81328470e-05  6.62901037e-06 -2.44044446e-05  3.86660643e-06
  7.39905995e-06  6.68369113e-07 -1.43912405e-05  3.62135750e-06
  3.61231534e-05  1.75307473e-06 -5.74404029e-06 -8.01277152e-06
  2.70379665e-06 -6.14621254e-06 -1.21466584e-05 -3.34223356e-05
  4.85745657e-05 -7.65793511e-06 -5.52201191e-06 -7.04573826e-06
 -1.57098248e-05  1.35143002e-06 -1.63470970e-05  5.37847296e-06
 -2.24397958e-05  1.90522224e-05 -9.82232293e-06  1.44873742e-05
 -6.11347870e-06 -1.08698685e-05  3.59522129e-06 -6.68566424e-05
  1.58664186e-05  3.25406421e-05 -1.69305831e-05 -5.32883297e-06
 -2.04077741e-05  2.93185007e-06  2.31041358e-06 -3.37498404e-06
 -8.76693410e-06 -8.25972824e-06  3.17840200e-07  9.95218919e-06
 -9.96622812e-06  1.54261561e-05  3.62648375e-05 -3.30391482e-06
  1.43315561e-05 -3.70605634e-05  2.57223703e-05  1.67440391e-05
 -2.11997326e-05  1.87498372e-06 -8.47795856e-06 -3.40147149e-06
  3.80254363e-06  1.65016843e-05  6.14667545e-06 -7.83631675e-05
  2.72975588e-05  1.00263727e-05  9.77902687e-06  2.45018598e-05
  8.99280499e-06 -9.33418795e-06 -1.13170492e-05 -4.93768697e-06
 -8.97309018e-06  2.06842487e-05 -1.81628273e-05 -2.18921816e-05
  3.69472820e-06  3.50073619e-06  1.94049046e-05 -5.61742005e-06
 -1.19458859e-05  1.03768832e-05 -8.01254690e-06 -1.43417657e-05
  1.34791607e-05 -1.42576913e-05  6.90745155e-06  5.09295968e-05
  1.75131170e-05 -5.68308686e-06  2.12636854e-05 -8.53630964e-06
 -9.44357951e-06 -2.14242132e-06  3.10142808e-06  1.16354721e-05
 -1.86907605e-05 -8.77249127e-06  4.17898424e-06 -1.39431237e-05
 -2.20801878e-05  7.11318020e-07  3.67923920e-06 -1.24227492e-05
 -4.84492744e-06  9.76579982e-06  1.34810289e-06  2.10946230e-05
 -7.36800969e-06 -1.16382636e-05 -1.11636864e-05 -1.57224003e-05
  4.79837840e-07  1.26244126e-05 -4.18120157e-06 -7.15615251e-06
 -6.80746570e-06 -2.23217219e-05 -2.66050516e-05  9.65864107e-06
 -1.37320859e-05  4.39087979e-06 -4.20266936e-05 -2.63533716e-05
 -2.33161779e-05  3.06772073e-05  4.77026794e-05 -1.71351297e-05
  4.46059478e-05  4.70783965e-06 -7.66540706e-06 -3.04815385e-07
 -1.05236830e-05 -1.12281512e-05 -1.52531677e-05  1.63412530e-06
  1.77667225e-05 -1.09668406e-05 -5.87961420e-06  3.66909638e-06
  3.59741964e-05  3.45648365e-06  5.61877704e-06 -3.20515455e-05
  2.23872821e-05 -2.94790167e-06 -1.98388822e-05 -1.50802017e-05
 -7.56154248e-06  3.04526761e-05 -1.30082295e-06  1.11649034e-05
 -1.82525710e-05  1.86900400e-05  5.78275085e-06  4.40832803e-06
 -1.39694819e-06 -1.42185083e-05  2.24656120e-06 -2.65601920e-05
 -1.06644876e-05 -1.22795411e-05  8.07127409e-06 -2.11437424e-05
 -2.42984797e-06  9.87351590e-07 -2.07395193e-05  1.54768236e-05
 -1.44063975e-05  5.50436913e-06  3.58110247e-06 -1.32983787e-06
 -1.26705527e-05  1.30305701e-05  2.68542742e-05  1.02027011e-05
  1.13526697e-05  2.64430261e-05 -1.78223205e-05 -5.32217005e-06
  5.41097696e-07 -9.95405827e-06  1.26768761e-05  2.12966086e-06
  5.46226255e-06  2.14920405e-05 -2.15369074e-05 -2.33068264e-05
  1.17513442e-05  2.39770770e-05 -1.08167028e-05 -2.49026796e-05
 -7.20638565e-07 -7.77382828e-06 -1.40594338e-05  9.30042988e-06
  2.74272862e-05 -1.94238816e-05 -5.92910567e-06 -1.60783979e-05
 -5.23539657e-06 -7.48072730e-06 -1.28413607e-05  8.28140602e-06
 -4.58998412e-06 -2.06848381e-05 -2.04405574e-06  1.18614419e-05
  8.18831895e-07 -3.84177544e-07 -1.25556312e-05 -2.67289340e-06
  4.50626210e-05  3.66242624e-06  2.61187085e-05 -2.90615028e-05
 -2.64500615e-05 -2.03148518e-05  3.81037900e-06  5.85657797e-07
  3.48564295e-05  2.49913876e-05 -1.27098738e-05 -7.94237364e-06
 -1.55397250e-05 -1.42851243e-05 -8.96381953e-06  2.61341062e-05
  5.10880217e-05 -3.29971878e-05  7.91957095e-08 -1.77596587e-05
 -3.90186533e-06 -1.04477796e-06 -1.05584349e-05  6.38117886e-05
 -1.38354127e-05 -2.67164648e-06 -6.19460158e-06 -9.43981286e-06
 -8.94322138e-06  1.46691420e-06 -4.24496547e-06 -1.54636355e-05
 -3.12698250e-06  3.55379924e-05 -7.86169620e-06 -4.87259113e-06
 -5.34883016e-06  6.46735047e-06  6.53584297e-06 -1.59688526e-05
  1.18940424e-05  6.21657813e-07 -9.61217628e-06  8.61071939e-06
  7.80729495e-06  1.56022273e-05 -2.12140660e-05 -1.55818499e-05
 -3.69097687e-06 -1.32415517e-05 -1.01644670e-06  6.96341454e-06
  1.38190852e-07  1.96685151e-05 -1.32439866e-05  4.03118524e-05
 -5.08514348e-06  5.73317104e-06 -1.26253090e-05 -4.64843014e-06
 -3.54311515e-06  2.61865528e-05  2.23407963e-05  5.18443594e-06
  2.57171680e-06 -1.15776045e-05 -1.16287895e-05 -5.67639426e-06
 -1.09477383e-05  4.22333953e-06  2.60296164e-06 -4.03766094e-06
 -1.03203146e-05 -4.90064372e-06  4.67807356e-05  3.31250212e-06
 -6.78751938e-06 -1.52471145e-05 -5.98353650e-06 -1.09442222e-06
  6.75029236e-06  8.06867018e-06 -1.02678092e-05  1.84820081e-05
 -1.58804594e-05 -4.47780604e-06  4.09510105e-05  1.73425502e-05
 -6.14098168e-06 -1.00618474e-05  1.62049148e-05  1.60460397e-05
 -5.54010707e-06  1.61314034e-05  6.05070360e-06 -1.03649336e-05
  4.55980832e-05 -1.24073792e-05  2.49303736e-06  1.39133734e-05
  5.15240691e-05 -7.65434658e-06 -1.59723520e-05 -5.30147572e-06
  2.69285018e-05  1.81054592e-05  1.49413420e-04  5.72463955e-06
  1.74797204e-05  4.01051605e-06 -6.00791262e-07  3.72101846e-05
  1.31684726e-05 -6.72253274e-06 -2.75110993e-06 -1.52452535e-05
  5.35120255e-06  2.40927767e-07 -4.71422178e-06  4.18879534e-06
  6.41491331e-06 -6.23489791e-06 -1.27032714e-05  1.43786134e-05
  3.87525772e-05 -2.87734395e-06 -1.81456954e-05  2.11917447e-05
  2.89906298e-06  7.52546787e-06 -3.36987438e-06 -1.76253369e-05
  1.05316680e-05 -5.63676805e-06  2.24946320e-05 -1.35184305e-06
 -1.27941519e-05  1.63517531e-06 -1.99505035e-06  4.38577580e-06
 -2.16755063e-06 -1.25449960e-05 -7.80435164e-06  2.87845455e-06
  2.79438345e-06  1.09925673e-05 -2.99575312e-06  7.97130730e-06
  1.08650681e-05  2.77022413e-06 -1.70180055e-05 -1.58148608e-05
 -2.14885452e-05 -1.52604127e-05  2.68182493e-06 -8.54111255e-06
  5.55527240e-05  1.09391254e-05  2.94656980e-06  5.32993269e-06
  5.22948831e-06  4.94771164e-07 -5.29042065e-06  7.43647551e-06
 -9.36951535e-06 -8.00854624e-07 -5.07988334e-06 -1.17526870e-05
  1.64785874e-05  6.23320017e-06 -1.32725728e-05 -1.76188341e-06
  5.89548195e-06 -2.60104398e-06 -1.19351697e-05  9.81815196e-06
 -4.75686297e-06  1.48932169e-05  2.38846459e-05 -2.69663871e-07
 -2.15072886e-05 -3.45743191e-06  1.11988142e-05 -3.66101128e-06
 -9.49672611e-06  4.25651543e-06 -2.57845856e-05 -1.15809948e-05
 -5.05804372e-06  8.35552503e-06 -1.04723581e-05  2.70164880e-05
 -2.71725608e-05 -1.36667602e-06 -1.19740751e-05  1.40323761e-05
 -1.38369240e-05  3.17378240e-06  5.47111698e-06 -1.23163441e-06
 -2.12856096e-06  4.81511186e-06  1.16253722e-05 -1.55342166e-05
  4.80648734e-06 -6.29425067e-07 -9.28017834e-06  6.78755162e-05
 -8.18053118e-06 -8.93996566e-06  1.23916771e-05 -2.80466742e-06
  2.36848887e-05 -6.44761804e-06 -5.19737251e-06 -2.08600717e-06
  1.91156258e-05  1.02710892e-05  8.79297525e-06 -3.01118279e-05
 -1.61166978e-05  8.50222510e-07  9.40193927e-06 -1.06500822e-05
  1.67075990e-05 -8.50709915e-06 -5.75887222e-06  3.33776901e-08
  7.74265973e-06 -9.84786589e-06  1.89127338e-05 -9.14159784e-06
 -4.88085349e-06 -2.40476631e-05 -1.00480406e-05  7.12115656e-06
 -1.44142782e-05  1.67390882e-06  3.83976529e-06  2.73157048e-05]

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}14}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
         \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{,} \PY{l+m+mf}{13.5}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{XMAX} \PY{o}{=} \PY{l+m+mi}{100}\PY{p}{;} \PY{n}{bins} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{XMAX}\PY{p}{,} \PY{n}{XMAX}\PY{p}{,} \PY{l+m+mi}{100}\PY{p}{)}
         
         \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)}
         
         \PY{k}{for} \PY{n}{index} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
             \PY{k}{if} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{1}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{CM\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{CM}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{C\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{2}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{W001\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W001}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{3}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{W05\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W05}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{4}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{W099\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W099}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
         
             \PY{n}{watres}\PY{p}{,}\PY{n}{entres} \PY{o}{=} \PY{n}{massent\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{pred}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,}\PY{n}{outtype}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{list}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}\PY{p}{;}
         
             \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{index}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{watres}\PY{p}{,} \PY{n}{bins}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label} \PY{o}{=} \PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ mSQ}\PY{l+s+si}{\PYZpc{}i}\PY{l+s+s1}{\PYZsq{}} \PY{o}{\PYZpc{}}\PY{k}{np}.mean(watres**2)+\PYZsq{} stdSQ\PYZpc{}i\PYZsq{} \PYZpc{}np.std(watres**2))
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Nb samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{50}\PY{p}{)}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{XMAX}\PY{p}{,} \PY{n}{XMAX}\PY{p}{)}\PY{p}{)}\PY{p}{;}
             \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper left}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fontsize} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{)}\PY{p}{;}
             
             \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{index}\PY{o}{+}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{entres}\PY{p}{,} \PY{n}{bins}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label} \PY{o}{=} \PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ mSQ}\PY{l+s+si}{\PYZpc{}i}\PY{l+s+s1}{\PYZsq{}} \PY{o}{\PYZpc{}}\PY{k}{np}.mean(entres**2)+\PYZsq{} stdSQ\PYZpc{}i\PYZsq{} \PYZpc{}np.std(entres**2))
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Nb samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{50}\PY{p}{)}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{XMAX}\PY{p}{,} \PY{n}{XMAX}\PY{p}{)}\PY{p}{)}\PY{p}{;}
             \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper left}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fontsize} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{)}\PY{p}{;} 
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_45_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{mean-square-error}{%
\subsubsection{4.4.2) Mean square error}\label{mean-square-error}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}16}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
         \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{,} \PY{l+m+mf}{13.5}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{XMAX} \PY{o}{=} \PY{l+m+mi}{180}\PY{p}{;} \PY{n}{bins} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{XMAX}\PY{p}{,} \PY{l+m+mi}{100}\PY{p}{)}
         
         \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)}
         
         \PY{k}{for} \PY{n}{index} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
             \PY{k}{if} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{CM\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{CM}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{1}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{C\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{2}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{W001\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W001}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{3}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{W05\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W05}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{4}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{W099\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W099}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
         
             \PY{n}{res} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{p}{(}\PY{n}{pred}\PY{o}{\PYZhy{}}\PY{n}{yval}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{;}
             
             \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{index}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{res}\PY{p}{,} \PY{n}{bins}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label} \PY{o}{=} \PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ m}\PY{l+s+si}{\PYZpc{}i}\PY{l+s+s1}{\PYZsq{}} \PY{o}{\PYZpc{}}\PY{k}{np}.mean(res)+\PYZsq{} std\PYZpc{}i\PYZsq{} \PYZpc{}np.std(res))
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Nb samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{)}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{XMAX}\PY{p}{)}\PY{p}{)}\PY{p}{;}
             \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper center}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fontsize} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{)}\PY{p}{;} 
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_47_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{check-radiative-integrals}{%
\subsubsection{4.4.3) Check radiative
integrals}\label{check-radiative-integrals}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}29}]:} \PY{k}{def} \PY{n+nf}{radint\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{)}\PY{p}{:}
             \PY{k+kn}{import} \PY{n+nn}{copy}
             \PY{n}{inp} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{x}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} 0) Constants}
             \PY{n}{C\PYZus{}P} \PY{o}{=} \PY{l+m+mf}{1.00464e3} \PY{c+c1}{\PYZsh{} Specific heat capacity of air at constant pressure}
             \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
             \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
         
             \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
             \PY{n}{PS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
             \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                         \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
             \PY{n}{dP} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
             \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                                  \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                        \PY{n}{G}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
             \PY{c+c1}{\PYZsh{} Wondering about broadcasting here...}
             \PY{c+c1}{\PYZsh{} tf.div or simply \PYZbs{} would support broadcasting }
             \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} 2) Radiative integrals}
             \PY{n}{SWVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{150}\PY{p}{:}\PY{l+m+mi}{180}\PY{p}{]}\PY{p}{)}
             \PY{n}{SWINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{SWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{SWNET} \PY{o}{=} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{210}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{211}\PY{p}{]} \PY{c+c1}{\PYZsh{} FSNT\PYZhy{}FSNS}
         
             \PY{n}{LWVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
             \PY{n}{LWINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{LWVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{} LW integral}
             \PY{n}{LWNET} \PY{o}{=} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{213}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{212}\PY{p}{]} \PY{c+c1}{\PYZsh{} FLNS\PYZhy{}FLNT}
         
             \PY{k}{return} \PY{p}{(}\PY{n}{SWINT}\PY{o}{\PYZhy{}}\PY{n}{SWNET}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{LWINT}\PY{o}{\PYZhy{}}\PY{n}{LWNET}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}31}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
         \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{,} \PY{l+m+mf}{13.5}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{XMAX} \PY{o}{=} \PY{l+m+mi}{100}\PY{p}{;} \PY{n}{bins} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{XMAX}\PY{p}{,} \PY{n}{XMAX}\PY{p}{,} \PY{l+m+mi}{100}\PY{p}{)}
         
         \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)}
         
         \PY{k}{for} \PY{n}{index} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
             \PY{k}{if} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{1}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{CM\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{CM}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{C\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{2}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{W001\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W001}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{3}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{W05\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W05}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{4}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{W099\PYZus{}rad\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W099}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
         
             \PY{n}{swres}\PY{p}{,}\PY{n}{lwres} \PY{o}{=} \PY{n}{radint\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{pred}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{)}
         
             \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{index}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{swres}\PY{p}{,} \PY{n}{bins}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label} \PY{o}{=} \PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ mSQ}\PY{l+s+si}{\PYZpc{}i}\PY{l+s+s1}{\PYZsq{}} \PY{o}{\PYZpc{}}\PY{k}{np}.mean(swres**2)+\PYZsq{} stdSQ\PYZpc{}i\PYZsq{} \PYZpc{}np.std(swres**2))
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Nb samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{50}\PY{p}{)}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{XMAX}\PY{p}{,} \PY{n}{XMAX}\PY{p}{)}\PY{p}{)}\PY{p}{;}
             \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper left}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fontsize} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{)}\PY{p}{;}
             
             \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{index}\PY{o}{+}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{lwres}\PY{p}{,} \PY{n}{bins}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label} \PY{o}{=} \PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ mSQ}\PY{l+s+si}{\PYZpc{}i}\PY{l+s+s1}{\PYZsq{}} \PY{o}{\PYZpc{}}\PY{k}{np}.mean(lwres**2)+\PYZsq{} stdSQ\PYZpc{}i\PYZsq{} \PYZpc{}np.std(lwres**2))
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Nb samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{50}\PY{p}{)}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{XMAX}\PY{p}{,} \PY{n}{XMAX}\PY{p}{)}\PY{p}{)}\PY{p}{;}
             \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper left}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fontsize} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{)}\PY{p}{;} 
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_50_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{step-6-check-positivity-of-water-species}{%
\paragraph{Step 6: Check positivity of water
species}\label{step-6-check-positivity-of-water-species}}

There are two necessary steps:\\
1) Load the water species concentrations ``before physics'' from the
input vector and unnormalize them\\
2) Invert the output normalization to get the water concentrations
``after physics''

\[
\delta q_{v,i,l}\left(p\right)=\frac{L_{v}\Delta p_{\mathrm{norm}}}{g}\frac{q_{v,i,l}^{a}\left(p\right)-q_{v,i,l}^{b}\left(p\right)}{\Delta t}\ \Rightarrow\ q_{v,i,l}^{a}\left(p\right)=q_{v,i,l}^{b}\left(p\right)+\frac{g\Delta t}{L_{v}\Delta p_{\mathrm{norm}}}\delta q_{v,i,l}\left(p\right)
\]

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}145}]:} \PY{k}{def} \PY{n+nf}{watpos\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{dt}\PY{o}{=}\PY{l+m+mi}{30}\PY{o}{*}\PY{l+m+mi}{60}\PY{p}{)}\PY{p}{:}
              
              \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
          
              \PY{c+c1}{\PYZsh{} 1) Extract water species concentrations from inputs}
              \PY{n}{QVB} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{QLB} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}
              \PY{n}{QSB} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}
          
              \PY{c+c1}{\PYZsh{} 2) Inverse output normalization and get water concentration after physics}
              \PY{n}{QVA} \PY{o}{=} \PY{n}{QVB} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dt}\PY{o}{*}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]} \PY{p}{,} \PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{QLA} \PY{o}{=} \PY{n}{QLB} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dt}\PY{o}{*}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]} \PY{p}{,} \PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{QSA} \PY{o}{=} \PY{n}{QSB} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dt}\PY{o}{*}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]} \PY{p}{,} \PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
          
              \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
              \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
              \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{231}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{n}{QVA}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ vapor}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ concentration}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{232}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{n}{QLA}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Liquid}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ concentration}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{233}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{n}{QSA}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Ice}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ concentration}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
              
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{234}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{p}{(}\PY{n}{QVA}\PY{o}{\PYZhy{}}\PY{n}{QVB}\PY{p}{)}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ vapor}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ change}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{235}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{p}{(}\PY{n}{QLA}\PY{o}{\PYZhy{}}\PY{n}{QLB}\PY{p}{)}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Liquid}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ change}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{236}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{p}{(}\PY{n}{QSA}\PY{o}{\PYZhy{}}\PY{n}{QSB}\PY{p}{)}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Ice}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ change}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
              
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplots\PYZus{}adjust}\PY{p}{(}\PY{n}{left}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{bottom}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{wspace}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{hspace}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}146}]:} \PY{n}{watpos\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{yval}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{dt}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_53_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    

    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
