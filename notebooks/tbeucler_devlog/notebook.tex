
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatability definitions
    \def\gt{>}
    \def\lt{<}
    % Document parameters
    \title{001\_Basic-Keras-class-for-physical-constraints}
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \hypertarget{preprocess-all-the-necessary-variables}{%
\subsection{1) Preprocess all the necessary
variables}\label{preprocess-all-the-necessary-variables}}

\hypertarget{build-feature-target-and-initial-normalization-files}{%
\subsubsection{1.1) Build feature, target and initial normalization
files}\label{build-feature-target-and-initial-normalization-files}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}1}]:} \PY{c+ch}{\PYZsh{}!ln \PYZhy{}s /filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/cbrain \PYZbs{}}
        \PY{c+c1}{\PYZsh{}/filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/notebooks/tbeucler\PYZus{}devlog/cbrain}
        \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{imports} \PY{k}{import} \PY{o}{*}
        \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{data\PYZus{}generator} \PY{k}{import} \PY{o}{*}
        \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{utils} \PY{k}{import} \PY{n}{limit\PYZus{}mem}
        \PY{k+kn}{import} \PY{n+nn}{tensorflow} \PY{k}{as} \PY{n+nn}{tf}
        \PY{k+kn}{import} \PY{n+nn}{tensorflow}\PY{n+nn}{.}\PY{n+nn}{math} \PY{k}{as} \PY{n+nn}{tfm}
        \PY{c+c1}{\PYZsh{} Otherwise tensorflow will use ALL your GPU RAM for no reason}
        \PY{n}{limit\PYZus{}mem}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Using TensorFlow backend.
/home/t/Tom.Beucler/miniconda3/lib/python3.6/importlib/\_bootstrap.py:219: RuntimeWarning: compiletime version 3.5 of module 'tensorflow.python.framework.fast\_tensor\_util' does not match runtime version 3.6
  return f(*args, **kwds)

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{o}{\PYZpc{}}\PY{k}{cd} /filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM
        \PY{n}{TRAINDIR} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/local/Tom.Beucler/SPCAM\PYZus{}PHYS/}\PY{l+s+s1}{\PYZsq{}}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/filer/z-sv-pool12c/t/Tom.Beucler/SPCAM/CBRAIN-CAM

    \end{Verbatim}

    tgb - 1/22/2019 - I get very confused by all the types of precip so
there are some tests below.\\
https://gitlab.com/mspritch/spcam3.0-neural-net/blob/master/models/atm/cam/src/physics/cam1/tphysbc\_internallythreaded.F90\\
look for wtricesink and icesink

The different types of precipitation are:\\
PRECC,PRECL,PRECSC,PRECSL,PRECSTEN,PRECT,PRECTEND.\\
PRECC: Convective precipitation rate (m/s)\\
PRECL: Large-scale precipitation rate (m/s)\\
PRECSC: Convective snow rate - water equivalent (m/s)\\
PRECSL: Large-scale snow rate - water equivalent (m/s)\\
PRECSTEN: Large-scale snow rate - water equivalent (m/s)\\
PRECT: Total precipitation rate (m/s)\\
PRECTEND: Large-scale snow rate - water equivalent (m/s)

So there seems to be problematic flags regarding the snow rate.

The relation for the liquid precipitation rate is:\\
PRECT = PRECC + PRECL\\
Total precip = Convective precip + Large-scale precip

There doesn't seem to be an obvious relation for the snow rate.

According to the mass/water conservation, the condensation sink at the
surface is: PRECT {[}liquid{]} + 1e-3 * PRECTEND {[}??snow converted to
liquid equivalent??{]}\\
and that is balanced by the latent heat flux, proportional to the
evaporation source.

But apparently there's another component of the snow rate that is
important for energy conservation but doesn't enter the water
conservation equation. If I naively follow:\\
https://github.com/raspstephan/CBRAIN-CAM/blob/master/notebooks/dev/old\_notebooks/energy\_conservation.ipynb\\
that precipitation term is a source rather than a sink for the energy:\\
+L\_F\emph{( PRECSC + PRECSL + 1e-3 } PRECSTEN )\\
Maybe it describes the liq-\textgreater{}snow conversion in the column?
Unsure\ldots{} By analogy to the ??liquid precip??, we define:\\
PRECST = PRECSC + PRECSL\\
and also predict PRECSTEN.

tgb - 1/22/2019 - Let's predict these two more quantities and see if we
can conserve FMSE :)

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{n}{DATADIR} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/project/meteo/w2w/A6/S.Rasp/SP\PYZhy{}CAM/sp32fbp\PYZus{}andkua/}\PY{l+s+s1}{\PYZsq{}}
        \PY{k+kn}{import} \PY{n+nn}{xarray} \PY{k}{as} \PY{n+nn}{xr}
        \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{n}{ds} \PY{o}{=} \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{DATADIR} \PY{o}{+} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{AndKua\PYZus{}aqua\PYZus{}SPCAM3.0\PYZus{}sp\PYZus{}fbp32.cam2.h1.0000\PYZhy{}01\PYZhy{}01\PYZhy{}00000.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} 
                             \PY{n}{decode\PYZus{}times}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} The large\PYZhy{}scale snow rate equivalent needs to be multiplied by 1e\PYZhy{}3 for water conservation}
        \PY{c+c1}{\PYZsh{}print(ds.PRECC)}
        \PY{c+c1}{\PYZsh{}print(ds.PRECL)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{DTVKE}\PY{o}{.}\PY{n}{attrs}\PY{p}{,}\PY{n}{ds}\PY{o}{.}\PY{n}{DTVKE}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{1800}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{sum=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{DTVKE}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{1800}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{TPHYSTND}\PY{o}{.}\PY{n}{attrs}\PY{p}{,}\PY{n}{ds}\PY{o}{.}\PY{n}{TPHYSTND}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{sum=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{TPHYSTND}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{PRECSC}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{PRECSL}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{PRECSC}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{o}{+}\PY{n}{ds}\PY{o}{.}\PY{n}{PRECSL}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{PRECSTEN}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{PRECTEND}\PY{o}{.}\PY{n}{attrs}\PY{p}{,}\PY{n}{ds}\PY{o}{.}\PY{n}{PRECTEND}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{dim}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
OrderedDict([('units', 'K/s'), ('long\_name', 'dT/dt vertical diffusion KE dissipation'), ('cell\_method', 'time: mean')]) <xarray.DataArray 'DTVKE' (lev: 30)>
array([6.190228e-11, 7.607866e-11, 6.988708e-11, 7.102008e-11, 8.425537e-11,
       1.770534e-10, 6.262000e-10, 5.441891e-09, 1.147568e-08, 1.310354e-08,
       1.299817e-08, 9.034349e-09, 4.209920e-09, 3.817676e-09, 3.808339e-09,
       2.463906e-09, 1.168622e-09, 4.617561e-10, 2.209182e-10, 1.410370e-10,
       1.227459e-10, 2.885002e-10, 2.581773e-09, 1.329442e-08, 3.226186e-08,
       6.681960e-08, 1.263978e-07, 2.324936e-07, 4.423991e-07, 1.105985e-05],
      dtype=float32)
Coordinates:
  * lev      (lev) float64 3.643 7.595 14.36 24.61 {\ldots} 936.2 957.5 976.3 992.6 sum= <xarray.DataArray 'DTVKE' ()>
array(1.204602e-05, dtype=float32)
OrderedDict([('units', 'K/s'), ('long\_name', 'T physics tendency'), ('cell\_method', 'time: mean')]) <xarray.DataArray 'TPHYSTND' (lev: 30)>
array([ 7.867698e-07, -7.975862e-07, -5.422063e-06,  1.249287e-05,
       -1.617808e-06, -1.160911e-07, -7.232267e-07, -5.619410e-07,
        2.782731e-07, -3.554236e-07, -9.760744e-07, -2.147032e-06,
       -2.635271e-06, -3.087351e-06, -3.616228e-06, -4.214406e-06,
       -4.245832e-06, -3.104280e-06, -8.202992e-07,  1.217512e-06,
        1.152844e-06, -3.406510e-07, -5.682986e-07,  4.011925e-06,
        5.285697e-06,  6.865961e-06,  7.266987e-06,  6.980339e-06,
        5.580496e-06,  2.152684e-06], dtype=float32)
Coordinates:
  * lev      (lev) float64 3.643 7.595 14.36 24.61 {\ldots} 936.2 957.5 976.3 992.6 sum= <xarray.DataArray 'TPHYSTND' ()>
array(1.87225e-05, dtype=float32)
<xarray.DataArray 'PRECSC' ()>
array(3.631796e-09, dtype=float32)
<xarray.DataArray 'PRECSL' ()>
array(2.199336e-09, dtype=float32)
<xarray.DataArray ()>
array(5.831132e-09, dtype=float32)
<xarray.DataArray 'PRECSTEN' ()>
array(4.206476e-07, dtype=float32)
OrderedDict([('units', 'm/s'), ('long\_name', 'Large-scale (stable) snow rate (water equivalent)'), ('cell\_method', 'time: mean')]) <xarray.DataArray 'PRECTEND' ()>
array(4.809106e-07, dtype=float32)

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{o}{!}python cbrain/Test01\PYZus{}preprocess\PYZus{}aqua.py \PY{err}{\PYZbs{}}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{config} \PY{n}{pp\PYZus{}config}\PY{o}{/}\PY{l+m+mi}{32}\PY{n}{col\PYZus{}mp\PYZus{}ref\PYZus{}tbeucler\PYZus{}local}\PY{o}{.}\PY{n}{yml} \PYZbs{}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{aqua\PYZus{}names} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{*.h1.0000\PYZhy{}*\PYZhy{}01\PYZhy{}*}\PY{l+s+s1}{\PYZsq{}} \PYZbs{}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{out\PYZus{}pref} \PY{l+m+mi}{32}\PY{n}{\PYZus{}col\PYZus{}mp\PYZus{}1m\PYZus{}train}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
GitPython not found. Please install for better reproducibility.
Time checkpoint reading data: 12.45 s
Number of time steps: 576
Cut time steps: [ 47  95 143 191 239 287 335 383 431 479 527]
Cut time steps: [ 47  95 143 191 239 287 335 383 431 479 527]
Time checkpoint create datasets: 12.55 s
Time checkpoint reshape and rechunk: 16.72 s
Compute means and stds
Saving normalization file: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_mp\_1m\_train\_norm.nc
Time checkpoint normalization arrays: 142.94 s
Time checkpoint rechunk and ds: 143.71 s
Save features: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_mp\_1m\_train\_features.nc
Save targets: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_mp\_1m\_train\_targets.nc
Total time: 192.09 s

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}123}]:} \PY{o}{!}ls \PY{n+nv}{\PYZdl{}TRAINDIR}
          \PY{o}{\PYZpc{}}\PY{k}{cd} \PYZdl{}TRAINDIR
          \PY{o}{!}pwd
          \PY{c+c1}{\PYZsh{}!rm 32\PYZus{}col*}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/data/Tom.Beucler/SPCAM\_PHYS
/data/Tom.Beucler/SPCAM\_PHYS
rm: cannot remove '32\_col*': No such file or directory

    \end{Verbatim}

    \hypertarget{create-validation-dataset}{%
\subsubsection{1.2) Create validation
dataset}\label{create-validation-dataset}}

tgb - 1/23/2019 - Adapted from Stephan's entire workflow for 32 column
run

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{o}{!}python cbrain/Test01\PYZus{}preprocess\PYZus{}aqua.py \PY{err}{\PYZbs{}}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{config} \PY{n}{pp\PYZus{}config}\PY{o}{/}\PY{l+m+mi}{32}\PY{n}{col\PYZus{}mp\PYZus{}ref\PYZus{}tbeucler\PYZus{}local}\PY{o}{.}\PY{n}{yml} \PYZbs{}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{aqua\PYZus{}names} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{*.h1.0001\PYZhy{}*\PYZhy{}01\PYZhy{}*}\PY{l+s+s1}{\PYZsq{}} \PYZbs{}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{out\PYZus{}pref} \PY{l+m+mi}{32}\PY{n}{\PYZus{}col\PYZus{}mp\PYZus{}1m\PYZus{}valid} \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{ext\PYZus{}norm} \PY{n}{Nope}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
GitPython not found. Please install for better reproducibility.
Time checkpoint reading data: 3.98 s
Number of time steps: 144
Cut time steps: [47 95]
Cut time steps: [47 95]
Time checkpoint create datasets: 4.07 s
Time checkpoint reshape and rechunk: 5.22 s
Load external normalization file
Time checkpoint normalization arrays: 5.22 s
Time checkpoint rechunk and ds: 5.33 s
Save features: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_mp\_1m\_valid\_features.nc
Save targets: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_mp\_1m\_valid\_targets.nc
Total time: 25.90 s

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}6}]:} \PY{o}{!}ls \PY{n+nv}{\PYZdl{}TRAINDIR}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
32\_col\_mp\_1m\_train\_features.nc	32\_col\_mp\_3d\_train\_shuffle\_features.nc
32\_col\_mp\_1m\_train\_norm.nc	32\_col\_mp\_3d\_train\_shuffle\_targets.nc
32\_col\_mp\_1m\_train\_targets.nc	32\_col\_mp\_3d\_train\_targets.nc
32\_col\_mp\_1m\_valid\_features.nc	32\_col\_mp\_3d\_valid\_features.nc
32\_col\_mp\_1m\_valid\_targets.nc	32\_col\_mp\_3d\_valid\_shuffle\_features.nc
32\_col\_mp\_3d\_train\_features.nc	32\_col\_mp\_3d\_valid\_shuffle\_targets.nc
32\_col\_mp\_3d\_train\_norm.nc	32\_col\_mp\_3d\_valid\_targets.nc
32\_col\_mp\_3d\_train\_oldnorm.nc	HDF5\_DATA

    \end{Verbatim}

    \hypertarget{shuffle-the-training-dataset}{%
\subsubsection{1.3) Shuffle the training
dataset}\label{shuffle-the-training-dataset}}

tgb - 1/16/2019 - Adapted from Stephan's entire worlflow for 32 column
run

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}7}]:} \PY{o}{\PYZpc{}}\PY{k}{cd} /filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM
        \PY{o}{!}python cbrain/shuffle\PYZus{}ds.py \PYZhy{}h
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/filer/z-sv-pool12c/t/Tom.Beucler/SPCAM/CBRAIN-CAM
usage: shuffle\_ds.py [-h] [--method METHOD] [--pref PREF]
                     [--random\_seed RANDOM\_SEED] [--chunk\_size CHUNK\_SIZE]
                     [--verbose VERBOSE]

optional arguments:
  -h, --help            show this help message and exit
  --method METHOD       [Meticulous or fast]
  --pref PREF           Prefix. ie without the \_features.nc
  --random\_seed RANDOM\_SEED
                        Random seed for shuffling of data.
  --chunk\_size CHUNK\_SIZE
                        Size of chunks for fast method
  --verbose VERBOSE     Verbosity level

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}8}]:} \PY{o}{!}python cbrain/shuffle\PYZus{}ds.py \PYZhy{}\PYZhy{}pref \PY{n+nv}{\PYZdl{}TRAINDIR}/32\PYZus{}col\PYZus{}mp\PYZus{}1m\PYZus{}train
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Reading files: /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_mp\_1m\_train\_features.nc /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_mp\_1m\_train\_targets.nc
Creating files: /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_mp\_1m\_train\_shuffle\_features.nc /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_mp\_1m\_train\_shuffle\_targets.nc
GitPython not found. Please install for better reproducibility.
GitPython not found. Please install for better reproducibility.
100\%|█████████████████████████████████████████████| 1/1 [00:20<00:00, 20.54s/it]

    \end{Verbatim}

    tgb - 1/24/2019 - Also shuffle the validation dataset

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}9}]:} \PY{o}{!}python cbrain/shuffle\PYZus{}ds.py \PYZhy{}\PYZhy{}pref \PY{n+nv}{\PYZdl{}TRAINDIR}/32\PYZus{}col\PYZus{}mp\PYZus{}1m\PYZus{}valid
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Reading files: /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_mp\_1m\_valid\_features.nc /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_mp\_1m\_valid\_targets.nc
Creating files: /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_mp\_1m\_valid\_shuffle\_features.nc /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_mp\_1m\_valid\_shuffle\_targets.nc
GitPython not found. Please install for better reproducibility.
GitPython not found. Please install for better reproducibility.
100\%|█████████████████████████████████████████████| 1/1 [00:03<00:00,  3.54s/it]

    \end{Verbatim}

    \hypertarget{change-the-outputs-normalization-using-pressure-levels}{%
\subsubsection{1.4) Change the output's normalization using pressure
levels}\label{change-the-outputs-normalization-using-pressure-levels}}

\hypertarget{step-0-load-the-file-using-xarray}{%
\paragraph{Step 0: Load the file using
xarray}\label{step-0-load-the-file-using-xarray}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}10}]:} \PY{k+kn}{import} \PY{n+nn}{xarray} \PY{k}{as} \PY{n+nn}{xr}
         \PY{n}{ds}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)}
         \PY{n}{PREFIX} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{32\PYZus{}col\PYZus{}mp\PYZus{}1m\PYZus{}}\PY{l+s+s1}{\PYZsq{}}
         \PY{n}{ds} \PY{o}{=} \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{TRAINDIR} \PY{o}{+} \PY{n}{PREFIX} \PY{o}{+} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}11}]:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}11}]:} <xarray.DataArray 'target\_conv' (target\_lev: 158)>
         array([2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.000000e+00, 1.000000e+00, 1.000000e+00, 1.000000e+00, 2.501000e+09,
                2.501000e+06, 2.501000e+09, 2.501000e+06], dtype=float32)
         Coordinates:
           * target\_lev  (target\_lev) int64 0 1 2 3 4 5 6 {\ldots} 151 152 153 154 155 156 157
\end{Verbatim}
            
    \hypertarget{step-1-check-already-existing-normalizations}{%
\paragraph{Step 1: Check already existing
normalizations}\label{step-1-check-already-existing-normalizations}}

\[
\left(\frac{dq_{v,l,i}}{dt}\right)\rightarrow\frac{L_{v}}{g}\ \left(\mathrm{Missing}\ \Delta p\right)
\] \[
\left(\frac{dT}{dt}\right)\rightarrow\frac{c_{p}}{g}\ \left(\mathrm{Missing\ }\Delta p\right)
\] \[
\left(\frac{dT_{TKE}}{dt}\right)\rightarrow\frac{c_{p}}{g}\ \left(\mathrm{Missing\ }\Delta p\right)
\] \[
{\cal F}_{\mathrm{rad}}\rightarrow1\ \left(\mathrm{All\ good}\right)
\] \[
\mathrm{Precip}_{{\cal V}}\rightarrow\rho L_{v}\ \left(\mathrm{All\ good}\right)
\] \[
\mathrm{Precip}_{{\mathrm{tend}, \cal V}}\rightarrow\ 10^{-3}\ \rho\ L_{v}\ \left(\mathrm{All\ good}\right)
\] We need to multiply the first (5 variables) * (30 levels) = (150
scalars) by the vector delta\_p (level)

    \hypertarget{step-2-calculate-differential-pressure-for-each-level}{%
\paragraph{Step 2: Calculate differential pressure for each
level}\label{step-2-calculate-differential-pressure-for-each-level}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}12}]:} \PY{c+c1}{\PYZsh{} 1.1 Open the pickle files containing the pressure converters}
         \PY{k}{with} \PY{n+nb}{open}\PY{p}{(}\PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/cbrain}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai\PYZus{}hybi.pkl}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rb}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{k}{as} \PY{n}{f}\PY{p}{:}
                     \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi} \PY{o}{=} \PY{n}{pickle}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{n}{f}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} 1.2 Takes representative value for PS since purpose is normalization}
         \PY{n}{PS} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;}
         \PY{n}{P} \PY{o}{=} \PY{n}{P0}\PY{o}{*}\PY{n}{hyai}\PY{o}{+}\PY{n}{PS}\PY{o}{*}\PY{n}{hybi}\PY{p}{;} \PY{c+c1}{\PYZsh{} Total pressure [Pa]}
         \PY{n}{dP} \PY{o}{=} \PY{n}{P}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{;} \PY{c+c1}{\PYZsh{} Differential pressure [Pa]}
         \PY{n}{dP}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}12}]:} array([ 277.64523402,  512.62555644,  839.73696455, 1211.38058603,
                1519.8353678 , 1745.60062587, 1737.79353499, 1423.96241426,
                1675.21685362, 1970.80597281, 2318.55362654, 2727.6545763 ,
                3208.94680917, 3775.1596421 , 4441.27991796, 5224.93720055,
                6146.86310291, 7231.4709425 , 8507.44917989, 8510.85484028,
                7811.29226089, 6591.71789885, 4899.05960858, 2836.21996641,
                2660.87651253, 2463.98309246, 2246.78721279, 2010.62900014,
                1757.35657103, 1488.78097534])
\end{Verbatim}
            
    \hypertarget{step-3-multiply-qt-tendency-components-of-the-norm.-vector-by-dp}{%
\paragraph{Step 3: Multiply Q/T tendency components of the norm. vector
by
dp}\label{step-3-multiply-qt-tendency-components-of-the-norm.-vector-by-dp}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}13}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
         \PY{n}{dt} \PY{o}{=} \PY{l+m+mi}{30}\PY{o}{*}\PY{l+m+mi}{60}\PY{p}{;} \PY{c+c1}{\PYZsh{} timestep}
         \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{(}\PY{n}{dP}\PY{p}{,}\PY{n}{dP}\PY{p}{,}\PY{n}{dP}\PY{p}{,}\PY{n}{dP}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{dP}\PY{p}{,}\PY{n}{dt}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}14}]:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}14}]:} <xarray.DataArray 'target\_conv' (target\_lev: 158)>
         array([7.081169e+07, 1.307420e+08, 2.141697e+08, 3.089551e+08, 3.876245e+08,
                4.452045e+08, 4.432134e+08, 3.631727e+08, 4.272536e+08, 5.026418e+08,
                5.913327e+08, 6.956713e+08, 8.184219e+08, 9.628309e+08, 1.132721e+09,
                1.332588e+09, 1.567719e+09, 1.844342e+09, 2.169772e+09, 2.170640e+09,
                1.992221e+09, 1.681177e+09, 1.249475e+09, 7.233602e+08, 6.786399e+08,
                6.284236e+08, 5.730291e+08, 5.127984e+08, 4.482028e+08, 3.797043e+08,
                7.081169e+07, 1.307420e+08, 2.141697e+08, 3.089551e+08, 3.876245e+08,
                4.452045e+08, 4.432134e+08, 3.631727e+08, 4.272536e+08, 5.026418e+08,
                5.913327e+08, 6.956713e+08, 8.184219e+08, 9.628309e+08, 1.132721e+09,
                1.332588e+09, 1.567719e+09, 1.844342e+09, 2.169772e+09, 2.170640e+09,
                1.992221e+09, 1.681177e+09, 1.249475e+09, 7.233602e+08, 6.786399e+08,
                6.284236e+08, 5.730291e+08, 5.127984e+08, 4.482028e+08, 3.797043e+08,
                7.081169e+07, 1.307420e+08, 2.141697e+08, 3.089551e+08, 3.876245e+08,
                4.452045e+08, 4.432134e+08, 3.631727e+08, 4.272536e+08, 5.026418e+08,
                5.913327e+08, 6.956713e+08, 8.184219e+08, 9.628309e+08, 1.132721e+09,
                1.332588e+09, 1.567719e+09, 1.844342e+09, 2.169772e+09, 2.170640e+09,
                1.992221e+09, 1.681177e+09, 1.249475e+09, 7.233602e+08, 6.786399e+08,
                6.284236e+08, 5.730291e+08, 5.127984e+08, 4.482028e+08, 3.797043e+08,
                2.844472e+04, 5.251843e+04, 8.603096e+04, 1.241058e+05, 1.557070e+05,
                1.788366e+05, 1.780368e+05, 1.458848e+05, 1.716258e+05, 2.019089e+05,
                2.375356e+05, 2.794479e+05, 3.287562e+05, 3.867647e+05, 4.550086e+05,
                5.352942e+05, 6.297454e+05, 7.408634e+05, 8.715872e+05, 8.719361e+05,
                8.002661e+05, 6.753208e+05, 5.019081e+05, 2.905704e+05, 2.726065e+05,
                2.524348e+05, 2.301831e+05, 2.059887e+05, 1.800410e+05, 1.525255e+05,
                1.580262e+01, 2.917691e+01, 4.779498e+01, 6.894767e+01, 8.650387e+01,
                9.935366e+01, 9.890931e+01, 8.104710e+01, 9.534766e+01, 1.121716e+02,
                1.319642e+02, 1.552488e+02, 1.826424e+02, 2.148693e+02, 2.527826e+02,
                2.973857e+02, 3.498586e+02, 4.115908e+02, 4.842151e+02, 4.844090e+02,
                4.445923e+02, 3.751782e+02, 2.788378e+02, 1.614280e+02, 1.514481e+02,
                1.402415e+02, 1.278795e+02, 1.144382e+02, 1.000228e+02, 8.473636e+01,
                1.000000e+00, 1.000000e+00, 1.000000e+00, 1.000000e+00, 2.501000e+09,
                2.501000e+06, 2.501000e+09, 2.501000e+06], dtype=float32)
         Coordinates:
           * target\_lev  (target\_lev) int64 0 1 2 3 4 5 6 {\ldots} 151 152 153 154 155 156 157
\end{Verbatim}
            
    \hypertarget{step-4-replace-targ_conv-in-the-train_norm-netcdf-file-with-the-new-values}{%
\paragraph{Step 4: Replace targ\_conv in the train\_norm NETCDF file
with the new
values}\label{step-4-replace-targ_conv-in-the-train_norm-netcdf-file-with-the-new-values}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}16}]:} \PY{c+c1}{\PYZsh{} 4.1 Copy old normalization file}
         \PY{n}{path1} \PY{o}{=} \PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{n}{TRAINDIR}\PY{p}{,}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{path2} \PY{o}{=} \PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{n}{TRAINDIR}\PY{p}{,}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}oldnorm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{o}{!}cp \PY{n+nv}{\PYZdl{}path1} \PY{n+nv}{\PYZdl{}path2}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}17}]:} \PY{c+c1}{\PYZsh{} 4.1.CHECK that the old normalization file was properly copied}
         \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{TRAINDIR} \PY{o}{+} \PY{n}{PREFIX} \PY{o}{+} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}oldnorm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{.}\PY{n}{target\PYZus{}conv}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}17}]:} <xarray.DataArray 'target\_conv' (target\_lev: 158)>
         array([2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05, 2.550438e+05,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02, 1.024499e+02,
                1.000000e+00, 1.000000e+00, 1.000000e+00, 1.000000e+00, 2.501000e+09,
                2.501000e+06, 2.501000e+09, 2.501000e+06], dtype=float32)
         Coordinates:
           * target\_lev  (target\_lev) int64 0 1 2 3 4 5 6 {\ldots} 151 152 153 154 155 156 157
\end{Verbatim}
            
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}18}]:} \PY{c+c1}{\PYZsh{} 4.2 Create new dataset with characteristics of modified ds}
         \PY{n}{new\PYZus{}ds} \PY{o}{=} \PY{n}{xr}\PY{o}{.}\PY{n}{Dataset}\PY{p}{(}\PY{p}{\PYZob{}}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}means}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}stds}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}mins}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}mins}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}maxs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}maxs}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}means}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}stds}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}stds}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}mins}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}mins}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}maxs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}maxs}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}names}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}names}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}names}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}names}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}conv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}
                 \PY{p}{\PYZcb{}}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}19}]:} \PY{c+c1}{\PYZsh{} 4.2 Check}
         \PY{n}{new\PYZus{}ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}19}]:} <xarray.DataArray 'target\_conv' (target\_lev: 158)>
         array([7.081169e+07, 1.307420e+08, 2.141697e+08, 3.089551e+08, 3.876245e+08,
                4.452045e+08, 4.432134e+08, 3.631727e+08, 4.272536e+08, 5.026418e+08,
                5.913327e+08, 6.956713e+08, 8.184219e+08, 9.628309e+08, 1.132721e+09,
                1.332588e+09, 1.567719e+09, 1.844342e+09, 2.169772e+09, 2.170640e+09,
                1.992221e+09, 1.681177e+09, 1.249475e+09, 7.233602e+08, 6.786399e+08,
                6.284236e+08, 5.730291e+08, 5.127984e+08, 4.482028e+08, 3.797043e+08,
                7.081169e+07, 1.307420e+08, 2.141697e+08, 3.089551e+08, 3.876245e+08,
                4.452045e+08, 4.432134e+08, 3.631727e+08, 4.272536e+08, 5.026418e+08,
                5.913327e+08, 6.956713e+08, 8.184219e+08, 9.628309e+08, 1.132721e+09,
                1.332588e+09, 1.567719e+09, 1.844342e+09, 2.169772e+09, 2.170640e+09,
                1.992221e+09, 1.681177e+09, 1.249475e+09, 7.233602e+08, 6.786399e+08,
                6.284236e+08, 5.730291e+08, 5.127984e+08, 4.482028e+08, 3.797043e+08,
                7.081169e+07, 1.307420e+08, 2.141697e+08, 3.089551e+08, 3.876245e+08,
                4.452045e+08, 4.432134e+08, 3.631727e+08, 4.272536e+08, 5.026418e+08,
                5.913327e+08, 6.956713e+08, 8.184219e+08, 9.628309e+08, 1.132721e+09,
                1.332588e+09, 1.567719e+09, 1.844342e+09, 2.169772e+09, 2.170640e+09,
                1.992221e+09, 1.681177e+09, 1.249475e+09, 7.233602e+08, 6.786399e+08,
                6.284236e+08, 5.730291e+08, 5.127984e+08, 4.482028e+08, 3.797043e+08,
                2.844472e+04, 5.251843e+04, 8.603096e+04, 1.241058e+05, 1.557070e+05,
                1.788366e+05, 1.780368e+05, 1.458848e+05, 1.716258e+05, 2.019089e+05,
                2.375356e+05, 2.794479e+05, 3.287562e+05, 3.867647e+05, 4.550086e+05,
                5.352942e+05, 6.297454e+05, 7.408634e+05, 8.715872e+05, 8.719361e+05,
                8.002661e+05, 6.753208e+05, 5.019081e+05, 2.905704e+05, 2.726065e+05,
                2.524348e+05, 2.301831e+05, 2.059887e+05, 1.800410e+05, 1.525255e+05,
                1.580262e+01, 2.917691e+01, 4.779498e+01, 6.894767e+01, 8.650387e+01,
                9.935366e+01, 9.890931e+01, 8.104710e+01, 9.534766e+01, 1.121716e+02,
                1.319642e+02, 1.552488e+02, 1.826424e+02, 2.148693e+02, 2.527826e+02,
                2.973857e+02, 3.498586e+02, 4.115908e+02, 4.842151e+02, 4.844090e+02,
                4.445923e+02, 3.751782e+02, 2.788378e+02, 1.614280e+02, 1.514481e+02,
                1.402415e+02, 1.278795e+02, 1.144382e+02, 1.000228e+02, 8.473636e+01,
                1.000000e+00, 1.000000e+00, 1.000000e+00, 1.000000e+00, 2.501000e+09,
                2.501000e+06, 2.501000e+09, 2.501000e+06], dtype=float32)
         Coordinates:
           * target\_lev  (target\_lev) int64 0 1 2 3 4 5 6 {\ldots} 151 152 153 154 155 156 157
\end{Verbatim}
            
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}20}]:} \PY{c+c1}{\PYZsh{} 4.3 Write new data set to initial target\PYZus{}conv file}
         \PY{o}{!}rm \PY{n+nv}{\PYZdl{}path1} \PYZsh{} Remove normalization file
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}21}]:} \PY{n}{new\PYZus{}ds}\PY{o}{.}\PY{n}{to\PYZus{}netcdf}\PY{p}{(}\PY{n}{path1}\PY{p}{)} \PY{c+c1}{\PYZsh{} Save the new dataset as the new normalization file}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}22}]:} \PY{c+c1}{\PYZsh{} 4.3 CHECK}
         \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{path1}\PY{p}{)}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)} \PY{c+c1}{\PYZsh{} Don\PYZsq{}t forget to close the old handler!!}
         \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{path1}\PY{p}{)}\PY{o}{.}\PY{n}{target\PYZus{}conv} \PY{c+c1}{\PYZsh{} Before checking if the new normalizations are at the right place}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}22}]:} <xarray.DataArray 'target\_conv' (target\_lev: 158)>
         array([7.081169e+07, 1.307420e+08, 2.141697e+08, 3.089551e+08, 3.876245e+08,
                4.452045e+08, 4.432134e+08, 3.631727e+08, 4.272536e+08, 5.026418e+08,
                5.913327e+08, 6.956713e+08, 8.184219e+08, 9.628309e+08, 1.132721e+09,
                1.332588e+09, 1.567719e+09, 1.844342e+09, 2.169772e+09, 2.170640e+09,
                1.992221e+09, 1.681177e+09, 1.249475e+09, 7.233602e+08, 6.786399e+08,
                6.284236e+08, 5.730291e+08, 5.127984e+08, 4.482028e+08, 3.797043e+08,
                7.081169e+07, 1.307420e+08, 2.141697e+08, 3.089551e+08, 3.876245e+08,
                4.452045e+08, 4.432134e+08, 3.631727e+08, 4.272536e+08, 5.026418e+08,
                5.913327e+08, 6.956713e+08, 8.184219e+08, 9.628309e+08, 1.132721e+09,
                1.332588e+09, 1.567719e+09, 1.844342e+09, 2.169772e+09, 2.170640e+09,
                1.992221e+09, 1.681177e+09, 1.249475e+09, 7.233602e+08, 6.786399e+08,
                6.284236e+08, 5.730291e+08, 5.127984e+08, 4.482028e+08, 3.797043e+08,
                7.081169e+07, 1.307420e+08, 2.141697e+08, 3.089551e+08, 3.876245e+08,
                4.452045e+08, 4.432134e+08, 3.631727e+08, 4.272536e+08, 5.026418e+08,
                5.913327e+08, 6.956713e+08, 8.184219e+08, 9.628309e+08, 1.132721e+09,
                1.332588e+09, 1.567719e+09, 1.844342e+09, 2.169772e+09, 2.170640e+09,
                1.992221e+09, 1.681177e+09, 1.249475e+09, 7.233602e+08, 6.786399e+08,
                6.284236e+08, 5.730291e+08, 5.127984e+08, 4.482028e+08, 3.797043e+08,
                2.844472e+04, 5.251843e+04, 8.603096e+04, 1.241058e+05, 1.557070e+05,
                1.788366e+05, 1.780368e+05, 1.458848e+05, 1.716258e+05, 2.019089e+05,
                2.375356e+05, 2.794479e+05, 3.287562e+05, 3.867647e+05, 4.550086e+05,
                5.352942e+05, 6.297454e+05, 7.408634e+05, 8.715872e+05, 8.719361e+05,
                8.002661e+05, 6.753208e+05, 5.019081e+05, 2.905704e+05, 2.726065e+05,
                2.524348e+05, 2.301831e+05, 2.059887e+05, 1.800410e+05, 1.525255e+05,
                1.580262e+01, 2.917691e+01, 4.779498e+01, 6.894767e+01, 8.650387e+01,
                9.935366e+01, 9.890931e+01, 8.104710e+01, 9.534766e+01, 1.121716e+02,
                1.319642e+02, 1.552488e+02, 1.826424e+02, 2.148693e+02, 2.527826e+02,
                2.973857e+02, 3.498586e+02, 4.115908e+02, 4.842151e+02, 4.844090e+02,
                4.445923e+02, 3.751782e+02, 2.788378e+02, 1.614280e+02, 1.514481e+02,
                1.402415e+02, 1.278795e+02, 1.144382e+02, 1.000228e+02, 8.473636e+01,
                1.000000e+00, 1.000000e+00, 1.000000e+00, 1.000000e+00, 2.501000e+09,
                2.501000e+06, 2.501000e+09, 2.501000e+06], dtype=float32)
         Coordinates:
           * target\_lev  (target\_lev) int64 0 1 2 3 4 5 6 {\ldots} 151 152 153 154 155 156 157
\end{Verbatim}
            
    \hypertarget{create-data-generator-and-produce-data-sample}{%
\subsection{2) Create data generator and produce data
sample}\label{create-data-generator-and-produce-data-sample}}

    \hypertarget{create-data-generator-from-training-dataset}{%
\subsubsection{2.1) Create data generator from training
dataset}\label{create-data-generator-from-training-dataset}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}23}]:} \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{path1}\PY{p}{)}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)} \PY{c+c1}{\PYZsh{} Don\PYZsq{}t forget to close xarray handler!!}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}24}]:} \PY{n}{train\PYZus{}gen\PYZus{}obj} \PY{o}{=} \PY{n}{DataGenerator}\PY{p}{(}
             \PY{n}{data\PYZus{}dir}\PY{o}{=}\PY{n}{TRAINDIR}\PY{p}{,} 
             \PY{n}{feature\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}shuffle\PYZus{}features.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{n}{target\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}shuffle\PYZus{}targets.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{n}{batch\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{512}\PY{p}{,}
             \PY{n}{norm\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{n}{fsub}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}   \PY{c+c1}{\PYZsh{} Subtracct the mean}
             \PY{n}{fdiv}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} Then divide by Std}
             \PY{n}{tmult}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}conv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} For targets/output: use values from preprocess\PYZus{}aqua.}
             \PY{n}{shuffle}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}
         \PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Generator will have 4620288 samples in 9024 batches
Features have shape 154; targets have shape 158

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}25}]:} \PY{n}{gen} \PY{o}{=} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{return\PYZus{}generator}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \hypertarget{produce-data-sample}{%
\subsubsection{2.2) Produce data sample}\label{produce-data-sample}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}26}]:} \PY{n}{x}\PY{p}{,} \PY{n}{y} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)}
         
         \PY{n}{x}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{y}\PY{o}{.}\PY{n}{shape}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}26}]:} ((512, 154), (512, 158))
\end{Verbatim}
            
    \hypertarget{create-data-generator-from-validation-dataset-and-produce-sample}{%
\subsubsection{2.3) Create data generator from validation dataset and
produce
sample}\label{create-data-generator-from-validation-dataset-and-produce-sample}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}27}]:} \PY{n}{valid\PYZus{}gen\PYZus{}obj} \PY{o}{=} \PY{n}{DataGenerator}\PY{p}{(}
             \PY{n}{data\PYZus{}dir}\PY{o}{=}\PY{n}{TRAINDIR}\PY{p}{,} 
             \PY{n}{feature\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{valid\PYZus{}shuffle\PYZus{}features.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{n}{target\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{valid\PYZus{}shuffle\PYZus{}targets.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{n}{batch\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{512}\PY{p}{,}
             \PY{n}{norm\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{n}{fsub}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}   \PY{c+c1}{\PYZsh{} Subtracct the mean}
             \PY{n}{fdiv}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} Then divide by Std}
             \PY{n}{tmult}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}conv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} For targets/output: use values from preprocess\PYZus{}aqua.}
             \PY{n}{shuffle}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}
         \PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Generator will have 1155072 samples in 2256 batches
Features have shape 154; targets have shape 158

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}28}]:} \PY{n}{validgen} \PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{return\PYZus{}generator}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}29}]:} \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{validgen}\PY{p}{)}
         
         \PY{n}{xval}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{yval}\PY{o}{.}\PY{n}{shape}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}29}]:} ((512, 154), (512, 158))
\end{Verbatim}
            
    \hypertarget{neural-network-attempts-tgb---started-1152019}{%
\subsection{3) Neural network attempts (tgb - started
1/15/2019)}\label{neural-network-attempts-tgb---started-1152019}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}30}]:} \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{layers} \PY{k}{import} \PY{o}{*}
         \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{o}{*}
\end{Verbatim}


    \hypertarget{energy-conservation-strategy-tgb---started-1182019}{%
\subsubsection{3.3) Energy conservation strategy (tgb - started
1/18/2019)}\label{energy-conservation-strategy-tgb---started-1182019}}

\hypertarget{step-0-load-all-the-variables-to-calculate-mass-weighted-vertical-integrals}{%
\paragraph{Step 0: Load all the variables to calculate mass-weighted
vertical
integrals}\label{step-0-load-all-the-variables-to-calculate-mass-weighted-vertical-integrals}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}31}]:} \PY{c+c1}{\PYZsh{} 1) Open the file containing the normalization of the targets}
         \PY{n}{ds} \PY{o}{=} \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{TRAINDIR} \PY{o}{+} \PY{n}{PREFIX} \PY{o}{+} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} 2) Open the pickle files containing the pressure converters}
         \PY{k}{with} \PY{n+nb}{open}\PY{p}{(}\PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/cbrain}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai\PYZus{}hybi.pkl}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rb}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{k}{as} \PY{n}{f}\PY{p}{:}
                     \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi} \PY{o}{=} \PY{n}{pickle}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{n}{f}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}32}]:} \PY{n}{fsub} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}means}\PY{o}{.}\PY{n}{values}
         \PY{n}{fdiv} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{o}{.}\PY{n}{values}
         \PY{n}{normq} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}\PY{o}{.}\PY{n}{values}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{fsub}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{fdiv}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{normq}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{hyai}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{hybi}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
(154,)
(154,)
(158,)
(31,)
(31,)

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}33}]:} \PY{n}{ds}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \hypertarget{step-1-implement-mass-conservation-layer}{%
\paragraph{Step 1: Implement mass conservation
layer}\label{step-1-implement-mass-conservation-layer}}

    \hypertarget{enforcing-mass-conservation}{%
\subparagraph{Enforcing mass
conservation}\label{enforcing-mass-conservation}}

Reference for mass and energy conservation:

(Original CAM F90 script, look for ``Compute vertical integrals of dry
static energy and water'' in the script)\\
https://gitlab.com/mspritch/spcam3.0-neural-net/blob/master/models/atm/cam/src/physics/cam1/check\_energy.F90

(Stephan's energy/mass verification scripts)\\
https://github.com/raspstephan/CBRAIN-CAM/blob/master/notebooks/dev/old\_notebooks/energy\_conservation.ipynb

\hypertarget{masswater-conservation-equation-in-wm2}{%
\subparagraph{Mass/Water conservation equation in
W/m2}\label{masswater-conservation-equation-in-wm2}}

If the network predicts the water vapor tendency, defined as the
difference between the moisture before and after physics divided by the
timestep dt (normalized in energy units W/m2):
\[\delta q_{v,i,l}\left(p\right)\overset{\mathrm{def}}{=}\frac{L_{v}\Delta p_{\mathrm{norm}}}{g}\frac{q_{v,i,l}^{a}\left(p\right)-q_{v,i,l}^{b}\left(p\right)}{\Delta t}\]

The water conservation equation is (normalized in energy units W/m2):
\[\underbrace{\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\left(\delta q_{v}+\delta q_{l}+\delta q_{i}\right)}_{\mathrm{Difference\ after-before\ physics}}=\underbrace{\int_{\widetilde{t}}^{\widetilde{t}+1} \widetilde{dt}\ \left(LHF-L_{v}P-10^{-3}\cdot L_{v} P_{tend}\right)}_{\mathrm{Cond-Precip\ during\ \Delta t}}
\]

where we have defined: \[
\widetilde{p}\overset{\mathrm{def}}{=}\frac{p}{p_{\mathrm{norm}}}
\] \[
\widetilde{t}\overset{\mathrm{def}}{=}\frac{t}{\Delta t}
\] Note that the precipitation variables here sum up to the water flux
from the atmosphere to the surface due to precipitation: \[
\mathrm{Precipitation\ flux\ atm\rightarrow surf.\ \left[kg.m^{-2}.s^{-1}\right]}=P+10^{-3}\cdot P_{tend}
\] The idea is to predict all variables but one. The specific humidity
at the lowest level of the model (here 30) is likely to be one of the
most penalized output variables as it has one of the largest tendencies
(in W/m2) in the final cost function. If we predict all other variables
and calculate that variable as a residual, it yields:

\[\Delta \widetilde{p}_{30} \delta q_{v}^{30}=\int_{\widetilde{t}}^{\widetilde{t}+1} \widetilde{dt}\ \left(LHF-L_{v}P-10^{-3}\cdot L_{v} P_{tend}\right)-\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\left(\delta q_{l}+\delta q_{i}\right)-\int_{0}^{\widetilde{p_{30}}}d\widetilde{p}\delta q_{v}
\]

Note that because we are already working with tendencies, the timestep
variable dt is not needed in the water conservation layer.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}34}]:} \PY{k}{class} \PY{n+nc}{MasConsLay}\PY{p}{(}\PY{n}{Layer}\PY{p}{)}\PY{p}{:}
             
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{p}{,} \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim}\PY{p}{,} \PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub} \PY{o}{=} \PY{n}{fsub} \PY{c+c1}{\PYZsh{} Subtraction for normalization of inputs }
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv} \PY{o}{=} \PY{n}{fdiv} \PY{c+c1}{\PYZsh{} Division for normalization of inputs}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq} \PY{o}{=} \PY{n}{normq} \PY{c+c1}{\PYZsh{} Normalization of output\PYZsq{}s water concentration}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai} \PY{o}{=} \PY{n}{hyai} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi} \PY{o}{=} \PY{n}{hybi} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{n}{output\PYZus{}dim} \PY{c+c1}{\PYZsh{} Dimension of output}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n+nf+fm}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{build}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{build}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{)}  \PY{c+c1}{\PYZsh{} Be sure to call this somewhere!}
                 
             \PY{k}{def} \PY{n+nf}{call}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{arrs}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} arrs (for arrays) is a list with }
                 \PY{c+c1}{\PYZsh{} [inputs=inp and the output of the previous layer=densout]}
                 \PY{c+c1}{\PYZsh{} inputs will be [n\PYZus{}sample, 154 = 30*5+4] with}
                 \PY{c+c1}{\PYZsh{} [QBP, QCBP, QIBP, TBP, VBP, PS, SOLIN, SHFLX, LHFLX]}
                 \PY{c+c1}{\PYZsh{} outputs of the previous dense layer will be [n\PYZus{}samples, 124 = 30*4+6\PYZhy{}2] with}
                 \PY{c+c1}{\PYZsh{} [DELQ\PYZbs{}\PYZob{}PHQ AT LOWEST LVL\PYZcb{}, DELCLDLIQ, DELCLDICE, }
                 \PY{c+c1}{\PYZsh{} TPHYSTND\PYZbs{}\PYZob{}TPHYSTND AT LOWEST LVL\PYZcb{}, FSNT, FSNS, FLNT, FLNS, PRECT, PRECTEND]}
                 
                 \PY{c+c1}{\PYZsh{} Split between the inputs inp \PYZam{} the output of the densely connected}
                 \PY{c+c1}{\PYZsh{} neural network, densout}
                 \PY{n}{inp}\PY{p}{,} \PY{n}{densout} \PY{o}{=} \PY{n}{arrs}
                 
                 \PY{c+c1}{\PYZsh{} 0) Constants}
                 \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
                 \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
                 \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
                 
                 \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
                 \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
                 \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
                 \PY{n}{PS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
                 \PY{n}{P} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                             \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{)}
                 \PY{n}{dP} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
                 \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                            \PY{n}{G}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
                 \PY{c+c1}{\PYZsh{} Wondering about broadcasting here...}
                 \PY{c+c1}{\PYZsh{} tf.div or simply \PYZbs{} would support broadcasting }
                 \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 2) Calculate cloud water vertical integral from level 1 to level 30}
                 \PY{c+c1}{\PYZsh{} The indices are tricky here because we are missing del(q\PYZus{}v)@(level 30)}
                 \PY{c+c1}{\PYZsh{} so e.g. q\PYZus{}liq@(level 1) is the 30th element of the output of the }
                 \PY{c+c1}{\PYZsh{} previous dense layer}
                 \PY{n}{CLDVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PYZbs{}
                                           \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{:}\PY{l+m+mi}{59}\PY{p}{]}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{59}\PY{p}{:}\PY{l+m+mi}{89}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{CLDINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{CLDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 3) Calculate water vapor vertical integral from level 1 to level 29}
                 \PY{n}{VAPVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                           \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
                 \PY{n}{VAPINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{VAPVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 4) Calculate forcing on the right\PYZhy{}hand side (Net Evaporation\PYZhy{}Precipitation)}
                 \PY{c+c1}{\PYZsh{} E\PYZhy{}P is already normalized to units W.m\PYZhy{}2 in the output vector}
                 \PY{c+c1}{\PYZsh{} so all we need to do is input\PYZhy{}unnormalize LHF that is taken from the input vector}
                 \PY{n}{LHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Note that total precipitation = PRECT + 1e\PYZhy{}3*PRECTEND in the CAM model}
                 \PY{c+c1}{\PYZsh{} PRECTEND already multiplied by 1e\PYZhy{}3 in output vector so no need to redo it}
                 \PY{n}{PREC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 5) Infer water vapor tendency at level 30 as a residual}
                 \PY{c+c1}{\PYZsh{} Composing tfm.add 3 times because not sure how to use tfm.add\PYZus{}n}
                 \PY{n}{DELQV30} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{add} \PY{p}{(}\PYZbs{}
                                                                 \PY{n}{LHF}\PY{p}{,} \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{PREC}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                                       \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{CLDINT}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                              \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{VAPINT}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                      \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 6) Concatenate the water tendencies with the newly inferred tendency}
                 \PY{c+c1}{\PYZsh{} to get the final vector out of shape (\PYZsh{}samples,125) with}
                 \PY{c+c1}{\PYZsh{} [DELQ, DELCLDLIQ, DELCLDICE, }
                 \PY{c+c1}{\PYZsh{} TPHYSTND\PYZbs{}\PYZob{}TPHYSTND AT SURFACE\PYZcb{}, FSNT, FSNS, FLNT, FLNS, PRECT PRECTEND]}
                 \PY{c+c1}{\PYZsh{} Uses https://www.tensorflow.org/api\PYZus{}docs/python/tf/concat}
                 \PY{n}{DELQV30} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{DELQV30}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{} Adds dimension=1 to axis=1}
                 \PY{n}{out} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,} \PY{n}{DELQV30}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}
                 \PY{k}{return} \PY{n}{out}
             
             \PY{k}{def} \PY{n+nf}{compute\PYZus{}output\PYZus{}shape}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{k}{return} \PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{)} \PY{c+c1}{\PYZsh{} The output has size 125=30*4+6\PYZhy{}1}
             \PY{c+c1}{\PYZsh{} and is ready to be fed to the energy conservation layer}
             \PY{c+c1}{\PYZsh{} before we reach the total number of outputs = 126}
\end{Verbatim}


    \hypertarget{step-2-implement-energy-conservation-layer}{%
\paragraph{Step 2: Implement energy conservation
layer}\label{step-2-implement-energy-conservation-layer}}

\hypertarget{energy-conservation-equation-in-wm2}{%
\subparagraph{Energy conservation equation in
W/m2}\label{energy-conservation-equation-in-wm2}}

The total energy conservation in CAM is much more delicate than the
water mass conservation. One key simplification is that the net
advection of moist static energy in the CRM (within a grid-box) is zero,
so we only need to focus on the thermodynamics.

The two reference scripts of SPCAM are:\\
1)https://gitlab.com/mspritch/spcam3.0-neural-net/blob/master/models/atm/cam/src/physics/cam1/check\_energy.F90
(look for te\_tdn)\\
2)https://gitlab.com/mspritch/spcam3.0-neural-net/blob/master/models/atm/cam/src/physics/cam1/tphysbc\_internallythreaded.F90
(look for wtricesink and icesink)

Another very useful script is Stephan's attempt at conserving
energy/making sense of the variables:\\
https://github.com/raspstephan/CBRAIN-CAM/blob/master/notebooks/dev/old\_notebooks/energy\_conservation.ipynb\\
which is extremely helpful since some NETCDF flags are misleading/have
the wrong attributes.

Following these files, we define the total energy, where the enthalpy
component uses the ice as the reference phase of energy 0 (therefore,
each gram of water in the forms of liquid or vapor add to the total
energy of the system): \[
e\ \left[\mathrm{J\ kg^{-1}}\right]\overset{\mathrm{def}}{=}\frac{\overrightarrow{u}\cdot\overrightarrow{u}}{2}+c_{p}T+L_{s}q_{v}+L_{f}q_{l}
\] We then isolate the column tendency of each variable that is due to
precipitation or phase change between ice and liquid within the column.
\[
\delta QV_{SP}\ \left[\mathrm{kg\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{p_{s}}\frac{dp}{g}\left(\frac{dq_{v}}{dt}\right)-\frac{\mathrm{LHF}}{L_{v}}
\] \[
\delta QL_{SP}\ \left[\mathrm{kg\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{p_{s}}\frac{dp}{g}\left(\frac{dq_{l}}{dt}\right)
\] \[
\delta T_{SP}\ \left[\mathrm{W\ m^{-2}\ K^{-1}}\right]\overset{\mathrm{def}}{=}\int_{0}^{p_{s}}\frac{dp}{g}\left(\frac{dT}{dt}\right)-\frac{\mathrm{RAD}}{c_{p}}-\frac{\mathrm{SHF}}{c_{p}}-\int_{0}^{p_{s}}\frac{dp}{g}\left(\frac{dT_{KE}}{dt}\right)
\] where we have introduced the net radiative heating of the column: \[
\mathrm{RAD}\overset{\mathrm{def}}{=}\mathrm{SW}_{t}-\mathrm{SW}_{s}+\mathrm{LW}_{s}-\mathrm{LW}_{t}
\] Physically, we have removed the following energetic contributions: -
The net evaporation due to the latent heat flux from the column water
vapor tendency, - The net radiative flux, the sensible heat flux and the
column turbulent dissipation of kinetic energy from the column
temperature tendency, - Nothing from the column liquid water tendency,
since it is all due to conversion to vapor or ice.

The next step is to calculate the total energy tendency due to
precipitation/phase change by summing all of the components we have
calculated before: \[
\delta E_{\mathrm{SP}}\ \left[\mathrm{W\ m^{-2}}\right]=c_{p}\delta T_{SP}+L_{s}\delta QV_{SP}+L_{f}\delta QL_{SP}
\] Note that: - Because the current setup of SPCAM does not resolve
momentum transfer, we have left the change in kinetic energy out. -
Because the reference state is ice (and not liquid as is often seen for
the frozen moist static energy), the latent heat flux is multiplied by
the ratio L\_s/L\_v\textgreater{}1 of the latent heat of sublimation to
the latent heat of vaporization.

The change from phase change/precipitation is a sum of two terms: - An
energy source from the net change from (liquid) to (ice) within the
column ``SNOW''. - An energy sink from the precipitation flux from the
(atmopshere) to the (surface) ``P''. \[
\delta E_{\mathrm{SP}}\ \left[\mathrm{W\ m^{-2}}\right]=L_{f}\left(SNOW+10^{-3}SNOW_{tend}-P-10^{-3}P_{tend}\ \left[\mathrm{All\ in\ kg\ m^{-2}\ s^{-1}}\right]\right)
\]\\
We work with the same non-dimensional variable as before, since all
variables have been normalized in the output vector to have units W/m2.
Additionally to: \[
\delta q_{v,i,l}\left(p\right)\overset{\mathrm{def}}{=}\frac{L_{v}\Delta p_{\mathrm{norm}}}{g}\frac{q_{v,i,l}^{a}\left(p\right)-q_{v,i,l}^{b}\left(p\right)}{\Delta t}
\] we now also introduce the level-by-level temperature tendency in
units W/m2: \[
\delta T\left(p\right)\overset{\mathrm{def}}{=}\frac{c_{p}\Delta p_{\mathrm{norm}}}{g}\left(\frac{dT}{dt}\right)\left(p\right)
\]

The equations become: \[
L_{v}\cdot\delta QV_{SP}\ \left[\mathrm{W\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta q_{v}-\mathrm{LHF}
\] \[
L_{v}\cdot\delta QL_{SP}\ \left[\mathrm{W\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta q_{l}
\] \[
c_{p}\cdot\delta T_{SP}\ \left[\mathrm{W\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta T-\mathrm{RAD}-\mathrm{SHF}-\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta T_{TKE}
\]

We now isolate the temperature tendency at level 30 and write it as a
residual of the energy budget using all the variables normalized to
units W/m2: \[
\begin{aligned}\Delta\widetilde{p}_{30}\cdot\delta T_{30} & =\frac{L_{f}}{L_{v}}\left(L_{v}SNOW+10^{-3}L_{v}SNOW_{tend}-L_{v}P-10^{-3}L_{v}P_{tend}\right)\\
 & +\mathrm{RAD}+\mathrm{SHF}+\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta T_{TKE}\\
 & -\frac{L_{s}}{L_{v}}\left(\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta q_{v}-\mathrm{LHF}\right)-\frac{L_{f}}{L_{v}}\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta q_{l}\\
 & -\int_{0}^{\widetilde{p_{30}}}d\widetilde{p}\cdot\delta T
\end{aligned}
\]

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}35}]:} \PY{k}{class} \PY{n+nc}{EntConsLay}\PY{p}{(}\PY{n}{Layer}\PY{p}{)}\PY{p}{:}
             
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{p}{,} \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim}\PY{p}{,} \PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub} \PY{o}{=} \PY{n}{fsub} \PY{c+c1}{\PYZsh{} Subtraction for normalization of inputs }
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv} \PY{o}{=} \PY{n}{fdiv} \PY{c+c1}{\PYZsh{} Division for normalization of inputs}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq} \PY{o}{=} \PY{n}{normq} \PY{c+c1}{\PYZsh{} Normalization of output\PYZsq{}s water concentration}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai} \PY{o}{=} \PY{n}{hyai} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi} \PY{o}{=} \PY{n}{hybi} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{n}{output\PYZus{}dim} \PY{c+c1}{\PYZsh{} Dimension of output}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n+nf+fm}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{build}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{build}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{)}  \PY{c+c1}{\PYZsh{} Be sure to call this somewhere!}
                 
             \PY{k}{def} \PY{n+nf}{call}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{arrs}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} arrs (for arrays) is a list with }
                 \PY{c+c1}{\PYZsh{} [inputs=inp and the output of the previous layer=massout]}
                 \PY{c+c1}{\PYZsh{} inputs will be [n\PYZus{}sample, 154 = 30*5+4] with}
                 \PY{c+c1}{\PYZsh{} [QBP, QCBP, QIBP, TBP, VBP, PS, SOLIN, SHFLX, LHFLX]}
                 \PY{c+c1}{\PYZsh{} outputs of the previous dense layer will be [n\PYZus{}samples, 157 = 30*5+8\PYZhy{}1] with}
                 \PY{c+c1}{\PYZsh{} [DELQ, DELCLDLIQ, DELCLDICE, }
                 \PY{c+c1}{\PYZsh{} TPHYSTND\PYZbs{}\PYZob{}TPHYSTND AT LOWEST LVL\PYZcb{}, DTVKE,}
                 \PY{c+c1}{\PYZsh{} FSNT, FSNS, FLNT, FLNS, PRECT, PRECTEND, PRECST, PRECSTEN]}
                 
                 \PY{c+c1}{\PYZsh{} Split between the inputs inp \PYZam{} the output of the densely connected}
                 \PY{c+c1}{\PYZsh{} neural network, massout}
                 \PY{n}{inp}\PY{p}{,} \PY{n}{massout} \PY{o}{=} \PY{n}{arrs}
                 
                 \PY{c+c1}{\PYZsh{} 0) Constants}
                 \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
                 \PY{n}{L\PYZus{}F} \PY{o}{=} \PY{l+m+mf}{3.337e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of fusion of water [W.kg\PYZhy{}1]}
                 \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
                 \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
                 
                 \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
                 \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
                 \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
                 \PY{n}{PS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
                 \PY{n}{P} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                             \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{)}
                 \PY{n}{dP} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
                 \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                                   \PY{n}{G}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                      \PY{n}{L\PYZus{}V}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
                 \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 2) Calculate net energy input from phase change and precipitation}
                 \PY{c+c1}{\PYZsh{} PHAS = Lf/Lv*((PRECST+PRECSTEN)\PYZhy{}(PRECT+PRECTEND))}
                 \PY{n}{PHAS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                               \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{155}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{156}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                               \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{154}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                 \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                   \PY{n}{L\PYZus{}V}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 3) Calculate net energy input from radiation, sensible heat flux and turbulent KE}
                 \PY{c+c1}{\PYZsh{} 3.1) RAD = FSNT\PYZhy{}FSNS\PYZhy{}FLNT+FLNS}
                 \PY{n}{RAD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                               \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{149}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{151}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 3.2) Unnormalize sensible heat flux}
                 \PY{n}{SHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 3.3) Net turbulent kinetic energy dissipative heating is the column\PYZhy{}integrated }
                 \PY{c+c1}{\PYZsh{} turbulent kinetic energy energy dissipative heating}
                 \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{119}\PY{p}{:}\PY{l+m+mi}{149}\PY{p}{]}\PY{p}{)}
                 \PY{n}{KEDINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 4) Calculate tendency of normalized column water vapor due to phase change}
                 \PY{c+c1}{\PYZsh{} 4.1) Unnormalize latent heat flux}
                 \PY{n}{LHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 4.2) Column water vapor is the column integral of specific humidity}
                 \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
                 \PY{n}{PHQINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 4.3) Multiply by L\PYZus{}S/L\PYZus{}V to normalize (explanation above)}
                 \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                                  \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                    \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                      \PY{n}{L\PYZus{}V}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 5) Same operation for liquid water tendency but multiplied by L\PYZus{}F/L\PYZus{}V}
                 \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PYZbs{}
                                                     \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(}\PYZbs{}
                                                                    \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                                    \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                     \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                       \PY{n}{L\PYZus{}V}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 6) Same operation for temperature but only integrate from level 1 to level 29}
                 \PY{n}{DTINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} 7) Now calculate dT30 as a residual}
                 \PY{n}{dT30} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                                                                                   \PY{n}{PHAS}\PY{p}{,}\PY{n}{RAD}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                                           \PY{n}{SHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                                   \PY{n}{KEDINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                           \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(} \PY{n}{SPDQINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                   \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(} \PY{n}{SPDQCINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                           \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(} \PY{n}{DTINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                   \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
                 \PY{n}{dT30} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{dT30}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{n}{out} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{,} \PY{n}{dT30}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{119}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}
                 \PY{k}{return} \PY{n}{out}
             
             \PY{k}{def} \PY{n+nf}{compute\PYZus{}output\PYZus{}shape}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{k}{return} \PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} and is ready to be used in the cost function}
\end{Verbatim}


    \hypertarget{step-3-formulate-massenergy-conserving-model}{%
\paragraph{Step 3: Formulate mass/energy conserving
model}\label{step-3-formulate-massenergy-conserving-model}}

We start with inputs {[}QBP, QCBP, QIBP, TBP, VBP, PS, SOLIN, SHFLX,
LHFLX{]} of shape 154\\
We then have a few dense layers with size proportional to a power of 2

For now, there is no other ``physically-constraining'' layers than\\
the mass+energy conservation layers which take input of shape 156

After mass layer outputs vector of shape 157\\
After energy layer outputs final vector of shape 158\\
i.e. {[}PHQ, PHCLDLIQ, PHCLDICE, TPHYSTND, DTVKE, FSNT, FSNS, FLNT,
FLNS, PRECT, PRECTEND, PRECST, PRECSTEN{]}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}36}]:} \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
         \PY{n}{massout} \PY{o}{=} \PY{n}{MasConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{157}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{EntConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{157}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{158}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{massout}\PY{p}{]}\PY{p}{)}
         \PY{n}{model1} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}37}]:} \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 1/24/2019 \PYZhy{} Make layers bigger}
         \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
         \PY{n}{massout} \PY{o}{=} \PY{n}{MasConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{157}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{EntConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{157}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{158}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{massout}\PY{p}{]}\PY{p}{)}
         \PY{n}{model3} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}38}]:} \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 1/24/2019 \PYZhy{} Add more layers}
         \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
         \PY{n}{massout} \PY{o}{=} \PY{n}{MasConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{157}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{EntConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{157}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{158}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{massout}\PY{p}{]}\PY{p}{)}
         \PY{n}{model5} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}39}]:} \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 1/24/2019 \PYZhy{} Trying to overfit by adding indecent amount of layers}
         \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{16}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
         \PY{n}{massout} \PY{o}{=} \PY{n}{MasConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{157}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{EntConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{157}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{158}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{massout}\PY{p}{]}\PY{p}{)}
         \PY{n}{model\PYZus{}cons16l256n} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}52}]:} \PY{n}{model1}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{adam}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mse}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} careful, model resets the weights and biases}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}53}]:} \PY{n}{model1}\PY{o}{.}\PY{n}{summary}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
Layer (type)                    Output Shape         Param \#     Connected to                     
==================================================================================================
input\_1 (InputLayer)            (None, 154)          0                                            
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_1 (Dense)                 (None, 256)          39680       input\_1[0][0]                    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_2 (Dense)                 (None, 256)          65792       dense\_1[0][0]                    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_3 (Dense)                 (None, 256)          65792       dense\_2[0][0]                    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_4 (Dense)                 (None, 256)          65792       dense\_3[0][0]                    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_5 (Dense)                 (None, 256)          65792       dense\_4[0][0]                    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_6 (Dense)                 (None, 156)          40092       dense\_5[0][0]                    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
mas\_cons\_lay\_1 (MasConsLay)     (None, 157)          0           input\_1[0][0]                    
                                                                 dense\_6[0][0]                    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
ent\_cons\_lay\_1 (EntConsLay)     (None, 158)          0           input\_1[0][0]                    
                                                                 mas\_cons\_lay\_1[0][0]             
==================================================================================================
Total params: 342,940
Trainable params: 342,940
Non-trainable params: 0
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/4/2019 \PYZhy{} Got this from https://github.com/keras\PYZhy{}team/keras/issues/898}
        \PY{c+c1}{\PYZsh{} Goal is to experiment with the learning rate}
        \PY{c+c1}{\PYZsh{} https://towardsdatascience.com/learning\PYZhy{}rate\PYZhy{}schedules\PYZhy{}and\PYZhy{}adaptive\PYZhy{}learning\PYZhy{}rate\PYZhy{}methods\PYZhy{}for\PYZhy{}deep\PYZhy{}learning\PYZhy{}2c8f433990d1}
        \PY{c+c1}{\PYZsh{} is a little more comprehensive and gives some background on how/why to change the callbacks}
        \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{callbacks} \PY{k}{import} \PY{n}{LearningRateScheduler}
        
        \PY{k}{def} \PY{n+nf}{lr\PYZus{}decay\PYZus{}callback}\PY{p}{(}\PY{n}{lr\PYZus{}init}\PY{p}{,} \PY{n}{lr\PYZus{}decay}\PY{p}{)}\PY{p}{:}
            \PY{k}{def} \PY{n+nf}{step\PYZus{}decay}\PY{p}{(}\PY{n}{epoch}\PY{p}{)}\PY{p}{:}
                \PY{k}{return} \PY{n}{lr\PYZus{}init} \PY{o}{*} \PY{p}{(}\PY{n}{lr\PYZus{}decay} \PY{o}{*}\PY{o}{*} \PY{p}{(}\PY{n}{epoch} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}
            \PY{k}{return} \PY{n}{LearningRateScheduler}\PY{p}{(}\PY{n}{step\PYZus{}decay}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} Standard parameters for no decay would be lr\PYZus{}init=0.1 and lr\PYZus{}decay=1.0}
        \PY{c+c1}{\PYZsh{} Standard parameters for decay would be lr\PYZus{}init=0.1 and lr\PYZus{}decay=0.5}
        
        \PY{c+c1}{\PYZsh{}history1 = model1.fit\PYZus{}generator(gen, train\PYZus{}gen\PYZus{}obj.n\PYZus{}batches, epochs=5, \PYZbs{}}
        \PY{c+c1}{\PYZsh{}                     validation\PYZus{}data=validgen, validation\PYZus{}steps= valid\PYZus{}gen\PYZus{}obj.n\PYZus{}batches)}
        \PY{n}{lr\PYZus{}decay} \PY{o}{=}  \PY{n}{lr\PYZus{}decay\PYZus{}callback}\PY{p}{(}\PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.5}\PY{p}{)}
        \PY{n}{history1\PYZus{}test} \PY{o}{=} \PY{n}{model1}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PYZbs{}
                             \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PYZbs{}
                                            \PY{n}{callbacks}\PY{o}{=}\PY{p}{[}\PY{n}{lr\PYZus{}decay}\PY{p}{]}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}\PYZpc{}cd \PYZdl{}TRAINDIR/HDF5\PYZus{}DATA}
        \PY{c+c1}{\PYZsh{}!pwd}
        \PY{c+c1}{\PYZsh{}model\PYZus{}cons16l256n.save(\PYZsq{}model\PYZus{}cons16l256n.h5\PYZsq{})}
        
        \PY{c+c1}{\PYZsh{} tgb \PYZhy{} Jan2019 \PYZhy{} below is standard syntax for training}
        \PY{c+c1}{\PYZsh{}history1 = model1.fit\PYZus{}generator(gen, train\PYZus{}gen\PYZus{}obj.n\PYZus{}batches, epochs=20, \PYZbs{}}
        \PY{c+c1}{\PYZsh{}                     validation\PYZus{}data=validgen, validation\PYZus{}steps= valid\PYZus{}gen\PYZus{}obj.n\PYZus{}batches)}
        \PY{c+c1}{\PYZsh{}history3 = model3.fit\PYZus{}generator(gen, train\PYZus{}gen\PYZus{}obj.n\PYZus{}batches, epochs=20, \PYZbs{}}
        \PY{c+c1}{\PYZsh{}                     validation\PYZus{}data=validgen, validation\PYZus{}steps= valid\PYZus{}gen\PYZus{}obj.n\PYZus{}batches)}
        \PY{c+c1}{\PYZsh{}history5 = model5.fit\PYZus{}generator(gen, train\PYZus{}gen\PYZus{}obj.n\PYZus{}batches, epochs=20, \PYZbs{}}
        \PY{c+c1}{\PYZsh{}                     validation\PYZus{}data=validgen, validation\PYZus{}steps= valid\PYZus{}gen\PYZus{}obj.n\PYZus{}batches)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Epoch 1/5
9024/9024 [==============================] - 49s 5ms/step - loss: 2569.5509 - val\_loss: 2490.9732
Epoch 2/5
9024/9024 [==============================] - 48s 5ms/step - loss: 2569.5509 - val\_loss: 2490.9732
Epoch 3/5
9024/9024 [==============================] - 48s 5ms/step - loss: 2569.5509 - val\_loss: 2490.9732
Epoch 4/5
 521/9024 [>{\ldots}] - ETA: 41s - loss: 2566.4607
    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}109}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
          
          \PY{n}{hdict1} \PY{o}{=} \PY{n}{history1}\PY{o}{.}\PY{n}{history}
          \PY{n}{train\PYZus{}loss\PYZus{}values1} \PY{o}{=} \PY{n}{hdict1}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{valid\PYZus{}loss\PYZus{}values1} \PY{o}{=} \PY{n}{hdict1}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{epochs1} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values1}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
          \PY{n}{hdict3} \PY{o}{=} \PY{n}{history3}\PY{o}{.}\PY{n}{history}
          \PY{n}{train\PYZus{}loss\PYZus{}values3} \PY{o}{=} \PY{n}{hdict3}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{valid\PYZus{}loss\PYZus{}values3} \PY{o}{=} \PY{n}{hdict3}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{epochs3} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values3}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
          \PY{n}{hdict5} \PY{o}{=} \PY{n}{history5}\PY{o}{.}\PY{n}{history}
          \PY{n}{train\PYZus{}loss\PYZus{}values5} \PY{o}{=} \PY{n}{hdict5}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{valid\PYZus{}loss\PYZus{}values5} \PY{o}{=} \PY{n}{hdict5}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{epochs5} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values5}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
          
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs1}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bo}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Std Train loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs1}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{b}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Std Valid loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs3}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values3}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Larg Train loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs3}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values3}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Larg Valid loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs5}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values5}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{go}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{More Train loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs5}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values5}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{More Valid loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Training and validation loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Epochs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_62_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}175}]:} \PY{n}{pred1} \PY{o}{=} \PY{n}{model1}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{x}\PY{p}{)}
          \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
          \PY{n}{ind\PYZus{}test} \PY{o}{=} \PY{l+m+mi}{150}\PY{p}{;}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred1}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{nn}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{y}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}\PY{p}{;}
          \PY{n}{y}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{l+m+mi}{140}\PY{p}{:}\PY{p}{]}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}175}]:} array([ 1.18169428e-05,  5.12940278e-06,  5.17723674e-06,  2.36581513e-06,
                  4.79932132e-05,  2.03128881e-03,  3.00917514e-02,  3.25429067e-02,
                  6.41387748e-03,  4.12391014e-02,  1.00992456e+03,  7.46461365e+02,
                  2.68334381e+02,  4.53668709e+01,  2.91980400e+01, -9.99487591e+00,
                  0.00000000e+00, -7.88744539e-02], dtype=float32)
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_63_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{step-4-comparing-to-simple-dense-model-with-same-inputsoutputs}{%
\paragraph{Step 4: Comparing to simple dense model with same
inputs/outputs}\label{step-4-comparing-to-simple-dense-model-with-same-inputsoutputs}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}110}]:} \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
          \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
              \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{out} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
          \PY{n}{model2} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}111}]:} \PY{c+c1}{\PYZsh{} Larger layers}
          \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
          \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
              \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{out} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
          \PY{n}{model4} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}112}]:} \PY{c+c1}{\PYZsh{} More layers}
          \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
          \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{:}
              \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{out} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
          \PY{n}{model6} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}117}]:} \PY{c+c1}{\PYZsh{}model6.compile(\PYZsq{}adam\PYZsq{},\PYZsq{}mse\PYZsq{}) \PYZsh{} Careful, compile resets the weights/biases}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}118}]:} \PY{n}{model6}\PY{o}{.}\PY{n}{summary}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
Layer (type)                 Output Shape              Param \#   
=================================================================
input\_14 (InputLayer)        (None, 154)               0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_99 (Dense)             (None, 256)               39680     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_100 (Dense)            (None, 256)               65792     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_101 (Dense)            (None, 256)               65792     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_102 (Dense)            (None, 256)               65792     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_103 (Dense)            (None, 256)               65792     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_104 (Dense)            (None, 256)               65792     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_105 (Dense)            (None, 256)               65792     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_106 (Dense)            (None, 256)               65792     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_107 (Dense)            (None, 256)               65792     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_108 (Dense)            (None, 158)               40606     
=================================================================
Total params: 606,622
Trainable params: 606,622
Non-trainable params: 0
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}119}]:} \PY{n}{history2} \PY{o}{=} \PY{n}{model2}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PYZbs{}
                               \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
          \PY{n}{history4} \PY{o}{=} \PY{n}{model4}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PYZbs{}
                               \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
          \PY{n}{history6} \PY{o}{=} \PY{n}{model6}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PYZbs{}
                               \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Epoch 1/20
27456/27456 [==============================] - 132s 5ms/step - loss: 254.8290 - val\_loss: 228.2938
Epoch 2/20
27456/27456 [==============================] - 134s 5ms/step - loss: 237.9216 - val\_loss: 223.8188
Epoch 3/20
27456/27456 [==============================] - 141s 5ms/step - loss: 224.6774 - val\_loss: 207.9285
Epoch 4/20
27456/27456 [==============================] - 127s 5ms/step - loss: 217.5935 - val\_loss: 207.2040
Epoch 5/20
27456/27456 [==============================] - 134s 5ms/step - loss: 216.3367 - val\_loss: 206.0627
Epoch 6/20
27456/27456 [==============================] - 141s 5ms/step - loss: 215.0186 - val\_loss: 204.6537
Epoch 7/20
27456/27456 [==============================] - 130s 5ms/step - loss: 213.6840 - val\_loss: 204.6636
Epoch 8/20
27456/27456 [==============================] - 131s 5ms/step - loss: 213.0634 - val\_loss: 203.9233
Epoch 9/20
27456/27456 [==============================] - 131s 5ms/step - loss: 212.3221 - val\_loss: 204.1077
Epoch 10/20
27456/27456 [==============================] - 128s 5ms/step - loss: 211.8280 - val\_loss: 203.6896
Epoch 11/20
27456/27456 [==============================] - 134s 5ms/step - loss: 211.4066 - val\_loss: 203.5320
Epoch 12/20
27456/27456 [==============================] - 139s 5ms/step - loss: 210.9989 - val\_loss: 203.0081
Epoch 13/20
27456/27456 [==============================] - 135s 5ms/step - loss: 210.6738 - val\_loss: 203.1740
Epoch 14/20
27456/27456 [==============================] - 135s 5ms/step - loss: 210.3042 - val\_loss: 203.0579
Epoch 15/20
27456/27456 [==============================] - 125s 5ms/step - loss: 209.9924 - val\_loss: 202.9824
Epoch 16/20
27456/27456 [==============================] - 134s 5ms/step - loss: 209.7079 - val\_loss: 203.2689
Epoch 17/20
27456/27456 [==============================] - 126s 5ms/step - loss: 209.4349 - val\_loss: 202.8932
Epoch 18/20
27456/27456 [==============================] - 135s 5ms/step - loss: 209.1689 - val\_loss: 202.7902
Epoch 19/20
27456/27456 [==============================] - 138s 5ms/step - loss: 208.9480 - val\_loss: 202.8387
Epoch 20/20
27456/27456 [==============================] - 134s 5ms/step - loss: 208.6720 - val\_loss: 202.3915
Epoch 1/20
27456/27456 [==============================] - 136s 5ms/step - loss: 241.8231 - val\_loss: 214.5734
Epoch 2/20
27456/27456 [==============================] - 140s 5ms/step - loss: 223.4399 - val\_loss: 211.3960
Epoch 3/20
27456/27456 [==============================] - 132s 5ms/step - loss: 220.3301 - val\_loss: 209.9305
Epoch 4/20
27456/27456 [==============================] - 130s 5ms/step - loss: 218.1343 - val\_loss: 208.0124
Epoch 5/20
27456/27456 [==============================] - 134s 5ms/step - loss: 216.4469 - val\_loss: 207.1287
Epoch 6/20
27456/27456 [==============================] - 128s 5ms/step - loss: 215.1588 - val\_loss: 205.7393
Epoch 7/20
27456/27456 [==============================] - 134s 5ms/step - loss: 214.0751 - val\_loss: 205.7508
Epoch 8/20
27456/27456 [==============================] - 130s 5ms/step - loss: 213.3720 - val\_loss: 205.0338
Epoch 9/20
27456/27456 [==============================] - 126s 5ms/step - loss: 212.7680 - val\_loss: 204.7337
Epoch 10/20
27456/27456 [==============================] - 129s 5ms/step - loss: 212.2384 - val\_loss: 204.6541
Epoch 11/20
27456/27456 [==============================] - 128s 5ms/step - loss: 211.7604 - val\_loss: 204.6103
Epoch 12/20
27456/27456 [==============================] - 132s 5ms/step - loss: 211.3017 - val\_loss: 205.0367
Epoch 13/20
27456/27456 [==============================] - 125s 5ms/step - loss: 210.8821 - val\_loss: 204.7505
Epoch 14/20
27456/27456 [==============================] - 130s 5ms/step - loss: 210.3498 - val\_loss: 195.4005
Epoch 15/20
27456/27456 [==============================] - 126s 5ms/step - loss: 199.6243 - val\_loss: 195.8460
Epoch 16/20
27456/27456 [==============================] - 127s 5ms/step - loss: 199.3016 - val\_loss: 195.9353
Epoch 17/20
27456/27456 [==============================] - 130s 5ms/step - loss: 198.9298 - val\_loss: 195.4882
Epoch 18/20
27456/27456 [==============================] - 126s 5ms/step - loss: 198.6091 - val\_loss: 195.5865
Epoch 19/20
27456/27456 [==============================] - 135s 5ms/step - loss: 198.3011 - val\_loss: 195.4962
Epoch 20/20
27456/27456 [==============================] - 140s 5ms/step - loss: 197.3928 - val\_loss: 193.8799
Epoch 1/20
27456/27456 [==============================] - 160s 6ms/step - loss: 241.1933 - val\_loss: 218.0363
Epoch 2/20
27456/27456 [==============================] - 162s 6ms/step - loss: 222.5516 - val\_loss: 205.2984
Epoch 3/20
27456/27456 [==============================] - 168s 6ms/step - loss: 211.3974 - val\_loss: 202.5802
Epoch 4/20
27456/27456 [==============================] - 168s 6ms/step - loss: 209.4965 - val\_loss: 201.4255
Epoch 5/20
27456/27456 [==============================] - 165s 6ms/step - loss: 208.1722 - val\_loss: 200.2054
Epoch 6/20
27456/27456 [==============================] - 156s 6ms/step - loss: 207.0280 - val\_loss: 199.0375
Epoch 7/20
27456/27456 [==============================] - 158s 6ms/step - loss: 205.8333 - val\_loss: 198.2107
Epoch 8/20
27456/27456 [==============================] - 156s 6ms/step - loss: 205.1061 - val\_loss: 198.4954
Epoch 9/20
27456/27456 [==============================] - 161s 6ms/step - loss: 204.3882 - val\_loss: 197.5455
Epoch 10/20
27456/27456 [==============================] - 165s 6ms/step - loss: 203.8148 - val\_loss: 197.4828
Epoch 11/20
27456/27456 [==============================] - 160s 6ms/step - loss: 203.2920 - val\_loss: 196.7677
Epoch 12/20
27456/27456 [==============================] - 159s 6ms/step - loss: 202.8687 - val\_loss: 196.6748
Epoch 13/20
27456/27456 [==============================] - 163s 6ms/step - loss: 202.3789 - val\_loss: 196.5973
Epoch 14/20
27456/27456 [==============================] - 157s 6ms/step - loss: 201.9761 - val\_loss: 196.0573
Epoch 15/20
27456/27456 [==============================] - 161s 6ms/step - loss: 201.6324 - val\_loss: 196.0009
Epoch 16/20
27456/27456 [==============================] - 166s 6ms/step - loss: 201.3147 - val\_loss: 196.6319
Epoch 17/20
27456/27456 [==============================] - 162s 6ms/step - loss: 201.0341 - val\_loss: 196.0029
Epoch 18/20
27456/27456 [==============================] - 159s 6ms/step - loss: 200.7599 - val\_loss: 195.7547
Epoch 19/20
27456/27456 [==============================] - 163s 6ms/step - loss: 200.5238 - val\_loss: 195.3529
Epoch 20/20
27456/27456 [==============================] - 168s 6ms/step - loss: 200.2544 - val\_loss: 195.9580

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}120}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
          
          \PY{n}{hdict2} \PY{o}{=} \PY{n}{history2}\PY{o}{.}\PY{n}{history}
          \PY{n}{train\PYZus{}loss\PYZus{}values2} \PY{o}{=} \PY{n}{hdict2}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{valid\PYZus{}loss\PYZus{}values2} \PY{o}{=} \PY{n}{hdict2}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{epochs2} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values2}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
          \PY{n}{hdict4} \PY{o}{=} \PY{n}{history4}\PY{o}{.}\PY{n}{history}
          \PY{n}{train\PYZus{}loss\PYZus{}values4} \PY{o}{=} \PY{n}{hdict4}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{valid\PYZus{}loss\PYZus{}values4} \PY{o}{=} \PY{n}{hdict4}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{epochs4} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values4}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
          \PY{n}{hdict6} \PY{o}{=} \PY{n}{history6}\PY{o}{.}\PY{n}{history}
          \PY{n}{train\PYZus{}loss\PYZus{}values6} \PY{o}{=} \PY{n}{hdict6}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{valid\PYZus{}loss\PYZus{}values6} \PY{o}{=} \PY{n}{hdict6}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          \PY{n}{epochs6} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values6}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
          
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs2}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bo}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Std Train loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs2}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{b}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Std Valid loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs4}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values4}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Larg Train loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs4}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values4}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Larg Valid loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs6}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values6}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{go}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{More Train loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs6}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values6}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{More Valid loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Training and validation loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Epochs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_71_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}121}]:} \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{validgen}\PY{p}{)}
          \PY{n}{pred1} \PY{o}{=} \PY{n}{model1}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred2} \PY{o}{=} \PY{n}{model2}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred3} \PY{o}{=} \PY{n}{model3}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred4} \PY{o}{=} \PY{n}{model4}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred5} \PY{o}{=} \PY{n}{model5}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred6} \PY{o}{=} \PY{n}{model6}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
          \PY{n}{ind\PYZus{}test} \PY{o}{=} \PY{l+m+mi}{15}\PY{p}{;}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred1}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{nn1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred2}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{nn2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred3}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{nn3}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred4}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{nn4}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred5}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{nn5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred6}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{nn6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{y}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}\PY{p}{;}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_72_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{step-5-check-energy-and-mass-conservation-for-the-predictions}{%
\paragraph{Step 5: Check energy and mass conservation for the
predictions}\label{step-5-check-energy-and-mass-conservation-for-the-predictions}}

If we coded the mass/enthalpy conservation layers properly\\
pred1 from the mass/enthalpy-conserving model1 should conserve
mass/energy\\
pred2 which is a ``naive'' dense network should be close to conserving
mass/energy\\
The function below is directly adapted from the tested mass/enthalpy
conservation layers in numpy that have been used to develop the
tensorflow layers

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}122}]:} \PY{k}{def} \PY{n+nf}{massent\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{)}\PY{p}{:}
              \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
              \PY{c+c1}{\PYZsh{} 0) Constants}
              \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
              \PY{n}{L\PYZus{}F} \PY{o}{=} \PY{l+m+mf}{3.337e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of fusion of water [W.kg\PYZhy{}1]}
              \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
              \PY{n}{L\PYZus{}S} \PY{o}{=} \PY{n}{L\PYZus{}F}\PY{o}{+}\PY{n}{L\PYZus{}V}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of sublimation of water [W.kg\PYZhy{}1]}
              \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]   }
          
              \PY{c+c1}{\PYZsh{} WATER\PYZam{}ENTHALPY) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
              \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
              \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
              \PY{n}{PS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
              \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
              \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
              \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
              \PY{n}{dP} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
              \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
              \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
              \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                        \PY{n}{G}\PY{p}{)}\PY{p}{,}\PYZbs{}
              \PY{n}{L\PYZus{}V}\PY{p}{)}
              \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
              \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
          
              \PY{c+c1}{\PYZsh{} WATER.1) Calculate water vertical integral from level 1 to level 30}
              \PY{n}{WATVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]} \PY{o}{+} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]} \PY{o}{+} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}
              \PY{n}{WATINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{WATVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          
              \PY{c+c1}{\PYZsh{} WATER.2) Calculate forcing on the right\PYZhy{}hand side (Net Evaporation\PYZhy{}Precipitation)}
              \PY{c+c1}{\PYZsh{} E\PYZhy{}P is already normalized to units W.m\PYZhy{}2 in the output vector}
              \PY{c+c1}{\PYZsh{} so all we need to do is input\PYZhy{}unnormalize LHF that is taken from the input vector}
              \PY{n}{LHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}
              \PY{c+c1}{\PYZsh{} Note that total precipitation = PRECT + 1e\PYZhy{}3*PRECTEND in the CAM model}
              \PY{c+c1}{\PYZsh{} PRECTEND already multiplied by 1e\PYZhy{}3 in output vector so no need to redo it}
              \PY{n}{PREC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{154}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{155}\PY{p}{]}\PY{p}{)}
          
              \PY{c+c1}{\PYZsh{} WATER.FINAL) Residual = E\PYZhy{}P\PYZhy{}DWATER/DT}
              \PY{n}{WATRES} \PY{o}{=} \PY{n}{LHF}\PY{o}{\PYZhy{}}\PY{n}{PREC}\PY{o}{\PYZhy{}}\PY{n}{WATINT}
              
              \PY{c+c1}{\PYZsh{} ENTHALPY.1) Calculate net energy input from phase change and precipitation}
              \PY{c+c1}{\PYZsh{} PHAS = Lf/Lv*((PRECST+PRECSTEN)\PYZhy{}(PRECT+PRECTEND))}
              \PY{n}{PHAS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                    \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{156}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{157}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                    \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{154}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{155}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                            \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n}{L\PYZus{}V}\PY{p}{)}
              
              \PY{c+c1}{\PYZsh{} ENTHALPY.2) Calculate net energy input from radiation, sensible heat flux and turbulent KE}
              \PY{c+c1}{\PYZsh{} 2.1) RAD = FSNT\PYZhy{}FSNS\PYZhy{}FLNT+FLNS}
              \PY{n}{RAD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                      \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{151}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                      \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}\PY{p}{)}
              \PY{c+c1}{\PYZsh{} 2.2) Unnormalize sensible heat flux}
              \PY{n}{SHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}
              \PY{c+c1}{\PYZsh{} 2.3) Net turbulent kinetic energy dissipative heating is the column\PYZhy{}integrated }
              \PY{c+c1}{\PYZsh{} turbulent kinetic energy energy dissipative heating}
              \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
              \PY{n}{KEDINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
              
              \PY{c+c1}{\PYZsh{} ENTHALPY.3) Calculate tendency of normalized column water vapor due to phase change}
              \PY{c+c1}{\PYZsh{} 3.1) Column water vapor is the column integral of specific humidity}
              \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{PHQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
              \PY{c+c1}{\PYZsh{} 3.2) Multiply by L\PYZus{}S/L\PYZus{}V to normalize (explanation above)}
              \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                           \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                              \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                 \PY{n}{L\PYZus{}V}\PY{p}{)}
              
              \PY{c+c1}{\PYZsh{} ENTHALPY.4) Same operation for liquid water tendency but multiplied by L\PYZus{}F/L\PYZus{}V}
              \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PYZbs{}
                                            \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PYZbs{}
                                                   \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                   \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                            \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n}{L\PYZus{}V}\PY{p}{)}
              
              \PY{c+c1}{\PYZsh{} ENTHALPY.5) Same operation for temperature tendency}
              \PY{n}{DTINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
              
              \PY{c+c1}{\PYZsh{} ENTHALPY.FINAL) Residual = SPDQ+SPDQC+DTINT\PYZhy{}RAD\PYZhy{}SHF\PYZhy{}PHAS}
              \PY{n}{ENTRES} \PY{o}{=} \PY{n}{SPDQINT}\PY{o}{+}\PY{n}{SPDQCINT}\PY{o}{+}\PY{n}{DTINT}\PY{o}{\PYZhy{}}\PY{n}{RAD}\PY{o}{\PYZhy{}}\PY{n}{SHF}\PY{o}{\PYZhy{}}\PY{n}{PHAS}\PY{o}{\PYZhy{}}\PY{n}{KEDINT}
          
              \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
              \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
              \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
              
              \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
              
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{121}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{WATRES}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ Residual}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[W.m\PYZca{}}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZhy{}2\PYZcb{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
              
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{122}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{ENTRES}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Enthalpy}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ Residual}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[W.m\PYZca{}}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZhy{}2\PYZcb{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}135}]:} \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{validgen}\PY{p}{)}
          \PY{n}{pred1} \PY{o}{=} \PY{n}{model1}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred2} \PY{o}{=} \PY{n}{model2}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred3} \PY{o}{=} \PY{n}{model3}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred4} \PY{o}{=} \PY{n}{model4}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred5} \PY{o}{=} \PY{n}{model5}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
          \PY{n}{pred6} \PY{o}{=} \PY{n}{model6}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}136}]:} \PY{n}{massent\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{yval}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_76_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}144}]:} \PY{n}{massent\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{pred6}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_77_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}44}]:} \PY{n}{massent\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{pred2}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_78_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{step-6-check-positivity-of-water-species}{%
\paragraph{Step 6: Check positivity of water
species}\label{step-6-check-positivity-of-water-species}}

There are two necessary steps:\\
1) Load the water species concentrations ``before physics'' from the
input vector and unnormalize them\\
2) Invert the output normalization to get the water concentrations
``after physics''

\[
\delta q_{v,i,l}\left(p\right)=\frac{L_{v}\Delta p_{\mathrm{norm}}}{g}\frac{q_{v,i,l}^{a}\left(p\right)-q_{v,i,l}^{b}\left(p\right)}{\Delta t}\ \Rightarrow\ q_{v,i,l}^{a}\left(p\right)=q_{v,i,l}^{b}\left(p\right)+\frac{g\Delta t}{L_{v}\Delta p_{\mathrm{norm}}}\delta q_{v,i,l}\left(p\right)
\]

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}145}]:} \PY{k}{def} \PY{n+nf}{watpos\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{dt}\PY{o}{=}\PY{l+m+mi}{30}\PY{o}{*}\PY{l+m+mi}{60}\PY{p}{)}\PY{p}{:}
              
              \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
          
              \PY{c+c1}{\PYZsh{} 1) Extract water species concentrations from inputs}
              \PY{n}{QVB} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{QLB} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}
              \PY{n}{QSB} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}
          
              \PY{c+c1}{\PYZsh{} 2) Inverse output normalization and get water concentration after physics}
              \PY{n}{QVA} \PY{o}{=} \PY{n}{QVB} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dt}\PY{o}{*}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]} \PY{p}{,} \PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{QLA} \PY{o}{=} \PY{n}{QLB} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dt}\PY{o}{*}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]} \PY{p}{,} \PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{QSA} \PY{o}{=} \PY{n}{QSB} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dt}\PY{o}{*}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]} \PY{p}{,} \PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
          
              \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
              \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
              \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{231}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{n}{QVA}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ vapor}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ concentration}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{232}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{n}{QLA}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Liquid}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ concentration}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{233}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{n}{QSA}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Ice}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ concentration}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
              
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{234}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{p}{(}\PY{n}{QVA}\PY{o}{\PYZhy{}}\PY{n}{QVB}\PY{p}{)}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ vapor}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ change}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{235}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{p}{(}\PY{n}{QLA}\PY{o}{\PYZhy{}}\PY{n}{QLB}\PY{p}{)}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Liquid}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ change}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{236}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{p}{(}\PY{n}{QSA}\PY{o}{\PYZhy{}}\PY{n}{QSB}\PY{p}{)}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Ice}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ change}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
              
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplots\PYZus{}adjust}\PY{p}{(}\PY{n}{left}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{bottom}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{wspace}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{hspace}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}146}]:} \PY{n}{watpos\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{yval}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{dt}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_81_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}154}]:} \PY{n}{watpos\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{pred6}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{dt}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_82_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}78}]:} \PY{n}{watpos\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{pred2}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{dt}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_83_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{last-step-save-trained-models-as-h5-files}{%
\paragraph{Last step: Save trained models as h5
files}\label{last-step-save-trained-models-as-h5-files}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}165}]:} \PY{o}{\PYZpc{}}\PY{k}{cd} \PYZdl{}TRAINDIR/HDF5\PYZus{}DATA
          \PY{o}{!}pwd
          \PY{n}{model1}\PY{o}{.}\PY{n}{save}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{model1.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{model2}\PY{o}{.}\PY{n}{save}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{model2.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{model3}\PY{o}{.}\PY{n}{save}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{model3.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{model4}\PY{o}{.}\PY{n}{save}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{model4.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{model5}\PY{o}{.}\PY{n}{save}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{model5.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{model6}\PY{o}{.}\PY{n}{save}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{model6.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/data/Tom.Beucler/SPCAM\_PHYS/HDF5\_DATA
/data/Tom.Beucler/SPCAM\_PHYS/HDF5\_DATA

    \end{Verbatim}

    \hypertarget{side-step-debugging}{%
\paragraph{Side step: Debugging}\label{side-step-debugging}}

\hypertarget{mass-conservation-layer-in-numpy}{%
\subparagraph{Mass conservation layer in
Numpy}\label{mass-conservation-layer-in-numpy}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}189}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
          \PY{k+kn}{import} \PY{n+nn}{copy}
          \PY{n}{x}\PY{p}{,} \PY{n}{y} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)}
          \PY{n}{inp} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{;}
          \PY{n}{ycop} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{y}\PY{p}{)}\PY{p}{;}
          \PY{n}{densout} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{ycop}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,}\PY{n}{ycop}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{,}\PY{n}{ycop}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{120}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{n}{densout}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} 0) Constants}
          \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
          \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
          \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
          \PY{n}{ind\PYZus{}test} \PY{o}{=} \PY{l+m+mi}{59}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference index to test        }
              
          \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
          \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
          \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
          \PY{n}{PS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
          \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                  \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
          \PY{n}{dP} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dP=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{dP}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
          \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                            \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                             \PY{n}{G}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
                  \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
                  \PY{c+c1}{\PYZsh{} Wondering about broadcasting here...}
                  \PY{c+c1}{\PYZsh{} tf.div or simply \PYZbs{} would support broadcasting }
          \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dP\PYZus{}TILD=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
                  
                  \PY{c+c1}{\PYZsh{} 2) Calculate cloud water vertical integral from level 1 to level 30}
                  \PY{c+c1}{\PYZsh{} The indices are tricky here because we are missing del(q\PYZus{}v)@(level 30)}
                  \PY{c+c1}{\PYZsh{} so e.g. q\PYZus{}liq@(level 1) is the 30th element of the output of the }
                  \PY{c+c1}{\PYZsh{} previous dense layer}
          \PY{n}{CLDVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PYZbs{}
                                            \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{:}\PY{l+m+mi}{59}\PY{p}{]}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{59}\PY{p}{:}\PY{l+m+mi}{89}\PY{p}{]}\PY{p}{)}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{CLDVEC=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{CLDVEC}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
          \PY{n}{CLDINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{CLDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{CLDINT=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{CLDINT}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{p}{)}
                  
                  \PY{c+c1}{\PYZsh{} 3) Calculate water vapor vertical integral from level 1 to level 29}
          \PY{n}{VAPVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                            \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{VAPVEC=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{VAPVEC}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
          \PY{n}{VAPINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{VAPVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{VAPINT=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{VAPINT}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{p}{)}
                  
                  \PY{c+c1}{\PYZsh{} 4) Calculate forcing on the right\PYZhy{}hand side (Net Evaporation\PYZhy{}Precipitation)}
                  \PY{c+c1}{\PYZsh{} E\PYZhy{}P is already normalized to units W.m\PYZhy{}2 in the output vector}
                  \PY{c+c1}{\PYZsh{} so all we need to do is input\PYZhy{}unnormalize LHF that is taken from the input vector}
          \PY{n}{LHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}
          \PY{n}{SHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{LHF=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{LHF}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{p}{)}
                  \PY{c+c1}{\PYZsh{} Note that total precipitation = PRECT + 1e\PYZhy{}3*PRECTEND in the CAM model}
                  \PY{c+c1}{\PYZsh{} PRECTEND already multiplied by 1e\PYZhy{}3 in output vector so no need to redo it}
          \PY{c+c1}{\PYZsh{} Modification 3 here !!!!!!!!!!!!!}
          \PY{n}{PREC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} !!!!!!!!!!!!!!!! Careful with indices after adding TKE dissipation}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PREC=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{PREC}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{E\PYZhy{}P=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{LHF}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{PREC}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{E\PYZhy{}P\PYZhy{}CLDINT\PYZhy{}VAPINT=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{LHF}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{PREC}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{CLDINT}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{VAPINT}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{p}{)}
                  \PY{c+c1}{\PYZsh{} 5) Infer water vapor tendency at level 30 as a residual}
                  \PY{c+c1}{\PYZsh{} Use add\PYZus{}n to be able to add multiple variables}
          \PY{c+c1}{\PYZsh{} Modification 2 here !!!!!!!!!!!!!!!!!!!!!!!!}
          \PY{n}{DELQV30} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{LHF}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{PREC}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{CLDINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{VAPINT}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                           \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} !!!!!!!!!!!!!!!!!!!!!!!!!!}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{DELQV30=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{DELQV30}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{p}{)}
                  
                  \PY{c+c1}{\PYZsh{} 6) Concatenate the water tendencies with the newly inferred tendency}
                  \PY{c+c1}{\PYZsh{} to get the final vector out of shape (\PYZsh{}samples,125) with}
                  \PY{c+c1}{\PYZsh{} [DELQ, DELCLDLIQ, DELCLDICE, }
                  \PY{c+c1}{\PYZsh{} TPHYSTND\PYZbs{}\PYZob{}TPHYSTND AT SURFACE\PYZcb{}, FSNT, FSNS, FLNT, FLNS, PRECT PRECTEND]}
                  \PY{c+c1}{\PYZsh{} Uses https://www.tensorflow.org/api\PYZus{}docs/python/tf/concat}
          \PY{c+c1}{\PYZsh{} Modification 1 here!!!!!!!!!!!!!!!!!!!!!}
          \PY{n}{DELQV30} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{DELQV30}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} !!!!!!!!!!!!!!!!!!!!!!!!!}
          \PY{n+nb}{print}\PY{p}{(}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{:}\PY{p}{]}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
          \PY{n}{out} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,} \PY{n}{DELQV30}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{y}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} Should be 0}
          
          \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
          \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{29}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Residual (W.m\PYZca{}}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZhy{}2\PYZcb{})}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZsh{} of samples}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
(512, 156)
dP= [ 277.64523402  512.62555644  839.73696455 1211.38058603 1519.8353678
 1745.60062587 1737.79353499 1423.96241426 1675.21685362 1970.80597281
 2318.55362654 2727.6545763  3197.7786471  3762.02087322 4425.8228367
 5206.75274756 6125.47004496 7206.30310716 8477.84052202 8481.23433368
 7784.10646187 6568.77660212 4882.00930607 2826.34901551 2651.61580947
 2455.40763694 2238.96767435 2003.63136295 1751.24040859 1484.55609408]
dP\_TILD= [1.         1.00000001 1.00000003 0.99999998 1.00000003 1.00000002
 1.00000004 1.00000001 1.00000003 1.00000003 0.99999996 1.00000001
 0.99651969 0.99651967 0.99651971 0.99651962 0.99651965 0.99651971
 0.99651979 0.99651972 0.99651965 0.9965197  0.99651979 0.99651977
 0.99651979 0.99651965 0.99651973 0.99651972 0.99651968 0.99716217]
CLDVEC= [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00 -2.01829318e-02 -4.04875675e-04
 -1.24406984e-13  0.00000000e+00 -4.54874583e-03 -4.70635920e-02
  4.15789425e-01 -1.56063280e+00 -1.29520629e+00  1.86089540e+00
  7.86679466e-01  7.64881946e-02]
CLDINT= 0.21181325305724952
VAPVEC= [ 0.00000000e+00  0.00000000e+00 -7.22653271e-06  7.36196517e-06
 -2.18848751e-05  1.81146647e-05  3.45948472e-06  6.31680114e-07
  2.13570304e-06  2.47899637e-06  1.25387563e-04 -1.31903349e-04
 -5.79337804e-04  9.73641240e-04 -4.67346337e-03  4.52160660e-03
 -3.71324193e-02  3.00382706e-01 -8.99144243e-01 -5.65429841e-01
  2.39909258e+00  7.29378195e-02 -5.35054990e+00  3.84908059e+00
  2.26981845e+00 -7.13247702e-03 -2.91737946e+00  3.15153636e-01
 -1.47380316e+00]
VAPINT= -2.04386471915228
LHF= 23.281357
PREC= 26.041534
E-P= -2.7601776
E-P-CLDINT-VAPINT= -0.928126146209657
DELQV30= -0.9307675089060945
(512, 29)
(512, 127)
[0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 1.81539658e-06 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00]

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}189}]:} Text(0, 0.5, '\# of samples')
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_87_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{fmse-conservation-layer-in-numpy}{%
\subparagraph{FMSE conservation layer in
Numpy}\label{fmse-conservation-layer-in-numpy}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}151}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
          \PY{k+kn}{import} \PY{n+nn}{copy}
          \PY{n}{x}\PY{p}{,} \PY{n}{y} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)}
          \PY{n}{inp} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{;}
          \PY{n}{ycop} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{y}\PY{p}{)}\PY{p}{;}
          \PY{n}{massout} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{ycop}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{,}\PY{n}{ycop}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{120}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
          
          \PY{c+c1}{\PYZsh{} 0) Constants}
          \PY{n}{dt} \PY{o}{=} \PY{l+m+mi}{1800}\PY{p}{;} \PY{c+c1}{\PYZsh{} Timestep [s]}
          \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
          \PY{n}{L\PYZus{}F} \PY{o}{=} \PY{l+m+mf}{3.337e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of fusion of water [W.kg\PYZhy{}1]}
          \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
          \PY{n}{L\PYZus{}S} \PY{o}{=} \PY{n}{L\PYZus{}F}\PY{o}{+}\PY{n}{L\PYZus{}V}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of sublimation}
          \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
          \PY{n}{ind\PYZus{}test} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{;}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}truth=\PYZsq{},y[ind\PYZus{}test,:])}
                  
                  \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
                  \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
                  \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
          \PY{n}{PS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
                  \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
          \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                  \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
          \PY{n}{dP} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                  \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
          \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                            \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                             \PY{n}{G}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
                  \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
          \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}dP\PYZus{}TILD=\PYZsq{},dP\PYZus{}TILD[ind\PYZus{}test,:])}
                  
          \PY{c+c1}{\PYZsh{} 2) Calculate net energy input from phase change and precipitation}
          \PY{c+c1}{\PYZsh{} PHAS = Lf/Lv*((PRECST+PRECSTEN)\PYZhy{}(PRECT+PRECTEND))}
          \PY{n}{PHAS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                    \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{155}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{156}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                    \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{154}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                       \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                          \PY{n}{L\PYZus{}V}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}Check PHAS=\PYZsq{},PHAS[ind\PYZus{}test])}
          
          \PY{c+c1}{\PYZsh{} 3) Calculate net energy input from radiation, sensible heat flux and turbulent KE}
          \PY{c+c1}{\PYZsh{} 3.1) RAD = FSNT\PYZhy{}FSNS\PYZhy{}FLNT+FLNS}
          \PY{n}{RAD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                      \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{149}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                      \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{151}\PY{p}{]}\PY{p}{)}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}Check RAD=\PYZsq{},RAD[ind\PYZus{}test])}
          \PY{c+c1}{\PYZsh{} 3.2) Unnormalize sensible heat flux}
          \PY{n}{SHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}Check SHF=\PYZsq{},SHF[ind\PYZus{}test])}
          \PY{c+c1}{\PYZsh{} 3.3) Net turbulent kinetic energy dissipative heating is the column\PYZhy{}integrated }
          \PY{c+c1}{\PYZsh{} turbulent kinetic energy energy dissipative heating}
          \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{119}\PY{p}{:}\PY{l+m+mi}{149}\PY{p}{]}\PY{p}{)}
          \PY{n}{KEDINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}Check KEDINT=\PYZsq{},KEDINT[ind\PYZus{}test])}
          
          \PY{c+c1}{\PYZsh{} 4) Calculate tendency of normalized column water vapor due to phase change}
          \PY{c+c1}{\PYZsh{} 4.1) Unnormalize latent heat flux}
          \PY{n}{LHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}Check LHF=\PYZsq{},LHF[ind\PYZus{}test])}
          \PY{c+c1}{\PYZsh{} 4.2) Column water vapor is the column integral of specific humidity}
          \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
          \PY{n}{PHQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} 4.3) Multiply by L\PYZus{}S/L\PYZus{}V to normalize (explanation above)}
          \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                       \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                          \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PYZbs{}
                             \PY{n}{L\PYZus{}V}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}Check SPDQINT=\PYZsq{},SPDQINT[ind\PYZus{}test])}
          
          \PY{c+c1}{\PYZsh{} 5) Same operation for liquid water tendency but multiplied by L\PYZus{}F/L\PYZus{}V}
          \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PYZbs{}
                                            \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PYZbs{}
                                                   \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                   \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                            \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n}{L\PYZus{}V}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}Check SPDQCINT=\PYZsq{},SPDQCINT[ind\PYZus{}test])}
          
          \PY{c+c1}{\PYZsh{} 6) Same operation for temperature but only integrate from level 1 to level 29}
          \PY{n}{SPDTINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}Check SPDTINT=\PYZsq{},SPDTINT[ind\PYZus{}test])}
          
          \PY{c+c1}{\PYZsh{} 7) Now calculate dT30 as a residual}
          \PY{n}{dT30} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                                                                    \PY{n}{PHAS}\PY{p}{,}\PY{n}{RAD}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                             \PY{n}{SHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                       \PY{n}{KEDINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                               \PY{n}{np}\PY{o}{.}\PY{n}{negative}\PY{p}{(} \PY{n}{SPDQINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{negative}\PY{p}{(} \PY{n}{SPDQCINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                 \PY{n}{np}\PY{o}{.}\PY{n}{negative}\PY{p}{(} \PY{n}{SPDTINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                          \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
          \PY{n}{dT30} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{dT30}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
          
          \PY{n}{out} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{,} \PY{n}{dT30}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{119}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{y}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} Should be 0}
          
                  \PY{c+c1}{\PYZsh{} 2) Calculate latent heat vertical integral from level 1 to level 30}
          \PY{c+c1}{\PYZsh{}LATVEC = np.multiply( dP\PYZus{}TILD, \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                  np.add( \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                    massout[:, :30], \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                    np.divide( np.multiply( L\PYZus{}F, \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                    np.negative(massout[:, 60:90])), L\PYZus{}V)))}
          \PY{c+c1}{\PYZsh{}LATVEC = np.multiply( dP\PYZus{}TILD, \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                  np.add( \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                    np.divide( np.multiply( L\PYZus{}S, \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                    y[:, :30]), L\PYZus{}V), \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                    np.divide( np.multiply( L\PYZus{}F, \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                    y[:, 30:60]), L\PYZus{}V)))}
          \PY{c+c1}{\PYZsh{}LATINT = np.sum( LATVEC, axis=1)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}LATVEC=\PYZsq{},LATVEC[ind\PYZus{}test,:])}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}LATINT=\PYZsq{},LATINT[ind\PYZus{}test])}
          \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{} Functional energy routine for comparison \PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
          \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
          \PY{n}{PHQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{n}{LHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}LHF=\PYZsq{},LHF[ind\PYZus{}test])}
          \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}SPDQINT\PYZsq{},SPDQINT[ind\PYZus{}test],\PYZsq{}=PHQINT\PYZsq{},PHQINT[ind\PYZus{}test],\PYZsq{}\PYZhy{}LHF\PYZsq{},LHF[ind\PYZus{}test])}
          
          \PY{n}{PHCVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}
          \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{PHCVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}SPDQCINT\PYZsq{},SPDQCINT[ind\PYZus{}test])}
                  \PY{c+c1}{\PYZsh{} 3) Calculate sensible heat vertical integral from level 1 to level 29}
                  \PY{c+c1}{\PYZsh{} The temperature tendency is contained in }
                  \PY{c+c1}{\PYZsh{} the 91st to 119th element of the output vector}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}KEDVEC=\PYZsq{},KEDVEC[ind\PYZus{}test,:])    }
          \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
          \PY{n}{KEDINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}KEDINT=\PYZsq{},KEDINT[ind\PYZus{}test])}
          \PY{n}{SHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}SHF=\PYZsq{},SHF[ind\PYZus{}test])}
          \PY{n}{SW} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{151}\PY{p}{]}\PY{p}{)}
          \PY{n}{LW} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}\PY{p}{;}
          \PY{n}{SENVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{)}
          \PY{n}{SENINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{SENVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}SENINT29 = np.sum( np.multiply (dP\PYZus{}TILD[:, :29], y[:, 90:119]), axis=1)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}SENINT29=\PYZsq{},SENINT29[ind\PYZus{}test])}
          \PY{n}{SPDTINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{SENINT}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{KEDINT}\PY{p}{,} \PY{n}{SHF}\PY{p}{)}\PY{p}{,} \PY{n}{SW}\PY{p}{)}\PY{p}{,} \PY{n}{LW}\PY{p}{)}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}RAD=\PYZsq{},LW[ind\PYZus{}test]+SW[ind\PYZus{}test])}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}SPDTINT\PYZsq{},SPDTINT[ind\PYZus{}test],\PYZsq{}=DTPHYSINT\PYZsq{},SENINT[ind\PYZus{}test],\PYZbs{}}
          \PY{c+c1}{\PYZsh{}     \PYZsq{}\PYZhy{}SHF\PYZsq{},SHF[ind\PYZus{}test],\PYZsq{}\PYZhy{}KED\PYZsq{},KEDINT[ind\PYZus{}test],\PYZsq{}\PYZhy{}SW\PYZsq{},SW[ind\PYZus{}test],\PYZsq{}\PYZhy{}LW\PYZsq{},LW[ind\PYZus{}test])}
                  
          \PY{c+c1}{\PYZsh{} Renormalize}
          \PY{n}{SPDQINT\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{SPDQINT}\PY{p}{,} \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}SPDQINT\PYZus{}NORM=\PYZsq{},SPDQINT\PYZus{}NORM[ind\PYZus{}test])}
          \PY{n}{SPDQCINT\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{SPDQCINT}\PY{p}{,} \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}SPDQCINT\PYZus{}NORM=\PYZsq{},SPDQCINT\PYZus{}NORM[ind\PYZus{}test])}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}SPDQINT\PYZus{}NORM\PYZsq{},SPDQINT\PYZus{}NORM[ind\PYZus{}test],\PYZsq{} \PYZam{} SPDQCINT\PYZus{}NORM\PYZsq{},SPDQCINT\PYZus{}NORM[ind\PYZus{}test])}
                  \PY{c+c1}{\PYZsh{} 4) Calculate forcing on the right\PYZhy{}hand side (Net radiation + surface ent. fluxes)}
                  \PY{c+c1}{\PYZsh{} RHS = SHF+LHF}
                  \PY{c+c1}{\PYZsh{} !!!! Modification 1 : Unnormalize LHF and SHF !!!!!!!!!}
          
          \PY{c+c1}{\PYZsh{} Should I multiply LHF by LS/LV?}
          
          \PY{n}{LIQ} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{154}\PY{p}{]}\PY{o}{+}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{155}\PY{p}{]}\PY{p}{,} \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)} \PY{c+c1}{\PYZsh{} Fallout of liquid precip}
          \PY{n}{ICE} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{156}\PY{p}{]}\PY{o}{+}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{157}\PY{p}{]}\PY{p}{,} \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)} \PY{c+c1}{\PYZsh{} Conversion liq\PYZhy{}\PYZgt{}ice}
          \PY{n}{SINK} \PY{o}{=} \PY{n}{ICE}\PY{o}{\PYZhy{}}\PY{n}{LIQ}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}SINK=\PYZsq{},SINK[ind\PYZus{}test],\PYZsq{}=ICE\PYZsq{},ICE[ind\PYZus{}test],\PYZsq{}\PYZhy{}LIQ\PYZsq{},LIQ[ind\PYZus{}test])}
          
          \PY{n}{RESID} \PY{o}{=} \PY{n}{SPDQINT\PYZus{}NORM}\PY{o}{+}\PY{n}{SPDQCINT\PYZus{}NORM}\PY{o}{+}\PY{n}{SPDTINT}\PY{o}{\PYZhy{}}\PY{n}{SINK}
          \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{RESID}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{RESID}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{]}\PY{p}{)}
                  \PY{c+c1}{\PYZsh{} 5) Infer temperature tendency at level 30 as a residual}
                  \PY{c+c1}{\PYZsh{} Composites np.add twice because not sure how to use np.add\PYZus{}n}
          \PY{c+c1}{\PYZsh{}DELT30 = np.divide( \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                np.add(np.add( \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                   RHS,np.negative(LATINT)), \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                   np.negative(SENINT)), \PYZbs{}}
          \PY{c+c1}{\PYZsh{}                                dP\PYZus{}TILD[:, 29])}
          \PY{c+c1}{\PYZsh{}print(\PYZsq{}DELT30=\PYZsq{},DELT30[ind\PYZus{}test])        }
                  \PY{c+c1}{\PYZsh{} 6) Concatenate the water tendencies with the newly inferred tendency}
                  \PY{c+c1}{\PYZsh{} to get the final vector out of shape (\PYZsh{}samples,126) with}
                  \PY{c+c1}{\PYZsh{} [DELQ, DELCLDLIQ, DELCLDICE, }
                  \PY{c+c1}{\PYZsh{} TPHYSTND, FSNT, FSNS, FLNT, FLNS, PRECT PRECTEND]}
                  \PY{c+c1}{\PYZsh{} Uses https://www.tensorflow.org/api\PYZus{}docs/python/tf/concat}
          \PY{c+c1}{\PYZsh{}DELT30 = np.expand\PYZus{}dims(DELT30,1)}
          \PY{c+c1}{\PYZsh{}out = np.concatenate([massout[:, :119], DELT30, massout[:, 119:]], 1)}
          \PY{c+c1}{\PYZsh{}print(out[ind\PYZus{}test,:]\PYZhy{}y[ind\PYZus{}test,:]) \PYZsh{} Should be 0}
          \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
          \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{out}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{119}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Residual (W.m\PYZca{}}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZhy{}2\PYZcb{})}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZsh{} of samples}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
[ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00 -1.89548166e-05
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  0.00000000e+00  0.00000000e+00]
RESID 1.5543037363840995e-06

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}151}]:} Text(0, 0.5, '\# of samples')
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_89_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{a-simple-example}{%
\subsubsection{3.1) A simple example}\label{a-simple-example}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}21}]:} \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{act} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{124}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{7}\PY{p}{)}\PY{p}{:}
             \PY{n}{act} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{124}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{act}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{125}\PY{p}{)}\PY{p}{(}\PY{n}{act}\PY{p}{)}
         \PY{n}{model1} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}22}]:} \PY{n}{model1}\PY{o}{.}\PY{n}{summary}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
Layer (type)                 Output Shape              Param \#   
=================================================================
input\_1 (InputLayer)         (None, 154)               0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_1 (Dense)              (None, 124)               19220     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_2 (Dense)              (None, 124)               15500     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_3 (Dense)              (None, 124)               15500     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_4 (Dense)              (None, 124)               15500     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_5 (Dense)              (None, 124)               15500     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_6 (Dense)              (None, 124)               15500     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_7 (Dense)              (None, 124)               15500     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_8 (Dense)              (None, 124)               15500     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_9 (Dense)              (None, 125)               15625     
=================================================================
Total params: 143,345
Trainable params: 143,345
Non-trainable params: 0
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}23}]:} \PY{n}{model1}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{adam}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{loss}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mse}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}24}]:} \PY{n}{model1}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{10}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Epoch 1/10
9024/9024 [==============================] - 46s 5ms/step - loss: 302.7223
Epoch 2/10
9024/9024 [==============================] - 40s 4ms/step - loss: 214.0051
Epoch 3/10
2746/9024 [========>{\ldots}] - ETA: 27s - loss: 214.7549
    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]

        ---------------------------------------------------------------------------

        KeyboardInterrupt                         Traceback (most recent call last)

        <ipython-input-24-e9938f4c8c15> in <module>
    ----> 1 model1.fit\_generator(gen, train\_gen\_obj.n\_batches, epochs=10)
    

        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/keras/legacy/interfaces.py in wrapper(*args, **kwargs)
         89                 warnings.warn('Update your `' + object\_name +
         90                               '` call to the Keras 2 API: ' + signature, stacklevel=2)
    ---> 91             return func(*args, **kwargs)
         92         wrapper.\_original\_function = func
         93         return wrapper


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/keras/engine/training.py in fit\_generator(self, generator, steps\_per\_epoch, epochs, verbose, callbacks, validation\_data, validation\_steps, class\_weight, max\_queue\_size, workers, use\_multiprocessing, shuffle, initial\_epoch)
       2228                     outs = self.train\_on\_batch(x, y,
       2229                                                sample\_weight=sample\_weight,
    -> 2230                                                class\_weight=class\_weight)
       2231 
       2232                     if not isinstance(outs, list):


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/keras/engine/training.py in train\_on\_batch(self, x, y, sample\_weight, class\_weight)
       1881             ins = x + y + sample\_weights
       1882         self.\_make\_train\_function()
    -> 1883         outputs = self.train\_function(ins)
       1884         if len(outputs) == 1:
       1885             return outputs[0]


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/keras/backend/tensorflow\_backend.py in \_\_call\_\_(self, inputs)
       2480         session = get\_session()
       2481         updated = session.run(fetches=fetches, feed\_dict=feed\_dict,
    -> 2482                               **self.session\_kwargs)
       2483         return updated[:len(self.outputs)]
       2484 


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py in run(self, fetches, feed\_dict, options, run\_metadata)
        927     try:
        928       result = self.\_run(None, fetches, feed\_dict, options\_ptr,
    --> 929                          run\_metadata\_ptr)
        930       if run\_metadata:
        931         proto\_data = tf\_session.TF\_GetBuffer(run\_metadata\_ptr)


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py in \_run(self, handle, fetches, feed\_dict, options, run\_metadata)
       1150     if final\_fetches or final\_targets or (handle and feed\_dict\_tensor):
       1151       results = self.\_do\_run(handle, final\_targets, final\_fetches,
    -> 1152                              feed\_dict\_tensor, options, run\_metadata)
       1153     else:
       1154       results = []


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py in \_do\_run(self, handle, target\_list, fetch\_list, feed\_dict, options, run\_metadata)
       1326     if handle is None:
       1327       return self.\_do\_call(\_run\_fn, feeds, fetches, targets, options,
    -> 1328                            run\_metadata)
       1329     else:
       1330       return self.\_do\_call(\_prun\_fn, handle, feeds, fetches)


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py in \_do\_call(self, fn, *args)
       1332   def \_do\_call(self, fn, *args):
       1333     try:
    -> 1334       return fn(*args)
       1335     except errors.OpError as e:
       1336       message = compat.as\_text(e.message)


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py in \_run\_fn(feed\_dict, fetch\_list, target\_list, options, run\_metadata)
       1317       self.\_extend\_graph()
       1318       return self.\_call\_tf\_sessionrun(
    -> 1319           options, feed\_dict, fetch\_list, target\_list, run\_metadata)
       1320 
       1321     def \_prun\_fn(handle, feed\_dict, fetch\_list):


        \textasciitilde{}/miniconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py in \_call\_tf\_sessionrun(self, options, feed\_dict, fetch\_list, target\_list, run\_metadata)
       1405     return tf\_session.TF\_SessionRun\_wrapper(
       1406         self.\_session, options, feed\_dict, fetch\_list, target\_list,
    -> 1407         run\_metadata)
       1408 
       1409   def \_call\_tf\_sessionprun(self, handle, feed\_dict, fetch\_list):


        KeyboardInterrupt: 

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}17}]:} \PY{n}{preds} \PY{o}{=} \PY{n}{model1}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{x}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}18}]:} \PY{n}{preds}\PY{o}{.}\PY{n}{shape}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}18}]:} (512, 125)
\end{Verbatim}
            
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}19}]:} \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{preds}\PY{p}{[}\PY{l+m+mi}{413}\PY{p}{]}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{y}\PY{p}{[}\PY{l+m+mi}{413}\PY{p}{]}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{predicted}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
         \PY{n}{y}\PY{p}{[}\PY{l+m+mi}{413}\PY{p}{,}\PY{p}{]}
         \PY{c+c1}{\PYZsh{}plt.axis([0,50,\PYZhy{}50,20])}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}19}]:} array([ 0.0000000e+00,  0.0000000e+00,  1.1683633e-04, -1.8150534e-04,
                 2.8191236e-05, -1.2674624e-04,  3.2557498e-04, -2.3665362e-04,
                 1.0368231e-04,  4.4764183e-04,  9.7565079e-04,  6.6266386e-03,
                -2.4458408e-02,  7.7702858e-02, -7.9534091e-02, -3.0769283e-01,
                -2.9614696e-01, -3.2436770e-01, -1.4933038e+01,  1.1325694e+02,
                 1.1042747e+02, -1.3367409e+02, -9.7812202e+01, -1.2961019e+01,
                -2.1165226e+01, -3.0767555e+01, -1.5683941e+01,  6.6389933e+00,
                -3.9723598e+01, -5.9443699e+01,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  2.3594544e+00,  6.4320625e+01, -2.1832945e+01,
                -4.4953237e+00,  2.9705560e+00, -4.5950494e+00, -4.7523217e+00,
                -2.3259480e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  6.7914357e+00,
                -9.1242599e-01,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  0.0000000e+00,  0.0000000e+00,
                 0.0000000e+00,  0.0000000e+00,  2.2326913e+00,  2.9884062e+00,
                -1.8307689e+00,  1.0012641e+01,  2.5623555e+00,  1.5332817e+00,
                 6.9164151e-01,  1.0984515e+00, -3.7742987e-01,  8.3896631e-01,
                 9.7346652e-01, -2.2580650e+00,  1.6124072e+00, -6.2127047e+00,
                 4.7848113e-02, -3.7017672e+00, -8.1943054e+00, -8.1561766e+00,
                -1.0749043e+01, -2.3681652e+01,  1.1091612e+02,  1.3565686e+02,
                 8.6316261e+01,  1.8346081e+01,  1.0180499e+01,  1.3182677e+01,
                 1.2943122e+01,  1.5314125e+01,  1.7463171e+01,  5.1009412e+00,
                 7.9701630e+02,  5.8561182e+02,  2.6385580e+02,  7.4926163e+01,
                 2.2884337e+02], dtype=float32)
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_97_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{implement-energy-conservation-layer-first-attempt-focused-on-positivity}{%
\subsubsection{3.2) Implement energy conservation layer: First attempt
focused on
positivity}\label{implement-energy-conservation-layer-first-attempt-focused-on-positivity}}

tgb - 1/18/2019 - The hard constraint on q made the optimization problem
much much harder Two conclusions are: (1) Try to keep it soft
constraints for optimization (2) Maybe predict delta(after-before)
physics to avoid getting too different values in the vectors \#\#\#\#
Step 0: Load input's normalization separately

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}17}]:} \PY{n}{ds} \PY{o}{=} \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{TRAINDIR} \PY{o}{+} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{32\PYZus{}col\PYZus{}mp\PYZus{}3d\PYZus{}train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ds}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}17}]:} <xarray.Dataset>
         Dimensions:              (feature\_lev: 154, target\_lev: 125)
         Coordinates:
           * feature\_lev          (feature\_lev) int64 0 1 2 3 4 5 {\ldots} 149 150 151 152 153
           * target\_lev           (target\_lev) int64 0 1 2 3 4 5 {\ldots} 120 121 122 123 124
         Data variables:
             feature\_means        (feature\_lev) float32 {\ldots}
             feature\_stds         (feature\_lev) float32 {\ldots}
             feature\_mins         (feature\_lev) float32 {\ldots}
             feature\_maxs         (feature\_lev) float32 {\ldots}
             target\_means         (target\_lev) float32 {\ldots}
             target\_stds          (target\_lev) float32 {\ldots}
             target\_mins          (target\_lev) float32 {\ldots}
             target\_maxs          (target\_lev) float32 {\ldots}
             feature\_names        (feature\_lev) object {\ldots}
             target\_names         (target\_lev) object {\ldots}
             feature\_stds\_by\_var  (feature\_lev) float32 {\ldots}
             target\_conv          (target\_lev) float32 {\ldots}
\end{Verbatim}
            
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}18}]:} \PY{n}{fsub} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}means}\PY{o}{.}\PY{n}{values}
         \PY{n}{fdiv} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{o}{.}\PY{n}{values}
         \PY{n}{normq} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}\PY{o}{.}\PY{n}{values}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{fsub}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{fdiv}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{normq}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
(154,)
(154,)
(125,)

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}19}]:} \PY{n}{ds}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \hypertarget{step-1-test-the-physical-constraint-layer-in-numpy-for-basic-debugging}{%
\paragraph{Step 1: Test the physical constraint layer in Numpy for basic
debugging}\label{step-1-test-the-physical-constraint-layer-in-numpy-for-basic-debugging}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}69}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
         \PY{n}{a} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,}\PY{p}{)}
         \PY{n}{a}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{1}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}69}]:} 157
\end{Verbatim}
            
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}24}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
         \PY{k}{def} \PY{n+nf}{safe\PYZus{}softplus}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{limit}\PY{o}{=}\PY{l+m+mi}{30}\PY{p}{)}\PY{p}{:}
           \PY{k}{if} \PY{n}{x}\PY{o}{\PYZgt{}}\PY{n}{limit}\PY{p}{:}
             \PY{k}{return} \PY{n}{x}
           \PY{k}{else}\PY{p}{:}
             \PY{k}{return} \PY{n}{np}\PY{o}{.}\PY{n}{log}\PY{p}{(}\PY{l+m+mf}{1.0} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{exp}\PY{p}{(}\PY{n}{x}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}25}]:} \PY{n+nb}{print}\PY{p}{(}\PY{n}{qap}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{fsub}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]

        ---------------------------------------------------------------------------

        NameError                                 Traceback (most recent call last)

        <ipython-input-25-71007347a76f> in <module>
    ----> 1 print(qap.shape)
          2 print(fsub.shape)


        NameError: name 'qap' is not defined

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}100}]:} \PY{n}{x}\PY{p}{,} \PY{n}{y} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)} \PY{c+c1}{\PYZsh{} (Input,Output) pair retrieved iteratively from the generator}
          \PY{n}{testinp} \PY{o}{=} \PY{n}{x}\PY{p}{;} \PY{n}{testdensout} \PY{o}{=} \PY{n}{y}\PY{p}{;}  \PY{c+c1}{\PYZsh{} The output of the densely connected layer,}
          \PY{c+c1}{\PYZsh{} which is the input for the physical constraints layer, has shape (125,)=y.shape}
          \PY{n}{qbp} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{testinp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{,}\PY{n}{fdiv}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{,}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{n}{fsub}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{,}\PY{p}{]}\PY{p}{)}
          \PY{n}{index} \PY{o}{=} \PY{l+m+mi}{5}
          \PY{n+nb}{print}\PY{p}{(}\PY{n}{qbp}\PY{p}{[}\PY{n}{index}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} Bound on dq/dt}
          \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{,}\PY{p}{]}\PY{p}{,}\PY{n}{qbp}\PY{p}{[}\PY{n}{index}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{1800}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
[1.8890089e-06 1.8709759e-06 1.7035223e-06 1.7005252e-06 1.6415983e-06
 1.5045957e-06 1.4606607e-06 1.4591218e-06 1.4598600e-06 1.4735780e-06
 1.5066166e-06 1.5988817e-06 2.0526277e-06 4.9225710e-06 1.0806412e-05
 2.0793159e-05 5.1943964e-05 1.3326522e-04 2.4402043e-04 3.3523864e-04
 6.6088326e-04 1.1144076e-03 1.5189773e-03 1.8160637e-03 2.0421566e-03
 2.2358480e-03 2.4027592e-03 2.5413563e-03 2.7411170e-03 2.9877913e-03
 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
 1.7347235e-18 0.0000000e+00 0.0000000e+00 2.2737368e-13 0.0000000e+00
 0.0000000e+00 9.0949470e-13 9.5405994e-09 4.6377809e-06 1.5204386e-05
 1.5759480e-05 4.7640169e-06 1.4436255e-06 1.9511208e-07 5.5640478e-05
 1.2481135e-09 1.0923745e-09 6.6391337e-14 0.0000000e+00 0.0000000e+00
 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
 0.0000000e+00 1.0792442e-06 2.3847208e-06 2.8053364e-07 4.9385562e-10
 3.5487983e-07 5.8079468e-07 2.8306499e-06 1.6917746e-05 1.9704165e-05
 1.1375946e-05 1.6043600e-06 1.7757384e-07 2.1891026e-08 6.0673920e-06]

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}100}]:} array([7.4313283e-02, 1.3589725e-01, 2.0269047e-01, 2.9188102e-01,
                 3.5351321e-01, 3.7214047e-01, 3.5965800e-01, 2.9439625e-01,
                 3.4651691e-01, 4.1148993e-01, 4.9495089e-01, 6.1794227e-01,
                 9.3328631e-01, 2.6331131e+00, 6.8003597e+00, 1.5393726e+01,
                 4.5240860e+01, 1.3654811e+02, 2.9414923e+02, 4.0426810e+02,
                 7.3145874e+02, 1.0408422e+03, 1.0544020e+03, 7.2981561e+02,
                 7.6993835e+02, 7.8058862e+02, 7.6491705e+02, 7.2400189e+02,
                 6.8254248e+02, 6.3026514e+02, 0.0000000e+00, 0.0000000e+00,
                 0.0000000e+00, 0.0000000e+00, 0.0000000e+00, 0.0000000e+00,
                 0.0000000e+00, 0.0000000e+00, 0.0000000e+00, 0.0000000e+00,
                 0.0000000e+00, 0.0000000e+00, 0.0000000e+00, 0.0000000e+00,
                 0.0000000e+00, 1.2842618e-12, 0.0000000e+00, 0.0000000e+00,
                 2.7408277e-07, 0.0000000e+00, 0.0000000e+00, 8.4945623e-07,
                 6.6226311e-03, 1.8637701e+00, 5.7323909e+00, 5.5020161e+00,
                 1.5166223e+00, 4.1127157e-01, 4.8583217e-02, 1.1737184e+01,
                 4.9100567e-05, 7.9343990e-05, 7.8994509e-09, 0.0000000e+00,
                 0.0000000e+00, 0.0000000e+00, 0.0000000e+00, 0.0000000e+00,
                 0.0000000e+00, 0.0000000e+00, 0.0000000e+00, 0.0000000e+00,
                 0.0000000e+00, 0.0000000e+00, 0.0000000e+00, 0.0000000e+00,
                 9.3997324e-01, 2.4434664e+00, 3.3816332e-01, 5.9554609e-04,
                 3.9277732e-01, 5.4245466e-01, 1.9649028e+00, 6.7986798e+00,
                 7.4289074e+00, 3.9716182e+00, 5.1074719e-01, 5.0588656e-02,
                 5.4508997e-03, 1.2798972e+00], dtype=float32)
\end{Verbatim}
            
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}109}]:} \PY{c+c1}{\PYZsh{} SOFTPLUS}
          \PY{k+kn}{import} \PY{n+nn}{copy}
          \PY{n}{qap} \PY{o}{=} \PY{n}{copy}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{testdensout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{n}{qap}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{n}{qap}\PY{p}{[}\PY{l+m+mi}{5}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
          \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{qap}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:}
              \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{n}{qap}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                  \PY{n}{qap}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{n}{j}\PY{p}{]} \PY{o}{=} \PY{n}{safe\PYZus{}softplus}\PY{p}{(}\PY{n}{qap}\PY{p}{[}\PY{n}{i}\PY{p}{,}\PY{n}{j}\PY{p}{]}\PY{p}{)}
          \PY{n+nb}{print}\PY{p}{(}\PY{n}{qap}\PY{p}{,}\PY{n}{qap}\PY{o}{.}\PY{n}{shape}\PY{p}{)}          
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
[[ 0.00000000e+00  0.00000000e+00 -3.52463167e-06 {\ldots}  7.14828730e-01
  -1.94745120e-02 -5.09016812e-01]
 [ 0.00000000e+00  0.00000000e+00 -3.91810636e-06 {\ldots} -8.12336057e-02
   1.09404393e-01 -2.64686853e-01]
 [ 0.00000000e+00  0.00000000e+00 -3.83413817e-06 {\ldots}  2.25569099e-01
  -5.04336655e-02 -1.75489992e-01]
 {\ldots}
 [ 0.00000000e+00  0.00000000e+00 -4.57383749e-06 {\ldots}  4.15254906e-02
   3.08697671e-01 -1.18188016e-01]
 [ 0.00000000e+00  0.00000000e+00 -5.56462510e-06 {\ldots}  8.04110393e-02
  -4.38176608e-03  3.40724625e-02]
 [ 0.00000000e+00  0.00000000e+00 -5.02103740e-06 {\ldots} -5.38274534e-02
  -2.09472924e-01 -1.75753996e-01]]
[ 0.0000000e+00  0.0000000e+00 -3.1418069e-06 -3.6398256e-07
  3.0054719e-06 -1.6221151e-05  8.7531935e-06  1.2292489e-05
  1.0967176e-05 -6.3576708e-06  3.7818052e-07 -2.8339788e-04
 -1.0227459e-03 -2.1273026e-03 -3.6572393e-02  2.8603417e-03
 -2.7998945e-01 -4.5961341e-01  9.0005070e-01  6.8134266e-01
 -8.2287771e-01  2.3013981e-01  2.4323208e+00 -8.4881544e-01
 -2.9298425e+00 -4.2743530e+00 -6.0948601e+00 -3.7398868e+00
 -7.9316592e+00  2.2475309e+00  0.0000000e+00  0.0000000e+00
  0.0000000e+00  0.0000000e+00  0.0000000e+00  0.0000000e+00
  0.0000000e+00  0.0000000e+00  0.0000000e+00  0.0000000e+00
  0.0000000e+00  0.0000000e+00  0.0000000e+00  0.0000000e+00
  0.0000000e+00  0.0000000e+00  0.0000000e+00  0.0000000e+00
  0.0000000e+00  0.0000000e+00  0.0000000e+00  0.0000000e+00
 -6.6228681e-03  2.7891830e-01 -2.1353826e-01 -3.2629719e-01
  1.7228601e+00  2.1396577e+00  2.6639417e-01  1.4741515e-01
  0.0000000e+00  0.0000000e+00 -7.9088540e-09  0.0000000e+00
  0.0000000e+00  0.0000000e+00  0.0000000e+00  0.0000000e+00
  0.0000000e+00  0.0000000e+00  0.0000000e+00  0.0000000e+00
  0.0000000e+00  0.0000000e+00  0.0000000e+00  0.0000000e+00
  2.2770013e-01 -3.7225777e-01 -7.2824322e-02  1.2946053e-05
 -3.2056555e-01 -3.0137960e-02 -1.0958794e+00  4.8559111e-01
  1.8252365e-01 -2.3702376e-01  5.0828320e-01  2.0182897e-01
 -5.4508969e-03 -2.7768889e-02]
[[0.6931472  0.6931472  0.6931454  {\ldots} 1.1131188  0.6834573  0.47068232]
 [0.6931472  0.6931472  0.6931452  {\ldots} 0.653355   0.7493448  0.5695357 ]
 [0.6931472  0.6931472  0.6931453  {\ldots} 0.8122785  0.66824824 0.60924685]
 {\ldots}
 [0.6931472  0.6931472  0.69314486 {\ldots} 0.71412545 0.85936075 0.6357982 ]
 [0.6931472  0.6931472  0.6931444  {\ldots} 0.7341607  0.6909587  0.7103285 ]
 [0.6931472  0.6931472  0.6931447  {\ldots} 0.6665956  0.5938856  0.6091264 ]] (512, 90)

    \end{Verbatim}

    \hypertarget{step-2-rigorously-implement-the-physical-constraint-layer-in-tensorflow}{%
\paragraph{Step 2: Rigorously implement the physical constraint layer in
tensorflow}\label{step-2-rigorously-implement-the-physical-constraint-layer-in-tensorflow}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}143}]:} \PY{k}{class} \PY{n+nc}{PositiveConstraintLayer}\PY{p}{(}\PY{n}{Layer}\PY{p}{)}\PY{p}{:}
              
              \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}\PY{p}{:}
                  \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n+nf+fm}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}
                  
              \PY{k}{def} \PY{n+nf}{build}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                  \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{build}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{)}  \PY{c+c1}{\PYZsh{} Be sure to call this somewhere!}
                  
              \PY{k}{def} \PY{n+nf}{call}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{inp}\PY{p}{)}\PY{p}{:}
                  \PY{c+c1}{\PYZsh{} inputs will be [n\PYZus{}samples, 125 = 30*4+5] with }
                  \PY{c+c1}{\PYZsh{} [PHQ, PHCLDLIQ, PHCLDICE, TPHYSTND, FSNT, FSNS, FLNT, FLNS, PRECT]}
                  
                  \PY{c+c1}{\PYZsh{} SOFTPLUS PART}
                  \PY{n}{qap} \PY{o}{=} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}
                  \PY{n}{remain} \PY{o}{=} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{p}{]}
                  \PY{c+c1}{\PYZsh{} softplus on x\PYZus{}q}
                  \PY{n}{qap} \PY{o}{=} \PY{n}{K}\PY{o}{.}\PY{n}{softplus}\PY{p}{(}\PY{n}{qap}\PY{p}{)}
                  
                  \PY{c+c1}{\PYZsh{} Concat out}
                  \PY{n}{out} \PY{o}{=} \PY{n}{K}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{qap}\PY{p}{,} \PY{n}{remain}\PY{p}{]}\PY{p}{)}
                  
                  \PY{k}{return} \PY{n}{out}
              
              \PY{k}{def} \PY{n+nf}{compute\PYZus{}output\PYZus{}shape}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                  \PY{k}{return} \PY{n}{input\PYZus{}shape}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}144}]:} \PY{k}{class} \PY{n+nc}{CloudTendencyLayer}\PY{p}{(}\PY{n}{Layer}\PY{p}{)}\PY{p}{:}
              
              \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{p}{,} \PY{n}{dt}\PY{o}{=}\PY{l+m+mi}{30}\PY{o}{*}\PY{l+m+mi}{60}\PY{p}{,} \PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}\PY{p}{:}
                  \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub} \PY{o}{=} \PY{n}{fsub} 
                  \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv} \PY{o}{=} \PY{n}{fdiv}
                  \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq} \PY{o}{=} \PY{n}{normq}
                  \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dt} \PY{o}{=} \PY{n}{dt}
                  \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n+nf+fm}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}
                  
              \PY{k}{def} \PY{n+nf}{build}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                  \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{build}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{)}  \PY{c+c1}{\PYZsh{} Be sure to call this somewhere!}
                  
              \PY{k}{def} \PY{n+nf}{call}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{arrs}\PY{p}{)}\PY{p}{:}
                  \PY{c+c1}{\PYZsh{} arrs (for arrays) is a list with }
                  \PY{c+c1}{\PYZsh{} [inputs and the output of the previous layer]}
                  \PY{c+c1}{\PYZsh{} inputs will be [n\PYZus{}sample, 154 = 30*5+4] with}
                  \PY{c+c1}{\PYZsh{} [QBP, QCBP, QIBP, TBP, VBP, PS, SOLIN, SHFLX, LHFLX]}
                  \PY{c+c1}{\PYZsh{} outputs will be [n\PYZus{}samples, 125 = 30*4+5] with }
                  \PY{c+c1}{\PYZsh{} [PHQ, PHCLDLIQ, PHCLDICE, TPHYSTND, FSNT, FSNS, FLNT, FLNS, PRECT]}
                  
                  \PY{c+c1}{\PYZsh{} Split between the inputs inp \PYZam{} the output of the densely connected}
                  \PY{c+c1}{\PYZsh{} neural network, densout}
                  \PY{n}{inp}\PY{p}{,} \PY{n}{densout} \PY{o}{=} \PY{n}{arrs}
                  
                  \PY{c+c1}{\PYZsh{} Identify qap and rest of vector}
                  \PY{n}{qap} \PY{o}{=} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}
                  \PY{n}{remain} \PY{o}{=} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{p}{]}
                  
                  \PY{c+c1}{\PYZsh{} OPTION 1}
                  \PY{c+c1}{\PYZsh{} 1) Unnormalize qbp}
                  \PY{n}{qbp} \PY{o}{=} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}
                  \PY{n}{qbp} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{qbp}\PY{p}{,}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{,}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{,}\PY{p}{]}\PY{p}{)}
                  \PY{c+c1}{\PYZsh{} 2) Calculate temporal difference}
                  \PY{n}{diff} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{n}{qap}\PY{p}{,}\PY{n}{qbp}\PY{p}{)}\PY{p}{,}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dt}\PY{p}{)}
                  \PY{c+c1}{\PYZsh{} 3) Normalize the temporal difference according to output\PYZsq{}s normalization}
                  \PY{n}{diff} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{diff}\PY{p}{,}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{,}\PY{p}{]}\PY{p}{)}
                  
                  \PY{c+c1}{\PYZsh{} Concat out}
                  \PY{n}{out} \PY{o}{=} \PY{n}{K}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{diff}\PY{p}{,} \PY{n}{remain}\PY{p}{]}\PY{p}{)}
                  
                  \PY{k}{return} \PY{n}{out}
              
              \PY{k}{def} \PY{n+nf}{compute\PYZus{}output\PYZus{}shape}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                  \PY{k}{return} \PY{n}{input\PYZus{}shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}60}]:} \PY{k}{class} \PY{n+nc}{PhysicalConstraintLayer}\PY{p}{(}\PY{n}{Layer}\PY{p}{)}\PY{p}{:}
             
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{p}{,} \PY{n}{dt}\PY{o}{=}\PY{l+m+mi}{30}\PY{o}{*}\PY{l+m+mi}{60}\PY{p}{,} \PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub} \PY{o}{=} \PY{n}{fsub} 
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv} \PY{o}{=} \PY{n}{fdiv}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq} \PY{o}{=} \PY{n}{normq}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dt} \PY{o}{=} \PY{n}{dt}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n+nf+fm}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{build}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{build}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{)}  \PY{c+c1}{\PYZsh{} Be sure to call this somewhere!}
                 
             \PY{k}{def} \PY{n+nf}{call}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{arrs}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} arrs (for arrays) is a list with }
                 \PY{c+c1}{\PYZsh{} [inputs and the output of the previous layer]}
                 \PY{c+c1}{\PYZsh{} inputs will be [n\PYZus{}sample, 154 = 30*5+4] with}
                 \PY{c+c1}{\PYZsh{} [QBP, QCBP, QIBP, TBP, VBP, PS, SOLIN, SHFLX, LHFLX]}
                 \PY{c+c1}{\PYZsh{} outputs will be [n\PYZus{}samples, 125 = 30*4+5] with }
                 \PY{c+c1}{\PYZsh{} [PHQ, PHCLDLIQ, PHCLDICE, TPHYSTND, FSNT, FSNS, FLNT, FLNS, PRECT]}
                 
                 \PY{c+c1}{\PYZsh{} Split between the inputs inp \PYZam{} the output of the densely connected}
                 \PY{c+c1}{\PYZsh{} neural network, densout}
                 \PY{n}{inp}\PY{p}{,} \PY{n}{densout} \PY{o}{=} \PY{n}{arrs}
                 
                 \PY{c+c1}{\PYZsh{} SOFTPLUS PART}
                 \PY{n}{qap} \PY{o}{=} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}
                 \PY{n}{remain} \PY{o}{=} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{p}{]}
                 \PY{c+c1}{\PYZsh{} softplus on x\PYZus{}q, then multiply by 10\PYZca{}\PYZhy{}3 for order of magnitude}
                 \PY{n}{qap} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{l+m+mf}{1e\PYZhy{}3}\PY{p}{,}\PY{n}{K}\PY{o}{.}\PY{n}{relu}\PY{p}{(}\PY{n}{qap}\PY{p}{)}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} FROM Q TO DQ/DT}
                 \PY{c+c1}{\PYZsh{} OPTION 1}
                 \PY{c+c1}{\PYZsh{} 1) Unnormalize qbp}
                 \PY{n}{qbp} \PY{o}{=} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}
                 \PY{n}{qbp} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{qbp}\PY{p}{,}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{,}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{,}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 2) Calculate temporal difference}
                 \PY{n}{diff} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{n}{qap}\PY{p}{,}\PY{n}{qbp}\PY{p}{)}\PY{p}{,}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dt}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 3) Normalize the temporal difference according to output\PYZsq{}s normalization}
                 \PY{n}{diff} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{math}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{diff}\PY{p}{,}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{,}\PY{p}{]}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} OPTION 2}
                 \PY{c+c1}{\PYZsh{} 1) Normalize qap}
                 \PY{c+c1}{\PYZsh{}qap = tf.math.divide(tf.math.subtract(qap,self.fsub[:90,]),self.fdiv[:90,])}
                 \PY{c+c1}{\PYZsh{} 2) Calculate temporal difference}
                 \PY{c+c1}{\PYZsh{}qbp = inp[:, :90]}
                 \PY{c+c1}{\PYZsh{}diff = tf.math.divide(tf.math.subtract(qap,qbp),self.dt)}
                 \PY{c+c1}{\PYZsh{} 3) Unnormalize dq/dt}
                 \PY{c+c1}{\PYZsh{}diff = tf.math.multiply(diff,self.fdiv[:90,])}
                 \PY{c+c1}{\PYZsh{} 4) Normalize the temporal difference according to output\PYZsq{}s normalization}
                 \PY{c+c1}{\PYZsh{}diff = tf.math.multiply(diff,self.normq[:90,])}
                 
                 \PY{c+c1}{\PYZsh{} Concat out}
                 \PY{n}{out} \PY{o}{=} \PY{n}{K}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{[}\PY{n}{diff}\PY{p}{,} \PY{n}{remain}\PY{p}{]}\PY{p}{)}
                 
                 \PY{k}{return} \PY{n}{out}
             
             \PY{k}{def} \PY{n+nf}{compute\PYZus{}output\PYZus{}shape}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{k}{return} \PY{n}{input\PYZus{}shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}61}]:} \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{125}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{PhysicalConstraintLayer}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{125}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
         \PY{n}{m} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}146}]:} \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{154}\PY{p}{,}\PY{p}{)}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
          \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
              \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{125}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{PositiveConstraintLayer}\PY{p}{(}
              \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{125}\PY{p}{,}\PY{p}{)}
          \PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{out} \PY{o}{=} \PY{n}{CloudTendencyLayer}\PY{p}{(}
              \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{125}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}
          \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
          \PY{n}{m} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}64}]:} \PY{n}{m}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{adam}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mse}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}65}]:} \PY{n}{m}\PY{o}{.}\PY{n}{summary}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
Layer (type)                    Output Shape         Param \#     Connected to                     
==================================================================================================
input\_8 (InputLayer)            (None, 154)          0                                            
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_43 (Dense)                (None, 256)          39680       input\_8[0][0]                    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_44 (Dense)                (None, 256)          65792       dense\_43[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_45 (Dense)                (None, 256)          65792       dense\_44[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_46 (Dense)                (None, 256)          65792       dense\_45[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_47 (Dense)                (None, 256)          65792       dense\_46[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_48 (Dense)                (None, 125)          32125       dense\_47[0][0]                   
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
physical\_constraint\_layer\_8 (Ph (None, 125)          0           input\_8[0][0]                    
                                                                 dense\_48[0][0]                   
==================================================================================================
Total params: 334,973
Trainable params: 334,973
Non-trainable params: 0
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}75}]:} \PY{n}{m}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{18}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Epoch 1/18
9024/9024 [==============================] - 32s 4ms/step - loss: 955.1480
Epoch 2/18
9024/9024 [==============================] - 32s 4ms/step - loss: 901.2071
Epoch 3/18
9024/9024 [==============================] - 35s 4ms/step - loss: 869.4739
Epoch 4/18
9024/9024 [==============================] - 35s 4ms/step - loss: 865.2605
Epoch 5/18
9024/9024 [==============================] - 35s 4ms/step - loss: 879.6664
Epoch 6/18
9024/9024 [==============================] - 36s 4ms/step - loss: 831.5987
Epoch 7/18
9024/9024 [==============================] - 35s 4ms/step - loss: 792.0738
Epoch 8/18
9024/9024 [==============================] - 35s 4ms/step - loss: 836.7333
Epoch 9/18
9024/9024 [==============================] - 36s 4ms/step - loss: 858.6139
Epoch 10/18
9024/9024 [==============================] - 36s 4ms/step - loss: 788.8702
Epoch 11/18
9024/9024 [==============================] - 36s 4ms/step - loss: 801.9747
Epoch 12/18
9024/9024 [==============================] - 36s 4ms/step - loss: 796.7849
Epoch 13/18
9024/9024 [==============================] - 36s 4ms/step - loss: 802.8593
Epoch 14/18
9024/9024 [==============================] - 35s 4ms/step - loss: 769.9501
Epoch 15/18
9024/9024 [==============================] - 35s 4ms/step - loss: 778.1322
Epoch 16/18
9024/9024 [==============================] - 35s 4ms/step - loss: 777.9330
Epoch 17/18
9024/9024 [==============================] - 32s 4ms/step - loss: 748.8775
Epoch 18/18
9024/9024 [==============================] - 32s 3ms/step - loss: 816.3657

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}75}]:} <keras.callbacks.History at 0x7f1a5c5128d0>
\end{Verbatim}
            
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}76}]:} \PY{n}{preds} \PY{o}{=} \PY{n}{m}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{x}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}77}]:} \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{preds}\PY{p}{[}\PY{l+m+mi}{510}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{nn}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{y}\PY{p}{[}\PY{l+m+mi}{510}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}\PY{p}{;}
         \PY{c+c1}{\PYZsh{}plt.axis([0,50,\PYZhy{}100,100])}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_118_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    TODO: Validation


    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
