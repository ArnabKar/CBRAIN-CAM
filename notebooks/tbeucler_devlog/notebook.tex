
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatability definitions
    \def\gt{>}
    \def\lt{<}
    % Document parameters
    \title{002\_Add\_large\_scale\_as\_inputs}
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \hypertarget{preprocess-all-the-necessary-variables}{%
\subsection{1) Preprocess all the necessary
variables}\label{preprocess-all-the-necessary-variables}}

\hypertarget{build-feature-target-and-initial-normalization-files}{%
\subsubsection{1.1) Build feature, target and initial normalization
files}\label{build-feature-target-and-initial-normalization-files}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}77}]:} \PY{c+ch}{\PYZsh{}!ln \PYZhy{}s /filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/cbrain \PYZbs{}}
         \PY{c+c1}{\PYZsh{}/filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/notebooks/tbeucler\PYZus{}devlog/cbrain}
         \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{imports} \PY{k}{import} \PY{o}{*}
         \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{data\PYZus{}generator} \PY{k}{import} \PY{o}{*}
         \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{n}{MasConsLay}
         \PY{k+kn}{from} \PY{n+nn}{cbrain}\PY{n+nn}{.}\PY{n+nn}{utils} \PY{k}{import} \PY{n}{limit\PYZus{}mem}
         \PY{k+kn}{import} \PY{n+nn}{tensorflow} \PY{k}{as} \PY{n+nn}{tf}
         \PY{k+kn}{import} \PY{n+nn}{tensorflow}\PY{n+nn}{.}\PY{n+nn}{math} \PY{k}{as} \PY{n+nn}{tfm}
         \PY{k+kn}{import} \PY{n+nn}{xarray} \PY{k}{as} \PY{n+nn}{xr}
         \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
         \PY{c+c1}{\PYZsh{} Otherwise tensorflow will use ALL your GPU RAM for no reason}
         \PY{n}{limit\PYZus{}mem}\PY{p}{(}\PY{p}{)}
         \PY{n}{TRAINDIR} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/local/Tom.Beucler/SPCAM\PYZus{}PHYS/}\PY{l+s+s1}{\PYZsq{}}
         \PY{n}{DATADIR} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/project/meteo/w2w/A6/S.Rasp/SP\PYZhy{}CAM/sp32fbp\PYZus{}andkua/}\PY{l+s+s1}{\PYZsq{}}
         \PY{n}{PREFIX} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{32\PYZus{}col\PYZus{}lgsc\PYZus{}12m\PYZus{}}\PY{l+s+s1}{\PYZsq{}}
         \PY{o}{\PYZpc{}}\PY{k}{cd} /filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]

        ---------------------------------------------------------------------------

        ImportError                               Traceback (most recent call last)

        <ipython-input-77-ccb5d40bb54b> in <module>
          3 from cbrain.imports import *
          4 from cbrain.data\_generator import *
    ----> 5 from cbrain.models import MasConsLay
          6 from cbrain.utils import limit\_mem
          7 import tensorflow as tf


        ImportError: cannot import name 'MasConsLay'

    \end{Verbatim}

    tgb - 2/4/2019 - This is where this notebook start differing from 001\\
1) The new goal is to take into account large-scale forcings in the
input file and see if it makes a difference since the CRM knows about
them.\\
2) If it were the 8-column dataset, I would throw in UBP (the zonal
wind) just in case and the Jacobian will be a good way of checking if it
makes a difference.\\
3) We'll call the new config file 32col\_mp\_lgsc.

In that file:\\
inputs : {[}QBP, QCBP, QIBP, TBP, UBP, VBP, Qdt\_adiabatic,
QCdt\_adiabatic, QIdt\_adiabatic, Tdt\_adiabatic, Udt\_adiabatic,
Vdt\_adiabatic, PS, SOLIN, SHFLX, LHFLX{]}\\
outputs : {[}PHQ, PHCLDLIQ, PHCLDICE, TPHYSTND, DTVKE, FSNT, FSNS, FLNT,
FLNS, PRECT, PRECTEND, PRECST, PRECSTEN{]}

Error1: There shouldn't be any {[}1,:{]} in the preprocess\_aqua.py
script when calculating the right name based on the dt\_adiabatic name.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{o}{!}python cbrain/Test01\PYZus{}preprocess\PYZus{}aqua.py \PY{err}{\PYZbs{}}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{config} \PY{n}{pp\PYZus{}config}\PY{o}{/}\PY{l+m+mi}{32}\PY{n}{col\PYZus{}mp\PYZus{}lgsc\PYZus{}tbeucler\PYZus{}local}\PY{o}{.}\PY{n}{yml} \PYZbs{}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{aqua\PYZus{}names} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{*.h1.0000\PYZhy{}*\PYZhy{}0[1\PYZhy{}12]\PYZhy{}*}\PY{l+s+s1}{\PYZsq{}} \PYZbs{}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{out\PYZus{}pref} \PY{l+m+mi}{32}\PY{n}{\PYZus{}col\PYZus{}lgsc\PYZus{}12m\PYZus{}train}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
GitPython not found. Please install for better reproducibility.
Time checkpoint reading data: 18.47 s
Number of time steps: 1152
Cut time steps: [  95  191  287  383  479  575  671  767  863  959 1055]
Cut time steps: [  95  191  287  383  479  575  671  767  863  959 1055]
Time checkpoint create datasets: 18.72 s
Time checkpoint reshape and rechunk: 27.33 s
Compute means and stds
Saving normalization file: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_lgsc\_12m\_train\_norm.nc
Time checkpoint normalization arrays: 297.46 s
Time checkpoint rechunk and ds: 298.94 s
Save features: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_lgsc\_12m\_train\_features.nc
Save targets: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_lgsc\_12m\_train\_targets.nc
Total time: 401.07 s

    \end{Verbatim}

    \hypertarget{create-validation-dataset}{%
\subsubsection{1.2) Create validation
dataset}\label{create-validation-dataset}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{o}{!}python cbrain/Test01\PYZus{}preprocess\PYZus{}aqua.py \PY{err}{\PYZbs{}}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{config} \PY{n}{pp\PYZus{}config}\PY{o}{/}\PY{l+m+mi}{32}\PY{n}{col\PYZus{}mp\PYZus{}lgsc\PYZus{}tbeucler\PYZus{}local}\PY{o}{.}\PY{n}{yml} \PYZbs{}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{aqua\PYZus{}names} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{*.h1.0001\PYZhy{}*\PYZhy{}0[1\PYZhy{}3]\PYZhy{}*}\PY{l+s+s1}{\PYZsq{}} \PYZbs{}
        \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{out\PYZus{}pref} \PY{l+m+mi}{32}\PY{n}{\PYZus{}col\PYZus{}lgsc\PYZus{}12m\PYZus{}valid} \PY{o}{\PYZhy{}}\PY{o}{\PYZhy{}}\PY{n}{ext\PYZus{}norm} \PY{n}{Nope}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
GitPython not found. Please install for better reproducibility.
Time checkpoint reading data: 8.10 s
Number of time steps: 432
Cut time steps: [143 287]
Cut time steps: [143 287]
Time checkpoint create datasets: 8.30 s
Time checkpoint reshape and rechunk: 11.52 s
Load external normalization file
Time checkpoint normalization arrays: 11.52 s
Time checkpoint rechunk and ds: 11.86 s
Save features: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_lgsc\_12m\_valid\_features.nc
Save targets: /local/Tom.Beucler/SPCAM\_PHYS/32\_col\_lgsc\_12m\_valid\_targets.nc
Total time: 73.08 s

    \end{Verbatim}

    \hypertarget{shuffle-the-training-dataset}{%
\subsubsection{1.3) Shuffle the training
dataset}\label{shuffle-the-training-dataset}}

tgb - 1/16/2019 - Adapted from Stephan's entire worlflow for 32 column
run

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{o}{\PYZpc{}}\PY{k}{cd} /filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM
        \PY{o}{!}python cbrain/shuffle\PYZus{}ds.py \PYZhy{}\PYZhy{}pref \PY{n+nv}{\PYZdl{}TRAINDIR}/32\PYZus{}col\PYZus{}lgsc\PYZus{}12m\PYZus{}train
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/filer/z-sv-pool12c/t/Tom.Beucler/SPCAM/CBRAIN-CAM
Reading files: /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_lgsc\_12m\_train\_features.nc /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_lgsc\_12m\_train\_targets.nc
Creating files: /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_lgsc\_12m\_train\_shuffle\_features.nc /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_lgsc\_12m\_train\_shuffle\_targets.nc
GitPython not found. Please install for better reproducibility.
GitPython not found. Please install for better reproducibility.
100\%|█████████████████████████████████████████████| 1/1 [00:39<00:00, 39.31s/it]

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{o}{!}python cbrain/shuffle\PYZus{}ds.py \PYZhy{}\PYZhy{}pref \PY{n+nv}{\PYZdl{}TRAINDIR}/32\PYZus{}col\PYZus{}lgsc\PYZus{}12m\PYZus{}valid
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Reading files: /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_lgsc\_12m\_valid\_features.nc /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_lgsc\_12m\_valid\_targets.nc
Creating files: /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_lgsc\_12m\_valid\_shuffle\_features.nc /local/Tom.Beucler/SPCAM\_PHYS//32\_col\_lgsc\_12m\_valid\_shuffle\_targets.nc
GitPython not found. Please install for better reproducibility.
GitPython not found. Please install for better reproducibility.
100\%|█████████████████████████████████████████████| 1/1 [00:13<00:00, 13.48s/it]

    \end{Verbatim}

    \hypertarget{change-the-outputs-normalization-using-pressure-levels}{%
\subsubsection{1.4) Change the output's normalization using pressure
levels}\label{change-the-outputs-normalization-using-pressure-levels}}

    tgb - 2/6/2019 - See notebook 001 for careful test of each of the steps
below

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}7}]:} \PY{n}{ds} \PY{o}{=} \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{TRAINDIR} \PY{o}{+} \PY{n}{PREFIX} \PY{o}{+} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}  
        
        \PY{c+c1}{\PYZsh{} Open the pickle files containing the pressure converters}
        \PY{k}{with} \PY{n+nb}{open}\PY{p}{(}\PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/cbrain}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai\PYZus{}hybi.pkl}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rb}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{k}{as} \PY{n}{f}\PY{p}{:}
                    \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi} \PY{o}{=} \PY{n}{pickle}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{n}{f}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} Takes representative value for PS since purpose is normalization}
        \PY{n}{PS} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;}
        \PY{n}{P} \PY{o}{=} \PY{n}{P0}\PY{o}{*}\PY{n}{hyai}\PY{o}{+}\PY{n}{PS}\PY{o}{*}\PY{n}{hybi}\PY{p}{;} \PY{c+c1}{\PYZsh{} Total pressure [Pa]}
        \PY{n}{dP} \PY{o}{=} \PY{n}{P}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{;} \PY{c+c1}{\PYZsh{} Differential pressure [Pa]  }
          
        \PY{n}{dt} \PY{o}{=} \PY{l+m+mi}{30}\PY{o}{*}\PY{l+m+mi}{60}\PY{p}{;} \PY{c+c1}{\PYZsh{} timestep}
        \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{(}\PY{n}{dP}\PY{p}{,}\PY{n}{dP}\PY{p}{,}\PY{n}{dP}\PY{p}{,}\PY{n}{dP}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{dP}\PY{p}{,}\PY{n}{dt}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}  
          
        \PY{c+c1}{\PYZsh{} Copy old normalization file}
        \PY{n}{path1} \PY{o}{=} \PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{n}{TRAINDIR}\PY{p}{,}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{path2} \PY{o}{=} \PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{n}{TRAINDIR}\PY{p}{,}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}oldnorm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{o}{!}cp \PY{n+nv}{\PYZdl{}path1} \PY{n+nv}{\PYZdl{}path2}  
          
        \PY{c+c1}{\PYZsh{} Create new dataset with characteristics of modified ds}
        \PY{n}{new\PYZus{}ds} \PY{o}{=} \PY{n}{xr}\PY{o}{.}\PY{n}{Dataset}\PY{p}{(}\PY{p}{\PYZob{}}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}means}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}stds}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}mins}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}mins}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}maxs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}maxs}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}means}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}stds}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}stds}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}mins}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}mins}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}maxs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}maxs}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}names}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}names}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}names}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}names}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{p}{,}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}conv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}
                \PY{p}{\PYZcb{}}\PY{p}{)}  
          
        \PY{c+c1}{\PYZsh{} 4.3 Write new data set to initial target\PYZus{}conv file}
        \PY{o}{!}rm \PY{n+nv}{\PYZdl{}path1} \PYZsh{} Remove normalization file  
        \PY{n}{new\PYZus{}ds}\PY{o}{.}\PY{n}{to\PYZus{}netcdf}\PY{p}{(}\PY{n}{path1}\PY{p}{)} \PY{c+c1}{\PYZsh{} Save the new dataset as the new normalization file}
\end{Verbatim}


    \hypertarget{create-data-generator-and-produce-data-sample}{%
\subsection{2) Create data generator and produce data
sample}\label{create-data-generator-and-produce-data-sample}}

    \hypertarget{create-data-generator-from-training-dataset}{%
\subsubsection{2.1) Create data generator from training
dataset}\label{create-data-generator-from-training-dataset}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{path1}\PY{p}{)}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)} \PY{c+c1}{\PYZsh{} Don\PYZsq{}t forget to close xarray handler!!}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]

        ---------------------------------------------------------------------------

        NameError                                 Traceback (most recent call last)

        <ipython-input-2-dea80371377a> in <module>
    ----> 1 xr.open\_dataset(path1).close() \# Don't forget to close xarray handler!!
    

        NameError: name 'path1' is not defined

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{n}{train\PYZus{}gen\PYZus{}obj} \PY{o}{=} \PY{n}{DataGenerator}\PY{p}{(}
            \PY{n}{data\PYZus{}dir}\PY{o}{=}\PY{n}{TRAINDIR}\PY{p}{,} 
            \PY{n}{feature\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}shuffle\PYZus{}features.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{target\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}shuffle\PYZus{}targets.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{batch\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{512}\PY{p}{,}
            \PY{n}{norm\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{fsub}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}   \PY{c+c1}{\PYZsh{} Subtracct the mean}
            \PY{n}{fdiv}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} Then divide by Std}
            \PY{n}{tmult}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}conv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} For targets/output: use values from preprocess\PYZus{}aqua.}
            \PY{n}{shuffle}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}
        \PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Generator will have 9338880 samples in 18240 batches
Features have shape 304; targets have shape 158

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{n}{gen} \PY{o}{=} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{return\PYZus{}generator}\PY{p}{(}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} Produce data sample}
        \PY{n}{x}\PY{p}{,} \PY{n}{y} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{gen}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} and check its shape}
        \PY{n}{x}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{y}\PY{o}{.}\PY{n}{shape}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}3}]:} ((512, 304), (512, 158))
\end{Verbatim}
            
    \hypertarget{create-data-generator-from-validation-dataset-and-produce-sample}{%
\subsubsection{2.2) Create data generator from validation dataset and
produce
sample}\label{create-data-generator-from-validation-dataset-and-produce-sample}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{n}{valid\PYZus{}gen\PYZus{}obj} \PY{o}{=} \PY{n}{DataGenerator}\PY{p}{(}
            \PY{n}{data\PYZus{}dir}\PY{o}{=}\PY{n}{TRAINDIR}\PY{p}{,} 
            \PY{n}{feature\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{valid\PYZus{}shuffle\PYZus{}features.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{target\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{valid\PYZus{}shuffle\PYZus{}targets.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{batch\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{512}\PY{p}{,}
            \PY{n}{norm\PYZus{}fn}\PY{o}{=}\PY{n}{PREFIX}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{n}{fsub}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}means}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}   \PY{c+c1}{\PYZsh{} Subtracct the mean}
            \PY{n}{fdiv}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} Then divide by Std}
            \PY{n}{tmult}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{target\PYZus{}conv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}    \PY{c+c1}{\PYZsh{} For targets/output: use values from preprocess\PYZus{}aqua.}
            \PY{n}{shuffle}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}
        \PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Generator will have 3514368 samples in 6864 batches
Features have shape 304; targets have shape 158

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{n}{validgen} \PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{return\PYZus{}generator}\PY{p}{(}\PY{p}{)}
        
        \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{validgen}\PY{p}{)}
        
        \PY{n}{xval}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{yval}\PY{o}{.}\PY{n}{shape}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}5}]:} ((512, 304), (512, 158))
\end{Verbatim}
            
    \hypertarget{neural-network-attempts-tgb---started-1152019}{%
\subsection{3) Neural network attempts (tgb - started
1/15/2019)}\label{neural-network-attempts-tgb---started-1152019}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}6}]:} \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{layers} \PY{k}{import} \PY{o}{*}
        \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{o}{*}
\end{Verbatim}


    \hypertarget{energy-conservation-strategy-tgb---started-1182019}{%
\subsubsection{3.1) Energy conservation strategy (tgb - started
1/18/2019)}\label{energy-conservation-strategy-tgb---started-1182019}}

\hypertarget{step-0-load-all-the-variables-to-calculate-mass-weighted-vertical-integrals}{%
\paragraph{Step 0: Load all the variables to calculate mass-weighted
vertical
integrals}\label{step-0-load-all-the-variables-to-calculate-mass-weighted-vertical-integrals}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}7}]:} \PY{c+c1}{\PYZsh{} 1) Open the file containing the normalization of the targets}
        \PY{n}{ds} \PY{o}{=} \PY{n}{xr}\PY{o}{.}\PY{n}{open\PYZus{}dataset}\PY{p}{(}\PY{n}{TRAINDIR} \PY{o}{+} \PY{n}{PREFIX} \PY{o}{+} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train\PYZus{}norm.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} 2) Open the pickle files containing the pressure converters}
        \PY{k}{with} \PY{n+nb}{open}\PY{p}{(}\PY{n}{os}\PY{o}{.}\PY{n}{path}\PY{o}{.}\PY{n}{join}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/filer/z\PYZhy{}sv\PYZhy{}pool12c/t/Tom.Beucler/SPCAM/CBRAIN\PYZhy{}CAM/cbrain}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai\PYZus{}hybi.pkl}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rb}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{k}{as} \PY{n}{f}\PY{p}{:}
                    \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi} \PY{o}{=} \PY{n}{pickle}\PY{o}{.}\PY{n}{load}\PY{p}{(}\PY{n}{f}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} 3) Define fsub, fdiv, normq}
        \PY{n}{fsub} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}means}\PY{o}{.}\PY{n}{values}
        \PY{n}{fdiv} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{feature\PYZus{}stds\PYZus{}by\PYZus{}var}\PY{o}{.}\PY{n}{values}
        \PY{n}{normq} \PY{o}{=} \PY{n}{ds}\PY{o}{.}\PY{n}{target\PYZus{}conv}\PY{o}{.}\PY{n}{values}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fsub.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{fsub}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fdiv.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{fdiv}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{normq.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{normq}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{hyai}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hybi.shape=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{hybi}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
        
        \PY{n}{ds}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
fsub.shape= (304,)
fdiv.shape= (304,)
normq.shape= (158,)
hyai.shape= (31,)
hybi.shape= (31,)

    \end{Verbatim}

    \hypertarget{step-1-implement-mass-conservation-layer}{%
\paragraph{Step 1: Implement mass conservation
layer}\label{step-1-implement-mass-conservation-layer}}

    \hypertarget{enforcing-mass-conservation}{%
\subparagraph{Enforcing mass
conservation}\label{enforcing-mass-conservation}}

Reference for mass and energy conservation:

(Original CAM F90 script, look for ``Compute vertical integrals of dry
static energy and water'' in the script)\\
https://gitlab.com/mspritch/spcam3.0-neural-net/blob/master/models/atm/cam/src/physics/cam1/check\_energy.F90

(Stephan's energy/mass verification scripts)\\
https://github.com/raspstephan/CBRAIN-CAM/blob/master/notebooks/dev/old\_notebooks/energy\_conservation.ipynb

\hypertarget{masswater-conservation-equation-in-wm2}{%
\subparagraph{Mass/Water conservation equation in
W/m2}\label{masswater-conservation-equation-in-wm2}}

If the network predicts the water vapor tendency, defined as the
difference between the moisture before and after physics divided by the
timestep dt (normalized in energy units W/m2):
\[\delta q_{v,i,l}\left(p\right)\overset{\mathrm{def}}{=}\frac{L_{v}\Delta p_{\mathrm{norm}}}{g}\frac{q_{v,i,l}^{a}\left(p\right)-q_{v,i,l}^{b}\left(p\right)}{\Delta t}\]

The water conservation equation is (normalized in energy units W/m2):
\[\underbrace{\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\left(\delta q_{v}+\delta q_{l}+\delta q_{i}\right)}_{\mathrm{Difference\ after-before\ physics}}=\underbrace{\int_{\widetilde{t}}^{\widetilde{t}+1} \widetilde{dt}\ \left(LHF-L_{v}P-10^{-3}\cdot L_{v} P_{tend}\right)}_{\mathrm{Cond-Precip\ during\ \Delta t}}
\]

where we have defined: \[
\widetilde{p}\overset{\mathrm{def}}{=}\frac{p}{p_{\mathrm{norm}}}
\] \[
\widetilde{t}\overset{\mathrm{def}}{=}\frac{t}{\Delta t}
\] Note that the precipitation variables here sum up to the water flux
from the atmosphere to the surface due to precipitation: \[
\mathrm{Precipitation\ flux\ atm\rightarrow surf.\ \left[kg.m^{-2}.s^{-1}\right]}=P+10^{-3}\cdot P_{tend}
\] The idea is to predict all variables but one. The specific humidity
at the lowest level of the model (here 30) is likely to be one of the
most penalized output variables as it has one of the largest tendencies
(in W/m2) in the final cost function. If we predict all other variables
and calculate that variable as a residual, it yields:

\[\Delta \widetilde{p}_{30} \delta q_{v}^{30}=\int_{\widetilde{t}}^{\widetilde{t}+1} \widetilde{dt}\ \left(LHF-L_{v}P-10^{-3}\cdot L_{v} P_{tend}\right)-\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\left(\delta q_{l}+\delta q_{i}\right)-\int_{0}^{\widetilde{p_{30}}}d\widetilde{p}\delta q_{v}
\]

Note that because we are already working with tendencies, the timestep
variable dt is not needed in the water conservation layer.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}62}]:} \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/5/2019 \PYZhy{} Adapated the mass conservation layer to new input format}
         \PY{k}{class} \PY{n+nc}{MasConsLay}\PY{p}{(}\PY{n}{Layer}\PY{p}{)}\PY{p}{:}
             
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{p}{,} \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim}\PY{p}{,} \PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub} \PY{o}{=} \PY{n}{fsub} \PY{c+c1}{\PYZsh{} Subtraction for normalization of inputs }
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv} \PY{o}{=} \PY{n}{fdiv} \PY{c+c1}{\PYZsh{} Division for normalization of inputs}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq} \PY{o}{=} \PY{n}{normq} \PY{c+c1}{\PYZsh{} Normalization of output\PYZsq{}s water concentration}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai} \PY{o}{=} \PY{n}{hyai} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi} \PY{o}{=} \PY{n}{hybi} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{n}{output\PYZus{}dim} \PY{c+c1}{\PYZsh{} Dimension of output}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n+nf+fm}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{build}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{build}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{)}  \PY{c+c1}{\PYZsh{} Be sure to call this somewhere!}
             
             \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/6/2019 \PYZhy{} following https://github.com/keras\PYZhy{}team/keras/issues/4871}
             \PY{k}{def} \PY{n+nf}{get\PYZus{}config}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{n}{config} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fsub}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fdiv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{normq}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hybi}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{output\PYZus{}dim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{\PYZcb{}}
                 \PY{n}{base\PYZus{}config} \PY{o}{=} \PY{n+nb}{super}\PY{p}{(}\PY{n}{MasConsLay}\PY{p}{,} \PY{n+nb+bp}{self}\PY{p}{)}\PY{o}{.}\PY{n}{get\PYZus{}config}\PY{p}{(}\PY{p}{)}
                 \PY{k}{return} \PY{n+nb}{dict}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{base\PYZus{}config}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n+nb}{list}\PY{p}{(}\PY{n}{config}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{call}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{arrs}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} arrs (for arrays) is a list with }
                 \PY{c+c1}{\PYZsh{} [inputs=inp and the output of the previous layer=densout]}
                 \PY{c+c1}{\PYZsh{} inputs will be [n\PYZus{}sample, 304 = 30*10+4] with}
                 \PY{c+c1}{\PYZsh{} [QBP, QCBP, QIBP, TBP, VBP, Qdt\PYZus{}adiabatic, QCdt\PYZus{}adiabatic, QIdt\PYZus{}adiabatic,}
                 \PY{c+c1}{\PYZsh{} Tdt\PYZus{}adiabatic, Vdt\PYZus{}adiabatic, PS, SOLIN, SHFLX, LHFLX]}
                 \PY{c+c1}{\PYZsh{} outputs of the previous dense layer will be [n\PYZus{}samples, 124 = 30*4+6\PYZhy{}2] with}
                 \PY{c+c1}{\PYZsh{} [DELQ\PYZbs{}\PYZob{}PHQ AT LOWEST LVL\PYZcb{}, DELCLDLIQ, DELCLDICE, }
                 \PY{c+c1}{\PYZsh{} TPHYSTND\PYZbs{}\PYZob{}TPHYSTND AT LOWEST LVL\PYZcb{}, FSNT, FSNS, FLNT, FLNS, PRECT, PRECTEND]}
                 
                 \PY{c+c1}{\PYZsh{} Split between the inputs inp \PYZam{} the output of the densely connected}
                 \PY{c+c1}{\PYZsh{} neural network, densout}
                 \PY{n}{inp}\PY{p}{,} \PY{n}{densout} \PY{o}{=} \PY{n}{arrs}
                 
                 \PY{c+c1}{\PYZsh{} 0) Constants}
                 \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
                 \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
                 \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
                 
                 \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
                 \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
                 \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
                 \PY{n}{PS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
                 \PY{n}{P} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                             \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{)}
                 \PY{n}{dP} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
                 \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                            \PY{n}{G}\PY{p}{)}\PY{p}{,} \PY{n}{L\PYZus{}V}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
                 \PY{c+c1}{\PYZsh{} Wondering about broadcasting here...}
                 \PY{c+c1}{\PYZsh{} tf.div or simply \PYZbs{} would support broadcasting }
                 \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 2) Calculate cloud water vertical integral from level 1 to level 30}
                 \PY{c+c1}{\PYZsh{} The indices are tricky here because we are missing del(q\PYZus{}v)@(level 30)}
                 \PY{c+c1}{\PYZsh{} so e.g. q\PYZus{}liq@(level 1) is the 30th element of the output of the }
                 \PY{c+c1}{\PYZsh{} previous dense layer}
                 \PY{n}{CLDVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PYZbs{}
                                           \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{:}\PY{l+m+mi}{59}\PY{p}{]}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{59}\PY{p}{:}\PY{l+m+mi}{89}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{CLDINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{CLDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 3) Calculate water vapor vertical integral from level 1 to level 29}
                 \PY{n}{VAPVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                           \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
                 \PY{n}{VAPINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{VAPVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 4) Calculate forcing on the right\PYZhy{}hand side (Net Evaporation\PYZhy{}Precipitation)}
                 \PY{c+c1}{\PYZsh{} E\PYZhy{}P is already normalized to units W.m\PYZhy{}2 in the output vector}
                 \PY{c+c1}{\PYZsh{} so all we need to do is input\PYZhy{}unnormalize LHF that is taken from the input vector}
                 \PY{n}{LHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Note that total precipitation = PRECT + 1e\PYZhy{}3*PRECTEND in the CAM model}
                 \PY{c+c1}{\PYZsh{} PRECTEND already multiplied by 1e\PYZhy{}3 in output vector so no need to redo it}
                 \PY{n}{PREC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{153}\PY{p}{]}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 5) Infer water vapor tendency at level 30 as a residual}
                 \PY{c+c1}{\PYZsh{} Composing tfm.add 3 times because not sure how to use tfm.add\PYZus{}n}
                 \PY{n}{DELQV30} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{add} \PY{p}{(}\PYZbs{}
                                                                 \PY{n}{LHF}\PY{p}{,} \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{PREC}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                                       \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{CLDINT}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                              \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{VAPINT}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                      \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 6) Concatenate the water tendencies with the newly inferred tendency}
                 \PY{c+c1}{\PYZsh{} to get the final vector out of shape (\PYZsh{}samples,125) with}
                 \PY{c+c1}{\PYZsh{} [DELQ, DELCLDLIQ, DELCLDICE, }
                 \PY{c+c1}{\PYZsh{} TPHYSTND\PYZbs{}\PYZob{}TPHYSTND AT SURFACE\PYZcb{}, FSNT, FSNS, FLNT, FLNS, PRECT PRECTEND]}
                 \PY{c+c1}{\PYZsh{} Uses https://www.tensorflow.org/api\PYZus{}docs/python/tf/concat}
                 \PY{n}{DELQV30} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{DELQV30}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{} Adds dimension=1 to axis=1}
                 \PY{n}{out} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,} \PY{n}{DELQV30}\PY{p}{,} \PY{n}{densout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}
                 \PY{k}{return} \PY{n}{out}
             
             \PY{k}{def} \PY{n+nf}{compute\PYZus{}output\PYZus{}shape}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{k}{return} \PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{)} \PY{c+c1}{\PYZsh{} The output has size 125=30*4+6\PYZhy{}1}
             \PY{c+c1}{\PYZsh{} and is ready to be fed to the energy conservation layer}
             \PY{c+c1}{\PYZsh{} before we reach the total number of outputs = 126}
\end{Verbatim}


    \hypertarget{step-2-implement-energy-conservation-layer}{%
\paragraph{Step 2: Implement energy conservation
layer}\label{step-2-implement-energy-conservation-layer}}

\hypertarget{energy-conservation-equation-in-wm2}{%
\subparagraph{Energy conservation equation in
W/m2}\label{energy-conservation-equation-in-wm2}}

The total energy conservation in CAM is much more delicate than the
water mass conservation. One key simplification is that the net
advection of moist static energy in the CRM (within a grid-box) is zero,
so we only need to focus on the thermodynamics.

The two reference scripts of SPCAM are:\\
1)https://gitlab.com/mspritch/spcam3.0-neural-net/blob/master/models/atm/cam/src/physics/cam1/check\_energy.F90
(look for te\_tdn)\\
2)https://gitlab.com/mspritch/spcam3.0-neural-net/blob/master/models/atm/cam/src/physics/cam1/tphysbc\_internallythreaded.F90
(look for wtricesink and icesink)

Another very useful script is Stephan's attempt at conserving
energy/making sense of the variables:\\
https://github.com/raspstephan/CBRAIN-CAM/blob/master/notebooks/dev/old\_notebooks/energy\_conservation.ipynb\\
which is extremely helpful since some NETCDF flags are misleading/have
the wrong attributes.

Following these files, we define the total energy, where the enthalpy
component uses the ice as the reference phase of energy 0 (therefore,
each gram of water in the forms of liquid or vapor add to the total
energy of the system): \[
e\ \left[\mathrm{J\ kg^{-1}}\right]\overset{\mathrm{def}}{=}\frac{\overrightarrow{u}\cdot\overrightarrow{u}}{2}+c_{p}T+L_{s}q_{v}+L_{f}q_{l}
\] We then isolate the column tendency of each variable that is due to
precipitation or phase change between ice and liquid within the column.
\[
\delta QV_{SP}\ \left[\mathrm{kg\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{p_{s}}\frac{dp}{g}\left(\frac{dq_{v}}{dt}\right)-\frac{\mathrm{LHF}}{L_{v}}
\] \[
\delta QL_{SP}\ \left[\mathrm{kg\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{p_{s}}\frac{dp}{g}\left(\frac{dq_{l}}{dt}\right)
\] \[
\delta T_{SP}\ \left[\mathrm{W\ m^{-2}\ K^{-1}}\right]\overset{\mathrm{def}}{=}\int_{0}^{p_{s}}\frac{dp}{g}\left(\frac{dT}{dt}\right)-\frac{\mathrm{RAD}}{c_{p}}-\frac{\mathrm{SHF}}{c_{p}}-\int_{0}^{p_{s}}\frac{dp}{g}\left(\frac{dT_{KE}}{dt}\right)
\] where we have introduced the net radiative heating of the column: \[
\mathrm{RAD}\overset{\mathrm{def}}{=}\mathrm{SW}_{t}-\mathrm{SW}_{s}+\mathrm{LW}_{s}-\mathrm{LW}_{t}
\] Physically, we have removed the following energetic contributions: -
The net evaporation due to the latent heat flux from the column water
vapor tendency, - The net radiative flux, the sensible heat flux and the
column turbulent dissipation of kinetic energy from the column
temperature tendency, - Nothing from the column liquid water tendency,
since it is all due to conversion to vapor or ice.

The next step is to calculate the total energy tendency due to
precipitation/phase change by summing all of the components we have
calculated before: \[
\delta E_{\mathrm{SP}}\ \left[\mathrm{W\ m^{-2}}\right]=c_{p}\delta T_{SP}+L_{s}\delta QV_{SP}+L_{f}\delta QL_{SP}
\] Note that: - Because the current setup of SPCAM does not resolve
momentum transfer, we have left the change in kinetic energy out. -
Because the reference state is ice (and not liquid as is often seen for
the frozen moist static energy), the latent heat flux is multiplied by
the ratio L\_s/L\_v\textgreater{}1 of the latent heat of sublimation to
the latent heat of vaporization.

The change from phase change/precipitation is a sum of two terms: - An
energy source from the net change from (liquid) to (ice) within the
column ``SNOW''. - An energy sink from the precipitation flux from the
(atmopshere) to the (surface) ``P''. \[
\delta E_{\mathrm{SP}}\ \left[\mathrm{W\ m^{-2}}\right]=L_{f}\left(SNOW+10^{-3}SNOW_{tend}-P-10^{-3}P_{tend}\ \left[\mathrm{All\ in\ kg\ m^{-2}\ s^{-1}}\right]\right)
\]\\
We work with the same non-dimensional variable as before, since all
variables have been normalized in the output vector to have units W/m2.
Additionally to: \[
\delta q_{v,i,l}\left(p\right)\overset{\mathrm{def}}{=}\frac{L_{v}\Delta p_{\mathrm{norm}}}{g}\frac{q_{v,i,l}^{a}\left(p\right)-q_{v,i,l}^{b}\left(p\right)}{\Delta t}
\] we now also introduce the level-by-level temperature tendency in
units W/m2: \[
\delta T\left(p\right)\overset{\mathrm{def}}{=}\frac{c_{p}\Delta p_{\mathrm{norm}}}{g}\left(\frac{dT}{dt}\right)\left(p\right)
\]

The equations become: \[
L_{v}\cdot\delta QV_{SP}\ \left[\mathrm{W\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta q_{v}-\mathrm{LHF}
\] \[
L_{v}\cdot\delta QL_{SP}\ \left[\mathrm{W\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta q_{l}
\] \[
c_{p}\cdot\delta T_{SP}\ \left[\mathrm{W\ m^{-2}}\right]\overset{\mathrm{def}}{=}\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta T-\mathrm{RAD}-\mathrm{SHF}-\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta T_{TKE}
\]

We now isolate the temperature tendency at level 30 and write it as a
residual of the energy budget using all the variables normalized to
units W/m2: \[
\begin{aligned}\Delta\widetilde{p}_{30}\cdot\delta T_{30} & =\frac{L_{f}}{L_{v}}\left(L_{v}SNOW+10^{-3}L_{v}SNOW_{tend}-L_{v}P-10^{-3}L_{v}P_{tend}\right)\\
 & +\mathrm{RAD}+\mathrm{SHF}+\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta T_{TKE}\\
 & -\frac{L_{s}}{L_{v}}\left(\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta q_{v}-\mathrm{LHF}\right)-\frac{L_{f}}{L_{v}}\int_{0}^{\widetilde{p_{s}}}d\widetilde{p}\cdot\delta q_{l}\\
 & -\int_{0}^{\widetilde{p_{30}}}d\widetilde{p}\cdot\delta T
\end{aligned}
\]

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}63}]:} \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/5/2019 \PYZhy{} Change to adapt to new input format}
         \PY{k}{class} \PY{n+nc}{EntConsLay}\PY{p}{(}\PY{n}{Layer}\PY{p}{)}\PY{p}{:}
             
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{p}{,} \PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim}\PY{p}{,} \PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub} \PY{o}{=} \PY{n}{fsub} \PY{c+c1}{\PYZsh{} Subtraction for normalization of inputs }
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv} \PY{o}{=} \PY{n}{fdiv} \PY{c+c1}{\PYZsh{} Division for normalization of inputs}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq} \PY{o}{=} \PY{n}{normq} \PY{c+c1}{\PYZsh{} Normalization of output\PYZsq{}s water concentration}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai} \PY{o}{=} \PY{n}{hyai} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi} \PY{o}{=} \PY{n}{hybi} \PY{c+c1}{\PYZsh{} CAM constants to calculate d\PYZus{}pressure}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{n}{output\PYZus{}dim} \PY{c+c1}{\PYZsh{} Dimension of output}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n+nf+fm}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{o}{*}\PY{o}{*}\PY{n}{kwargs}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{build}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb}{super}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{build}\PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{)}  \PY{c+c1}{\PYZsh{} Be sure to call this somewhere!}
                 
             \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/6/2019 \PYZhy{} following https://github.com/keras\PYZhy{}team/keras/issues/4871}
             \PY{k}{def} \PY{n+nf}{get\PYZus{}config}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{n}{config} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fsub}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fdiv}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{normq}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hyai}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,}
                           \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{hybi}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb}{list}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{output\PYZus{}dim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{\PYZcb{}}
                 \PY{n}{base\PYZus{}config} \PY{o}{=} \PY{n+nb}{super}\PY{p}{(}\PY{n}{EntConsLay}\PY{p}{,} \PY{n+nb+bp}{self}\PY{p}{)}\PY{o}{.}\PY{n}{get\PYZus{}config}\PY{p}{(}\PY{p}{)}
                 \PY{k}{return} \PY{n+nb}{dict}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{base\PYZus{}config}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n+nb}{list}\PY{p}{(}\PY{n}{config}\PY{o}{.}\PY{n}{items}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                 
             \PY{k}{def} \PY{n+nf}{call}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{arrs}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} arrs (for arrays) is a list with }
                 \PY{c+c1}{\PYZsh{} [inputs=inp and the output of the previous layer=massout]}
                 \PY{c+c1}{\PYZsh{} inputs will be [n\PYZus{}sample, 304 = 30*10+4] with}
                 \PY{c+c1}{\PYZsh{} [QBP, QCBP, QIBP, TBP, VBP, Qdt\PYZus{}adiabatic, QCdt\PYZus{}adiabatic, QIdt\PYZus{}adiabatic,}
                 \PY{c+c1}{\PYZsh{} Tdt\PYZus{}adiabatic, Vdt\PYZus{}adiabatic, PS, SOLIN, SHFLX, LHFLX]}
                 \PY{c+c1}{\PYZsh{} outputs of the previous dense layer will be [n\PYZus{}samples, 157 = 30*5+8\PYZhy{}1] with}
                 \PY{c+c1}{\PYZsh{} [DELQ, DELCLDLIQ, DELCLDICE, }
                 \PY{c+c1}{\PYZsh{} TPHYSTND\PYZbs{}\PYZob{}TPHYSTND AT LOWEST LVL\PYZcb{}, DTVKE,}
                 \PY{c+c1}{\PYZsh{} FSNT, FSNS, FLNT, FLNS, PRECT, PRECTEND, PRECST, PRECSTEN]}
                 
                 \PY{c+c1}{\PYZsh{} Split between the inputs inp \PYZam{} the output of the densely connected}
                 \PY{c+c1}{\PYZsh{} neural network, massout}
                 \PY{n}{inp}\PY{p}{,} \PY{n}{massout} \PY{o}{=} \PY{n}{arrs}
                 
                 \PY{c+c1}{\PYZsh{} 0) Constants}
                 \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
                 \PY{n}{L\PYZus{}F} \PY{o}{=} \PY{l+m+mf}{3.337e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of fusion of water [W.kg\PYZhy{}1]}
                 \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
                 \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]}
                 
                 \PY{c+c1}{\PYZsh{} 1) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
                 \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
                 \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
                 \PY{n}{PS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
                 \PY{n}{P} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                             \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{hybi}\PY{p}{)}\PY{p}{)}
                 \PY{n}{dP} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
                 \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                                   \PY{n}{G}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                      \PY{n}{L\PYZus{}V}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
                 \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 2) Calculate net energy input from phase change and precipitation}
                 \PY{c+c1}{\PYZsh{} PHAS = Lf/Lv*((PRECST+PRECSTEN)\PYZhy{}(PRECT+PRECTEND))}
                 \PY{n}{PHAS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                               \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{155}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{156}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                               \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{154}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                 \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                   \PY{n}{L\PYZus{}V}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 3) Calculate net energy input from radiation, sensible heat flux and turbulent KE}
                 \PY{c+c1}{\PYZsh{} 3.1) RAD = FSNT\PYZhy{}FSNS\PYZhy{}FLNT+FLNS}
                 \PY{n}{RAD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                               \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{149}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{151}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 3.2) Unnormalize sensible heat flux}
                 \PY{n}{SHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 3.3) Net turbulent kinetic energy dissipative heating is the column\PYZhy{}integrated }
                 \PY{c+c1}{\PYZsh{} turbulent kinetic energy energy dissipative heating}
                 \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{119}\PY{p}{:}\PY{l+m+mi}{149}\PY{p}{]}\PY{p}{)}
                 \PY{n}{KEDINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 4) Calculate tendency of normalized column water vapor due to phase change}
                 \PY{c+c1}{\PYZsh{} 4.1) Unnormalize latent heat flux}
                 \PY{n}{LHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{inp}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 4.2) Column water vapor is the column integral of specific humidity}
                 \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
                 \PY{n}{PHQINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 4.3) Multiply by L\PYZus{}S/L\PYZus{}V to normalize (explanation above)}
                 \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                                  \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                    \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                      \PY{n}{L\PYZus{}V}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 5) Same operation for liquid water tendency but multiplied by L\PYZus{}F/L\PYZus{}V}
                 \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PYZbs{}
                                                     \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(}\PYZbs{}
                                                                    \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                                    \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                     \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                       \PY{n}{L\PYZus{}V}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} 6) Same operation for temperature but only integrate from level 1 to level 29}
                 \PY{n}{DTINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{29}\PY{p}{]}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} 7) Now calculate dT30 as a residual}
                 \PY{n}{dT30} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                                                                                   \PY{n}{PHAS}\PY{p}{,}\PY{n}{RAD}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                                           \PY{n}{SHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                                   \PY{n}{KEDINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                           \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(} \PY{n}{SPDQINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                   \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(} \PY{n}{SPDQCINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                           \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(} \PY{n}{DTINT}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                   \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{29}\PY{p}{]}\PY{p}{)}
                 \PY{n}{dT30} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{expand\PYZus{}dims}\PY{p}{(}\PY{n}{dT30}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{n}{out} \PY{o}{=} \PY{n}{tf}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{119}\PY{p}{]}\PY{p}{,} \PY{n}{dT30}\PY{p}{,} \PY{n}{massout}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{119}\PY{p}{:}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}
                 \PY{k}{return} \PY{n}{out}
             
             \PY{k}{def} \PY{n+nf}{compute\PYZus{}output\PYZus{}shape}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{input\PYZus{}shape}\PY{p}{)}\PY{p}{:}
                 \PY{k}{return} \PY{p}{(}\PY{n}{input\PYZus{}shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{output\PYZus{}dim}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} and is ready to be used in the cost function}
\end{Verbatim}


    \hypertarget{step-3-implement-custom-loss-function}{%
\paragraph{Step 3: Implement custom loss
function}\label{step-3-implement-custom-loss-function}}

\[
\mathrm{Loss}\left[\mathrm{W^{2}.m^{-4}}\right]=\alpha\cdot\mathrm{MSE}+\left(1-\alpha\right)\left(\mathrm{Enthalpy\ residual}^{2}+\mathrm{Mass\ residual}^{2}\right)\ \ |\ \ \alpha\in[0,1]
\] tgb - 2/5/2019- Inspired from 1)
https://stackoverflow.com/questions/46858016/keras-custom-loss-function-to-pass-arguments-other-than-y-true-and-y-pred
for the custom loss function\\
2)
https://stackoverflow.com/questions/46464549/keras-custom-loss-function-accessing-current-input-pattern
for using the inputs in the custom loss function Uses the function
massent\_check as reference for the square Energy and mass residuals

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}10}]:} \PY{k}{def} \PY{n+nf}{customLoss}\PY{p}{(}\PY{n}{input\PYZus{}tensor}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{p}{,}\PY{n}{alpha} \PY{o}{=} \PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{:}
         
                 \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/5/2019 \PYZhy{} Loss function written above}
             \PY{k}{def} \PY{n+nf}{lossFunction}\PY{p}{(}\PY{n}{y\PYZus{}true}\PY{p}{,}\PY{n}{y\PYZus{}pred}\PY{p}{)}\PY{p}{:}    
                 \PY{n}{loss} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{alpha}\PY{p}{,} \PY{n}{mse}\PY{p}{(}\PY{n}{y\PYZus{}true}\PY{p}{,} \PY{n}{y\PYZus{}pred}\PY{p}{)}\PY{p}{)}
                 \PY{n}{loss} \PY{o}{+}\PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{l+m+mf}{1.0}\PY{p}{,}\PY{n}{alpha}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                     \PY{n}{massent\PYZus{}res}\PY{p}{(}\PY{n}{input\PYZus{}tensor}\PY{p}{,}\PY{n}{y\PYZus{}pred}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{p}{)}\PY{p}{)}
                 \PY{k}{return} \PY{n}{loss}
         
             \PY{c+c1}{\PYZsh{} tgb \PYZhy{} 2/5/2019 \PYZhy{} Mass and enthalpy residual function}
             \PY{c+c1}{\PYZsh{} Adapted from massent\PYZus{}check by converting numpy to tensorflow}
             \PY{k}{def} \PY{n+nf}{massent\PYZus{}res}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{p}{)}\PY{p}{:}
         
                 \PY{c+c1}{\PYZsh{} 0) Constants}
                 \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
                 \PY{n}{L\PYZus{}F} \PY{o}{=} \PY{l+m+mf}{3.337e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of fusion of water [W.kg\PYZhy{}1]}
                 \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
                 \PY{n}{L\PYZus{}S} \PY{o}{=} \PY{n}{L\PYZus{}F}\PY{o}{+}\PY{n}{L\PYZus{}V}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of sublimation of water [W.kg\PYZhy{}1]}
                 \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]   }
         
                 \PY{c+c1}{\PYZsh{} WATER\PYZam{}ENTHALPY) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
                 \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
                 \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
                 \PY{n}{PS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
                 \PY{n}{P} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
                 \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
                 \PY{n}{dP} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
                 \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
                 \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                           \PY{n}{G}\PY{p}{)}\PY{p}{,}\PYZbs{}
                 \PY{n}{L\PYZus{}V}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
                 \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} WATER.1) Calculate water vertical integral from level 1 to level 30}
                 \PY{n}{WATVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,}\PYZbs{}
                                                                 \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                         \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{WATINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{WATVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} WATER.2) Calculate forcing on the right\PYZhy{}hand side (Net Evaporation\PYZhy{}Precipitation)}
                 \PY{c+c1}{\PYZsh{} E\PYZhy{}P is already normalized to units W.m\PYZhy{}2 in the output vector}
                 \PY{c+c1}{\PYZsh{} so all we need to do is input\PYZhy{}unnormalize LHF that is taken from the input vector}
                 \PY{n}{LHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Note that total precipitation = PRECT + 1e\PYZhy{}3*PRECTEND in the CAM model}
                 \PY{c+c1}{\PYZsh{} PRECTEND already multiplied by 1e\PYZhy{}3 in output vector so no need to redo it}
                 \PY{n}{PREC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{154}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{155}\PY{p}{]}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} WATER.FINAL) Residual = E\PYZhy{}P\PYZhy{}DWATER/DT}
                 \PY{n}{WATRES} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{LHF}\PY{p}{,}\PYZbs{}
                                          \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{PREC}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                  \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{WATINT}\PY{p}{)}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.1) Calculate net energy input from phase change and precipitation}
                 \PY{c+c1}{\PYZsh{} PHAS = Lf/Lv*((PRECST+PRECSTEN)\PYZhy{}(PRECT+PRECTEND))}
                 \PY{n}{PHAS} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                       \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{156}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{157}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                       \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{154}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{155}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                               \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                  \PY{n}{L\PYZus{}V}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.2) Calculate net energy input from radiation, sensible heat flux and turbulent KE}
                 \PY{c+c1}{\PYZsh{} 2.1) RAD = FSNT\PYZhy{}FSNS\PYZhy{}FLNT+FLNS}
                 \PY{n}{RAD} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                               \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{151}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 2.2) Unnormalize sensible heat flux}
                 \PY{n}{SHF} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 2.3) Net turbulent kinetic energy dissipative heating is the column\PYZhy{}integrated }
                 \PY{c+c1}{\PYZsh{} turbulent kinetic energy energy dissipative heating}
                 \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
                 \PY{n}{KEDINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.3) Calculate tendency of normalized column water vapor due to phase change}
                 \PY{c+c1}{\PYZsh{} 3.1) Column water vapor is the column integral of specific humidity}
                 \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
                 \PY{n}{PHQINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} 3.2) Multiply by L\PYZus{}S/L\PYZus{}V to normalize (explanation above)}
                 \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                              \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                 \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                    \PY{n}{L\PYZus{}V}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.4) Same operation for liquid water tendency but multiplied by L\PYZus{}F/L\PYZus{}V}
                 \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PYZbs{}
                                               \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(}\PYZbs{}
                                                      \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                      \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                               \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                  \PY{n}{L\PYZus{}V}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.5) Same operation for temperature tendency}
                 \PY{n}{DTINT} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{reduce\PYZus{}sum}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} ENTHALPY.FINAL) Residual = SPDQ+SPDQC+DTINT\PYZhy{}RAD\PYZhy{}SHF\PYZhy{}PHAS}
                 \PY{n}{ENTRES} \PY{o}{=} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{SPDQINT}\PY{p}{,}\PYZbs{}
                                                                          \PY{n}{SPDQCINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                                  \PY{n}{DTINT}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                          \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{RAD}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                  \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{SHF}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                          \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{PHAS}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                  \PY{n}{tfm}\PY{o}{.}\PY{n}{negative}\PY{p}{(}\PY{n}{KEDINT}\PY{p}{)}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{} Return sum of water and enthalpy square residuals}
                 \PY{k}{return} \PY{n}{tfm}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{tfm}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{WATRES}\PY{p}{)}\PY{p}{,} \PY{n}{tfm}\PY{o}{.}\PY{n}{square}\PY{p}{(}\PY{n}{ENTRES}\PY{p}{)}\PY{p}{)}
         
             \PY{k}{return} \PY{n}{lossFunction}
\end{Verbatim}


    \hypertarget{step-4-formulate-massenergy-conserving-model-and-unconstrained-model}{%
\paragraph{Step 4: Formulate mass/energy conserving model, and
unconstrained
model}\label{step-4-formulate-massenergy-conserving-model-and-unconstrained-model}}

We start with inputs {[}QBP, QCBP, QIBP, TBP, VBP, Qdt\_adiabatic,
QCdt\_adiabatic, QIdt\_adiabatic, Tdt\_adiabatic, Vdt\_adiabatic, PS,
SOLIN, SHFLX, LHFLX{]} of shape 304.\\
We then have a few dense layers with size proportional to a power of 2

For now, there is no other ``physically-constraining'' layers than\\
the mass+energy conservation layers which take input of shape 156

After mass layer outputs vector of shape 157\\
After energy layer outputs final vector of shape 158\\
i.e. {[}PHQ, PHCLDLIQ, PHCLDICE, TPHYSTND, DTVKE, FSNT, FSNS, FLNT,
FLNS, PRECT, PRECTEND, PRECST, PRECSTEN{]}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}25}]:} \PY{c+c1}{\PYZsh{} Conservative model with 5 dense layers}
         \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
         \PY{n}{massout} \PY{o}{=} \PY{n}{MasConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{157}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{EntConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{157}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{158}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{massout}\PY{p}{]}\PY{p}{)}
         \PY{n}{mod\PYZus{}cons\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}26}]:} \PY{c+c1}{\PYZsh{} Same model, unconstrained}
         \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
         \PY{n}{mod\PYZus{}uncons\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}24}]:} \PY{c+c1}{\PYZsh{} LeakyReLU version}
         \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
             \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{lru\PYZus{}uncons\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}27}]:} \PY{c+c1}{\PYZsh{} Using a Lagrange multipler in the loss function}
         \PY{c+c1}{\PYZsh{} alpha = 0.5 (equal contrib from MSE and residual)}
         \PY{n}{inp05} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp05}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
         \PY{n}{mod\PYZus{}lagr05\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp05}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}25}]:} \PY{c+c1}{\PYZsh{} Leaky ReLU version}
         \PY{n}{inp05} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp05}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
             \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{lru\PYZus{}lagr05\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp05}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}27}]:} \PY{c+c1}{\PYZsh{} Leaky ReLU version}
         \PY{n}{inp001} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp001}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
             \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{lru\PYZus{}lagr001\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp001}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}28}]:} \PY{c+c1}{\PYZsh{} Leaky ReLU version}
         \PY{n}{inp099} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp099}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
             \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{lru\PYZus{}lagr099\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp099}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}28}]:} \PY{c+c1}{\PYZsh{} alpha = 0.01 (mostly residual)}
         \PY{n}{inp001} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp001}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
         \PY{n}{mod\PYZus{}lagr001\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp001}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}29}]:} \PY{c+c1}{\PYZsh{} alpha = 0.99 (mostly mse)}
         \PY{n}{inp099} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp099}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{158}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
         \PY{n}{mod\PYZus{}lagr099\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp099}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}136}]:} \PY{c+c1}{\PYZsh{} USING ELU instead of RELU}
          \PY{c+c1}{\PYZsh{} Conservative model with 5 dense layers}
          \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{elu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
          \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
              \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{elu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{elu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}    
          \PY{n}{massout} \PY{o}{=} \PY{n}{MasConsLay}\PY{p}{(}
              \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
              \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{157}
          \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
          \PY{n}{out} \PY{o}{=} \PY{n}{EntConsLay}\PY{p}{(}
              \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{157}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
              \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{158}
          \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{massout}\PY{p}{]}\PY{p}{)}
          \PY{n}{elu\PYZus{}cons\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    tgb - 2/6/2019 - Added the leaky ReLU using the following issue:\\
https://github.com/keras-team/keras/issues/117

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}140}]:} \PY{c+c1}{\PYZsh{} Using LeakyRELU instead of RELU}
          \PY{c+c1}{\PYZsh{} Conserving model with 5 dense layers}
          \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
              \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
              \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
          \PY{n}{massout} \PY{o}{=} \PY{n}{MasConsLay}\PY{p}{(}
              \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
              \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{157}
          \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
          \PY{n}{out} \PY{o}{=} \PY{n}{EntConsLay}\PY{p}{(}
              \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{157}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
              \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{158}
          \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{massout}\PY{p}{]}\PY{p}{)}
          \PY{n}{lru\PYZus{}cons\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    tgb - 2/6/2019 - It really looks like LeakyReLU (for now with alpha=0.3)
is the best activation function by far to minimize the MSE. So we'll:\\
(1) Play with the optimizer using this one.\\
(2) Re-write all other networks using LeakyReLU

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}64}]:} \PY{c+c1}{\PYZsh{} Playing with the optmizer}
         \PY{n}{inp} \PY{o}{=} \PY{n}{Input}\PY{p}{(}\PY{n}{shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{304}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{inp}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{:}
             \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
             \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{linear}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{densout} \PY{o}{=} \PY{n}{LeakyReLU}\PY{p}{(}\PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{(}\PY{n}{densout}\PY{p}{)}
         \PY{n}{massout} \PY{o}{=} \PY{n}{MasConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{156}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{157}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{densout}\PY{p}{]}\PY{p}{)}
         \PY{n}{out} \PY{o}{=} \PY{n}{EntConsLay}\PY{p}{(}
             \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{157}\PY{p}{,}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,} \PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,} \PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PYZbs{}
             \PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,} \PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,} \PY{n}{output\PYZus{}dim} \PY{o}{=} \PY{l+m+mi}{158}
         \PY{p}{)}\PY{p}{(}\PY{p}{[}\PY{n}{inp}\PY{p}{,} \PY{n}{massout}\PY{p}{]}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}adad\PYZus{}cons\PYZus{}5dens = Model(inputs=inp, outputs=out)}
         \PY{c+c1}{\PYZsh{}adam\PYZus{}cons\PYZus{}5dens = Model(inputs=inp, outputs=out)}
         \PY{n}{lru\PYZus{}cons\PYZus{}5dens} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{inputs}\PY{o}{=}\PY{n}{inp}\PY{p}{,} \PY{n}{outputs}\PY{o}{=}\PY{n}{out}\PY{p}{)}
\end{Verbatim}


    tgb - 2/5/2019 - Here, I compile the standard models with
.compile(optimizer,loss)\\
or the model with custom loss function with
.compile(loss=custom\_loss\_wrapper(input\_tensor), optimizer=XX)\\
See
https://stackoverflow.com/questions/46464549/keras-custom-loss-function-accessing-current-input-pattern
for more information.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}30}]:} \PY{n}{lru\PYZus{}lagr05\PYZus{}5dens}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{n}{loss}\PY{o}{=}\PY{n}{customLoss}\PY{p}{(}\PY{n}{inp05}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{p}{,}\PY{n}{alpha} \PY{o}{=} \PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{optimizer}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rmsprop}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{lru\PYZus{}lagr001\PYZus{}5dens}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{n}{loss}\PY{o}{=}\PY{n}{customLoss}\PY{p}{(}\PY{n}{inp001}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{p}{,}\PY{n}{alpha} \PY{o}{=} \PY{l+m+mf}{0.01}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{optimizer}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rmsprop}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{lru\PYZus{}lagr099\PYZus{}5dens}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{n}{loss}\PY{o}{=}\PY{n}{customLoss}\PY{p}{(}\PY{n}{inp099}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{p}{,}\PY{n}{alpha} \PY{o}{=} \PY{l+m+mf}{0.99}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{optimizer}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rmsprop}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{lru\PYZus{}uncons\PYZus{}5dens}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rmsprop}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mse}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}mod\PYZus{}cons\PYZus{}5dens.compile(\PYZsq{}adadelta\PYZsq{},\PYZsq{}mse\PYZsq{})}
         \PY{c+c1}{\PYZsh{}mod\PYZus{}uncons\PYZus{}5dens.compile(\PYZsq{}adadelta\PYZsq{},\PYZsq{}mse\PYZsq{}) \PYZsh{} careful, apparently compile does NOT reset weights and biases}
         \PY{c+c1}{\PYZsh{} See https://stackoverflow.com/questions/47995324/does\PYZhy{}model\PYZhy{}compile\PYZhy{}initialize\PYZhy{}all\PYZhy{}the\PYZhy{}weights\PYZhy{}and\PYZhy{}biases\PYZhy{}in\PYZhy{}keras\PYZhy{}tensorflow}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}65}]:} \PY{c+c1}{\PYZsh{}adad\PYZus{}cons\PYZus{}5dens.compile(\PYZsq{}adadelta\PYZsq{},\PYZsq{}mse\PYZsq{})}
         \PY{c+c1}{\PYZsh{}adam\PYZus{}cons\PYZus{}5dens.compile(\PYZsq{}adam\PYZsq{},\PYZsq{}mse\PYZsq{})}
         \PY{n}{lru\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rmsprop}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mse}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}31}]:} \PY{n}{lru\PYZus{}lagr099\PYZus{}5dens}\PY{o}{.}\PY{n}{summary}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
Layer (type)                 Output Shape              Param \#   
=================================================================
input\_8 (InputLayer)         (None, 304)               0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_43 (Dense)             (None, 512)               156160    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_43 (LeakyReLU)   (None, 512)               0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_44 (Dense)             (None, 512)               262656    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_44 (LeakyReLU)   (None, 512)               0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_45 (Dense)             (None, 512)               262656    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_45 (LeakyReLU)   (None, 512)               0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_46 (Dense)             (None, 512)               262656    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_46 (LeakyReLU)   (None, 512)               0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_47 (Dense)             (None, 512)               262656    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_47 (LeakyReLU)   (None, 512)               0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_48 (Dense)             (None, 158)               81054     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
leaky\_re\_lu\_48 (LeakyReLU)   (None, 158)               0         
=================================================================
Total params: 1,287,838
Trainable params: 1,287,838
Non-trainable params: 0
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}32}]:} \PY{c+c1}{\PYZsh{}hist\PYZus{}cons\PYZus{}5dens = mod\PYZus{}cons\PYZus{}5dens.fit\PYZus{}generator(gen, train\PYZus{}gen\PYZus{}obj.n\PYZus{}batches, epochs=20, \PYZbs{}}
         \PY{c+c1}{\PYZsh{}                     validation\PYZus{}data=validgen, validation\PYZus{}steps= valid\PYZus{}gen\PYZus{}obj.n\PYZus{}batches)}
         \PY{n}{hlru\PYZus{}uncons\PYZus{}5dens} \PY{o}{=} \PY{n}{lru\PYZus{}uncons\PYZus{}5dens}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PYZbs{}
                              \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
         \PY{n}{hlru\PYZus{}lagr001\PYZus{}5dens} \PY{o}{=} \PY{n}{lru\PYZus{}lagr001\PYZus{}5dens}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PYZbs{}
                              \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
         \PY{n}{hlru\PYZus{}lagr05\PYZus{}5dens} \PY{o}{=} \PY{n}{lru\PYZus{}lagr05\PYZus{}5dens}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PYZbs{}
                              \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
         \PY{n}{hlru\PYZus{}lagr099\PYZus{}5dens} \PY{o}{=} \PY{n}{lru\PYZus{}lagr099\PYZus{}5dens}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PYZbs{}
                              \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Epoch 1/20
18240/18240 [==============================] - 87s 5ms/step - loss: 154.2219 - val\_loss: 132.6228
Epoch 2/20
18240/18240 [==============================] - 86s 5ms/step - loss: 128.9841 - val\_loss: 123.7811
Epoch 3/20
18240/18240 [==============================] - 86s 5ms/step - loss: 124.9521 - val\_loss: 121.8379
Epoch 4/20
18240/18240 [==============================] - 86s 5ms/step - loss: 122.8963 - val\_loss: 121.3261
Epoch 5/20
18240/18240 [==============================] - 86s 5ms/step - loss: 121.5276 - val\_loss: 117.6229
Epoch 6/20
18240/18240 [==============================] - 86s 5ms/step - loss: 120.5954 - val\_loss: 121.6579
Epoch 7/20
18240/18240 [==============================] - 86s 5ms/step - loss: 119.8641 - val\_loss: 119.1938
Epoch 8/20
18240/18240 [==============================] - 86s 5ms/step - loss: 119.1895 - val\_loss: 118.0816
Epoch 9/20
18240/18240 [==============================] - 86s 5ms/step - loss: 118.6060 - val\_loss: 118.1369
Epoch 10/20
18240/18240 [==============================] - 86s 5ms/step - loss: 118.1955 - val\_loss: 118.5953
Epoch 11/20
18240/18240 [==============================] - 86s 5ms/step - loss: 117.8519 - val\_loss: 118.0504
Epoch 12/20
18240/18240 [==============================] - 86s 5ms/step - loss: 117.5264 - val\_loss: 115.6685
Epoch 13/20
18240/18240 [==============================] - 86s 5ms/step - loss: 117.2545 - val\_loss: 118.0217
Epoch 14/20
18240/18240 [==============================] - 86s 5ms/step - loss: 116.9527 - val\_loss: 114.6729
Epoch 15/20
18240/18240 [==============================] - 86s 5ms/step - loss: 116.6291 - val\_loss: 116.9361
Epoch 16/20
18240/18240 [==============================] - 86s 5ms/step - loss: 116.3771 - val\_loss: 116.2738
Epoch 17/20
18240/18240 [==============================] - 86s 5ms/step - loss: 116.0241 - val\_loss: 117.9957
Epoch 18/20
18240/18240 [==============================] - 86s 5ms/step - loss: 115.8352 - val\_loss: 114.6651
Epoch 19/20
18240/18240 [==============================] - 86s 5ms/step - loss: 115.7328 - val\_loss: 116.0567
Epoch 20/20
18240/18240 [==============================] - 86s 5ms/step - loss: 115.6272 - val\_loss: 115.1234
Epoch 1/20
18240/18240 [==============================] - 109s 6ms/step - loss: 279.2815 - val\_loss: 45.8440
Epoch 2/20
18240/18240 [==============================] - 108s 6ms/step - loss: 78.8534 - val\_loss: 32.2640
Epoch 3/20
18240/18240 [==============================] - 108s 6ms/step - loss: 65.0376 - val\_loss: 37.9883
Epoch 4/20
18240/18240 [==============================] - 108s 6ms/step - loss: 56.3387 - val\_loss: 29.2247
Epoch 5/20
18240/18240 [==============================] - 108s 6ms/step - loss: 47.7238 - val\_loss: 25.9967
Epoch 6/20
18240/18240 [==============================] - 108s 6ms/step - loss: 49.5093 - val\_loss: 40.9208
Epoch 7/20
18240/18240 [==============================] - 108s 6ms/step - loss: 45.7708 - val\_loss: 25.7273
Epoch 8/20
18240/18240 [==============================] - 108s 6ms/step - loss: 43.4656 - val\_loss: 23.2406
Epoch 9/20
18240/18240 [==============================] - 108s 6ms/step - loss: 39.8665 - val\_loss: 24.2402
Epoch 10/20
18240/18240 [==============================] - 108s 6ms/step - loss: 36.9975 - val\_loss: 25.1868
Epoch 11/20
18240/18240 [==============================] - 108s 6ms/step - loss: 34.4120 - val\_loss: 22.5863
Epoch 12/20
18240/18240 [==============================] - 108s 6ms/step - loss: 33.4274 - val\_loss: 18.1160
Epoch 13/20
18240/18240 [==============================] - 108s 6ms/step - loss: 33.1975 - val\_loss: 18.0872
Epoch 14/20
18240/18240 [==============================] - 108s 6ms/step - loss: 29.8914 - val\_loss: 39.3846
Epoch 15/20
18240/18240 [==============================] - 108s 6ms/step - loss: 30.1004 - val\_loss: 16.0262
Epoch 16/20
18240/18240 [==============================] - 108s 6ms/step - loss: 25.8132 - val\_loss: 13.1649
Epoch 17/20
18240/18240 [==============================] - 108s 6ms/step - loss: 24.8444 - val\_loss: 26.7432
Epoch 18/20
18240/18240 [==============================] - 108s 6ms/step - loss: 24.2640 - val\_loss: 13.6979
Epoch 19/20
18240/18240 [==============================] - 108s 6ms/step - loss: 25.7921 - val\_loss: 13.1149
Epoch 20/20
18240/18240 [==============================] - 108s 6ms/step - loss: 22.7902 - val\_loss: 30.9746
Epoch 1/20
18240/18240 [==============================] - 110s 6ms/step - loss: 632.6922 - val\_loss: 143.1930
Epoch 2/20
18240/18240 [==============================] - 109s 6ms/step - loss: 231.7961 - val\_loss: 159.9555
Epoch 3/20
18240/18240 [==============================] - 109s 6ms/step - loss: 178.6481 - val\_loss: 128.8459
Epoch 4/20
18240/18240 [==============================] - 108s 6ms/step - loss: 156.0807 - val\_loss: 223.5413
Epoch 5/20
18240/18240 [==============================] - 108s 6ms/step - loss: 142.9047 - val\_loss: 114.8590
Epoch 6/20
18240/18240 [==============================] - 109s 6ms/step - loss: 134.1219 - val\_loss: 126.5108
Epoch 7/20
18240/18240 [==============================] - 108s 6ms/step - loss: 127.5764 - val\_loss: 108.8627
Epoch 8/20
18240/18240 [==============================] - 109s 6ms/step - loss: 122.6618 - val\_loss: 106.5208
Epoch 9/20
18240/18240 [==============================] - 109s 6ms/step - loss: 118.2512 - val\_loss: 108.3259
Epoch 10/20
18240/18240 [==============================] - 108s 6ms/step - loss: 114.9018 - val\_loss: 109.5098
Epoch 11/20
18240/18240 [==============================] - 109s 6ms/step - loss: 112.4803 - val\_loss: 96.9939
Epoch 12/20
18240/18240 [==============================] - 109s 6ms/step - loss: 110.1654 - val\_loss: 87.7957
Epoch 13/20
18240/18240 [==============================] - 109s 6ms/step - loss: 108.1597 - val\_loss: 110.2080
Epoch 14/20
18240/18240 [==============================] - 109s 6ms/step - loss: 106.9789 - val\_loss: 90.0757
Epoch 15/20
18240/18240 [==============================] - 108s 6ms/step - loss: 105.8409 - val\_loss: 95.5189
Epoch 16/20
18240/18240 [==============================] - 109s 6ms/step - loss: 104.7966 - val\_loss: 93.1280
Epoch 17/20
18240/18240 [==============================] - 108s 6ms/step - loss: 103.9503 - val\_loss: 112.2287
Epoch 18/20
18240/18240 [==============================] - 109s 6ms/step - loss: 103.2746 - val\_loss: 116.8224
Epoch 19/20
18240/18240 [==============================] - 108s 6ms/step - loss: 102.4398 - val\_loss: 90.3887
Epoch 20/20
18240/18240 [==============================] - 109s 6ms/step - loss: 101.6766 - val\_loss: 97.1246
Epoch 1/20
18240/18240 [==============================] - 110s 6ms/step - loss: 180.8906 - val\_loss: 146.9150
Epoch 2/20
18240/18240 [==============================] - 108s 6ms/step - loss: 137.2709 - val\_loss: 137.7937
Epoch 3/20
18240/18240 [==============================] - 108s 6ms/step - loss: 131.4745 - val\_loss: 122.9277
Epoch 4/20
18240/18240 [==============================] - 108s 6ms/step - loss: 128.5962 - val\_loss: 127.9342
Epoch 5/20
18240/18240 [==============================] - 108s 6ms/step - loss: 126.6209 - val\_loss: 130.0188
Epoch 6/20
18240/18240 [==============================] - 108s 6ms/step - loss: 125.2875 - val\_loss: 122.0897
Epoch 7/20
18240/18240 [==============================] - 108s 6ms/step - loss: 124.3902 - val\_loss: 118.2646
Epoch 8/20
18240/18240 [==============================] - 108s 6ms/step - loss: 123.6979 - val\_loss: 119.3034
Epoch 9/20
18240/18240 [==============================] - 109s 6ms/step - loss: 122.8895 - val\_loss: 115.9213
Epoch 10/20
18240/18240 [==============================] - 108s 6ms/step - loss: 122.2438 - val\_loss: 119.0853
Epoch 11/20
18240/18240 [==============================] - 109s 6ms/step - loss: 121.7211 - val\_loss: 118.4655
Epoch 12/20
18240/18240 [==============================] - 108s 6ms/step - loss: 121.3323 - val\_loss: 124.9058
Epoch 13/20
18240/18240 [==============================] - 108s 6ms/step - loss: 120.9855 - val\_loss: 116.9817
Epoch 14/20
18240/18240 [==============================] - 108s 6ms/step - loss: 120.6312 - val\_loss: 114.9366
Epoch 15/20
18240/18240 [==============================] - 108s 6ms/step - loss: 120.4062 - val\_loss: 116.0103
Epoch 16/20
18240/18240 [==============================] - 108s 6ms/step - loss: 120.1427 - val\_loss: 115.3426
Epoch 17/20
18240/18240 [==============================] - 108s 6ms/step - loss: 119.9510 - val\_loss: 116.3888
Epoch 18/20
18240/18240 [==============================] - 108s 6ms/step - loss: 119.7063 - val\_loss: 114.2723
Epoch 19/20
18240/18240 [==============================] - 108s 6ms/step - loss: 119.5989 - val\_loss: 117.3125
Epoch 20/20
18240/18240 [==============================] - 108s 6ms/step - loss: 119.3734 - val\_loss: 120.5479

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}138}]:} \PY{n}{helu\PYZus{}cons\PYZus{}5dens} \PY{o}{=} \PY{n}{elu\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PYZbs{}
                               \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Epoch 1/20
18240/18240 [==============================] - 121s 7ms/step - loss: 336.0688 - val\_loss: 296.3247
Epoch 2/20
18240/18240 [==============================] - 120s 7ms/step - loss: 323.7683 - val\_loss: 4825.6380
Epoch 3/20
18240/18240 [==============================] - 120s 7ms/step - loss: 3513402.9420 - val\_loss: 249521.3613
Epoch 4/20
18240/18240 [==============================] - 120s 7ms/step - loss: 9099521.8309 - val\_loss: 1026.3550
Epoch 5/20
18240/18240 [==============================] - 120s 7ms/step - loss: 4348890.6503 - val\_loss: 66898.1627
Epoch 6/20
18240/18240 [==============================] - 120s 7ms/step - loss: 12398213.6755 - val\_loss: 776569.5652
Epoch 7/20
18240/18240 [==============================] - 120s 7ms/step - loss: 1885788.1738 - val\_loss: 28543841.1049
Epoch 8/20
18240/18240 [==============================] - 120s 7ms/step - loss: 9232902.0532 - val\_loss: 453502.1447
Epoch 9/20
18240/18240 [==============================] - 120s 7ms/step - loss: 2680327.0425 - val\_loss: 2273168.2878
Epoch 10/20
18240/18240 [==============================] - 120s 7ms/step - loss: 1709920.0244 - val\_loss: 1079.2892
Epoch 11/20
18240/18240 [==============================] - 120s 7ms/step - loss: 4796615.9038 - val\_loss: 2222.4436
Epoch 12/20
18240/18240 [==============================] - 120s 7ms/step - loss: 2681719.9998 - val\_loss: 220255.3103
Epoch 13/20
18240/18240 [==============================] - 120s 7ms/step - loss: 444597.5624 - val\_loss: 35795911.7784
Epoch 14/20
18240/18240 [==============================] - 120s 7ms/step - loss: 6571935.0741 - val\_loss: 6109942.0553
Epoch 15/20
18240/18240 [==============================] - 120s 7ms/step - loss: 29656610.5954 - val\_loss: 2013141.3405
Epoch 16/20
18240/18240 [==============================] - 120s 7ms/step - loss: 8807160.0480 - val\_loss: 277578.1424
Epoch 17/20
18240/18240 [==============================] - 120s 7ms/step - loss: 28720605.2059 - val\_loss: 4397054.3419
Epoch 18/20
18240/18240 [==============================] - 120s 7ms/step - loss: 8689388.7740 - val\_loss: 25718893.5175
Epoch 19/20
18240/18240 [==============================] - 120s 7ms/step - loss: 35075400.8750 - val\_loss: 381069.9943
Epoch 20/20
18240/18240 [==============================] - 120s 7ms/step - loss: 146080066.8281 - val\_loss: 18432155.0713

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}17}]:} \PY{c+c1}{\PYZsh{}hadad\PYZus{}cons\PYZus{}5dens = adad\PYZus{}cons\PYZus{}5dens.fit\PYZus{}generator(gen, train\PYZus{}gen\PYZus{}obj.n\PYZus{}batches, epochs=20, \PYZbs{}}
         \PY{c+c1}{\PYZsh{}                     validation\PYZus{}data=validgen, validation\PYZus{}steps= valid\PYZus{}gen\PYZus{}obj.n\PYZus{}batches)}
         \PY{c+c1}{\PYZsh{}hadam\PYZus{}cons\PYZus{}5dens = adam\PYZus{}cons\PYZus{}5dens.fit\PYZus{}generator(gen, train\PYZus{}gen\PYZus{}obj.n\PYZus{}batches, epochs=20, \PYZbs{}}
         \PY{c+c1}{\PYZsh{}                     validation\PYZus{}data=validgen, validation\PYZus{}steps= valid\PYZus{}gen\PYZus{}obj.n\PYZus{}batches)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Epoch 1/20
18240/18240 [==============================] - 118s 6ms/step - loss: 143.5000 - val\_loss: 124.6938
Epoch 2/20
18240/18240 [==============================] - 118s 6ms/step - loss: 125.1558 - val\_loss: 120.1842
Epoch 3/20
18240/18240 [==============================] - 118s 6ms/step - loss: 121.0790 - val\_loss: 119.0333
Epoch 4/20
18240/18240 [==============================] - 117s 6ms/step - loss: 118.6843 - val\_loss: 117.5636
Epoch 5/20
18240/18240 [==============================] - 118s 6ms/step - loss: 117.2775 - val\_loss: 117.4019
Epoch 6/20
18240/18240 [==============================] - 118s 6ms/step - loss: 120.1646 - val\_loss: 116.4241
Epoch 7/20
18240/18240 [==============================] - 117s 6ms/step - loss: 119.7096 - val\_loss: 115.8942
Epoch 8/20
18240/18240 [==============================] - 117s 6ms/step - loss: 130.5041 - val\_loss: 116.9329
Epoch 9/20
18240/18240 [==============================] - 117s 6ms/step - loss: 117.4099 - val\_loss: 115.7471
Epoch 10/20
18240/18240 [==============================] - 118s 6ms/step - loss: 117.5883 - val\_loss: 115.2551
Epoch 11/20
18240/18240 [==============================] - 117s 6ms/step - loss: 470.2844 - val\_loss: 118.0117
Epoch 12/20
18240/18240 [==============================] - 117s 6ms/step - loss: 284.2986 - val\_loss: 116.1908
Epoch 13/20
18240/18240 [==============================] - 118s 6ms/step - loss: 116.5168 - val\_loss: 115.2569
Epoch 14/20
18240/18240 [==============================] - 118s 6ms/step - loss: 122.5248 - val\_loss: 115.6265
Epoch 15/20
18240/18240 [==============================] - 118s 6ms/step - loss: 126.2000 - val\_loss: 117.3691
Epoch 16/20
18240/18240 [==============================] - 117s 6ms/step - loss: 117.9970 - val\_loss: 114.7944
Epoch 17/20
18240/18240 [==============================] - 118s 6ms/step - loss: 119.4262 - val\_loss: 115.2949
Epoch 18/20
18240/18240 [==============================] - 118s 6ms/step - loss: 238.9308 - val\_loss: 114.7101
Epoch 19/20
18240/18240 [==============================] - 117s 6ms/step - loss: 121.1812 - val\_loss: 114.9700
Epoch 20/20
18240/18240 [==============================] - 117s 6ms/step - loss: 130.0276 - val\_loss: 114.8401

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}20}]:} \PY{n}{hrmsp\PYZus{}cons\PYZus{}5dens} \PY{o}{=} \PY{n}{rmsp\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{fit\PYZus{}generator}\PY{p}{(}\PY{n}{gen}\PY{p}{,} \PY{n}{train\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PYZbs{}
                              \PY{n}{validation\PYZus{}data}\PY{o}{=}\PY{n}{validgen}\PY{p}{,} \PY{n}{validation\PYZus{}steps}\PY{o}{=} \PY{n}{valid\PYZus{}gen\PYZus{}obj}\PY{o}{.}\PY{n}{n\PYZus{}batches}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Epoch 1/20
18240/18240 [==============================] - 112s 6ms/step - loss: 170.8195 - val\_loss: 129.4829
Epoch 2/20
18240/18240 [==============================] - 111s 6ms/step - loss: 135.4032 - val\_loss: 123.5065
Epoch 3/20
18240/18240 [==============================] - 111s 6ms/step - loss: 130.3239 - val\_loss: 120.4736
Epoch 4/20
18240/18240 [==============================] - 112s 6ms/step - loss: 127.6721 - val\_loss: 117.6087
Epoch 5/20
18240/18240 [==============================] - 111s 6ms/step - loss: 126.0467 - val\_loss: 119.3136
Epoch 6/20
18240/18240 [==============================] - 111s 6ms/step - loss: 124.7047 - val\_loss: 116.3503
Epoch 7/20
18240/18240 [==============================] - 111s 6ms/step - loss: 123.7101 - val\_loss: 119.1667
Epoch 8/20
18240/18240 [==============================] - 111s 6ms/step - loss: 122.9899 - val\_loss: 116.2005
Epoch 9/20
18240/18240 [==============================] - 111s 6ms/step - loss: 122.4724 - val\_loss: 121.2840
Epoch 10/20
18240/18240 [==============================] - 112s 6ms/step - loss: 122.0441 - val\_loss: 114.6832
Epoch 11/20
18240/18240 [==============================] - 111s 6ms/step - loss: 121.5119 - val\_loss: 114.8171
Epoch 12/20
18240/18240 [==============================] - 111s 6ms/step - loss: 121.1994 - val\_loss: 114.1490
Epoch 13/20
18240/18240 [==============================] - 111s 6ms/step - loss: 120.8153 - val\_loss: 115.0905
Epoch 14/20
18240/18240 [==============================] - 111s 6ms/step - loss: 120.4686 - val\_loss: 115.3960
Epoch 15/20
18240/18240 [==============================] - 111s 6ms/step - loss: 120.1861 - val\_loss: 113.8197
Epoch 16/20
18240/18240 [==============================] - 112s 6ms/step - loss: 119.8836 - val\_loss: 113.5153
Epoch 17/20
18240/18240 [==============================] - 112s 6ms/step - loss: 119.6307 - val\_loss: 114.7056
Epoch 18/20
18240/18240 [==============================] - 112s 6ms/step - loss: 119.3775 - val\_loss: 116.3110
Epoch 19/20
18240/18240 [==============================] - 111s 6ms/step - loss: 119.1554 - val\_loss: 113.1133
Epoch 20/20
18240/18240 [==============================] - 111s 6ms/step - loss: 119.0164 - val\_loss: 114.1845

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}38}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
         
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         
         \PY{k}{for} \PY{n}{index} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{5}\PY{p}{)}\PY{p}{:}
             \PY{k}{if} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hrmsp\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bo}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{b}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{1}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hlru\PYZus{}uncons\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{U}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{2}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hlru\PYZus{}lagr001\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{go}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W001}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{3}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hlru\PYZus{}lagr05\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{co}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{c}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W05}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{4}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hlru\PYZus{}lagr099\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mo}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{m}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W099}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
                 
             
             \PY{n}{train\PYZus{}loss\PYZus{}values} \PY{o}{=} \PY{n}{hdict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{valid\PYZus{}loss\PYZus{}values} \PY{o}{=} \PY{n}{hdict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{epochs} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
         
             \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values}\PY{p}{,} \PY{n}{colo}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ Train}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values}\PY{p}{,} \PY{n}{col}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ Valid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{}plt.title(\PYZsq{}Training and validation loss\PYZsq{})}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Epochs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Loss (W/m\PYZca{}2)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{110}\PY{p}{,} \PY{l+m+mi}{130}\PY{p}{)}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} https://stackoverflow.com/questions/4700614/how\PYZhy{}to\PYZhy{}put\PYZhy{}the\PYZhy{}legend\PYZhy{}out\PYZhy{}of\PYZhy{}the\PYZhy{}plot}
         \PY{c+c1}{\PYZsh{} for legend at the right place}
         \PY{c+c1}{\PYZsh{}ax.legend(loc=\PYZsq{}upper center\PYZsq{}, bbox\PYZus{}to\PYZus{}anchor=(0.5, 1.05),}
         \PY{c+c1}{\PYZsh{}          ncol=5, fancybox=True, shadow=True); }
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_54_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}23}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
         
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}\PY{p}{;} \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         
         \PY{k}{for} \PY{n}{index} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{:}
             \PY{k}{if} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{2}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hist\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bo}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{b}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Adadelta}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hadam\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Adam}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{1}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hrmsp\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{go}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{RmsProp}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
                 
             
             \PY{n}{train\PYZus{}loss\PYZus{}values} \PY{o}{=} \PY{n}{hdict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{;} \PY{n}{valid\PYZus{}loss\PYZus{}values} \PY{o}{=} \PY{n}{hdict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{epochs} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
         
             \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values}\PY{p}{,} \PY{n}{colo}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ Train}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values}\PY{p}{,} \PY{n}{col}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ Valid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Epochs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Loss (W/m\PYZca{}2)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{100}\PY{p}{,} \PY{l+m+mi}{200}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper center}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_55_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{c+c1}{\PYZsh{} import matplotlib.pyplot as plt}
        
        \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{,} \PY{l+m+mf}{13.5}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
        
        \PY{k}{for} \PY{n}{index} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{:}
            \PY{k}{if} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hist\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bo}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{b}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ReLU}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
            \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{2}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{helu\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ExpLU}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
            \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{1}\PY{p}{:} \PY{n}{hdict} \PY{o}{=} \PY{n}{hlru\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{history}\PY{p}{;} \PY{n}{colo} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{go}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{col} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{g}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{LeakyReLU}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
                
            
            \PY{n}{train\PYZus{}loss\PYZus{}values} \PY{o}{=} \PY{n}{hdict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{;} \PY{n}{valid\PYZus{}loss\PYZus{}values} \PY{o}{=} \PY{n}{hdict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{epochs} \PY{o}{=} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{train\PYZus{}loss\PYZus{}values}\PY{p}{)} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
        
            \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs}\PY{p}{,} \PY{n}{train\PYZus{}loss\PYZus{}values}\PY{p}{,} \PY{n}{colo}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ Train}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{ax}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{epochs}\PY{p}{,} \PY{n}{valid\PYZus{}loss\PYZus{}values}\PY{p}{,} \PY{n}{col}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ Valid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
        \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Epochs}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{25}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Loss (W per m2)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{25}\PY{p}{)}\PY{p}{;}
        \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{25}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{25}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{500}\PY{p}{)}\PY{p}{)}
        \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper center}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                  \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{25}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}34}]:} \PY{n}{pred\PYZus{}uncons} \PY{o}{=} \PY{n}{mod\PYZus{}uncons\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{x}\PY{p}{)}
         \PY{n}{pred\PYZus{}cons} \PY{o}{=} \PY{n}{mod\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{x}\PY{p}{)}
         \PY{n}{ind\PYZus{}test} \PY{o}{=} \PY{l+m+mi}{150}\PY{p}{;}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred\PYZus{}uncons}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{unconstrained}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{pred\PYZus{}cons}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{conserving}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{y}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}\PY{p}{;}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{truth=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{y}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{l+m+mi}{140}\PY{p}{:}\PY{p}{]}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{unconstrained=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{pred\PYZus{}uncons}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{l+m+mi}{140}\PY{p}{:}\PY{p}{]}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{conserving=}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{pred\PYZus{}cons}\PY{p}{[}\PY{n}{ind\PYZus{}test}\PY{p}{,}\PY{l+m+mi}{140}\PY{p}{:}\PY{p}{]}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
truth= [ 7.9672202e-05  4.7920624e-04  2.4025740e-02  5.5195879e-02
  1.1413122e-01  9.9763870e-02  2.2796452e-02  8.7691424e-03
  9.2103053e-03  7.1256983e-01  7.7988184e+02  5.6302869e+02
  2.6318073e+02  6.2778019e+01  6.9902046e-03 -7.8684932e-01
  0.0000000e+00 -2.4350360e-01]
unconstrained= [  0.          0.          0.          0.          0.          0.
   0.          0.          0.          1.3625866 788.68677   562.22266
 282.95648    55.21782     5.0673413   0.          0.          0.       ]
conserving= [0.         0.4019227  0.00784189 0.03601322 0.         0.46972626
 0.20347854 0.31218743 0.21515115 0.         0.         0.
 0.         0.         0.15628235 0.2403318  0.10572945 0.        ]

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_57_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{step-5-check-energy-and-mass-conservation-for-the-predictions}{%
\paragraph{Step 5: Check energy and mass conservation for the
predictions}\label{step-5-check-energy-and-mass-conservation-for-the-predictions}}

If we coded the mass/enthalpy conservation layers properly\\
pred\_cons from the mass/enthalpy-conserving model\_cons should conserve
mass/energy\\
pred\_uncons which is a ``naive'' dense network should not a priori
conserve mass/energy\\
The function below is directly adapted from the tested mass/enthalpy
conservation layers in numpy that have been used to develop the
tensorflow layers

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}47}]:} \PY{k}{def} \PY{n+nf}{massent\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,}\PY{n}{outtype}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{graph}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}\PY{p}{:}
             \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
             \PY{c+c1}{\PYZsh{} 0) Constants}
             \PY{n}{G} \PY{o}{=} \PY{l+m+mf}{9.80616}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference gravity constant [m.s\PYZhy{}2]}
             \PY{n}{L\PYZus{}F} \PY{o}{=} \PY{l+m+mf}{3.337e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of fusion of water [W.kg\PYZhy{}1]}
             \PY{n}{L\PYZus{}V} \PY{o}{=} \PY{l+m+mf}{2.501e6}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of vaporization of water [W.kg\PYZhy{}1]}
             \PY{n}{L\PYZus{}S} \PY{o}{=} \PY{n}{L\PYZus{}F}\PY{o}{+}\PY{n}{L\PYZus{}V}\PY{p}{;} \PY{c+c1}{\PYZsh{} Latent heat of sublimation of water [W.kg\PYZhy{}1]}
             \PY{n}{P0} \PY{o}{=} \PY{l+m+mf}{1e5}\PY{p}{;} \PY{c+c1}{\PYZsh{} Reference surface pressure [Pa]   }
         
             \PY{c+c1}{\PYZsh{} WATER\PYZam{}ENTHALPY) Get non\PYZhy{}dimensional pressure differences (p\PYZus{}tilde above)}
             \PY{c+c1}{\PYZsh{} In the input vector, PS is the 151st element after }
             \PY{c+c1}{\PYZsh{} the first elements = [QBP, ..., VBP with shape 30*5=150]}
             \PY{n}{PS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{300}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} Reference for calculation of d\PYZus{}pressure is cbrain/models.py (e.g. QLayer)}
             \PY{n}{P} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{P0}\PY{p}{,} \PY{n}{hyai}\PY{p}{)}\PY{p}{,} \PYZbs{}
             \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{PS}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{k+kc}{None}\PY{p}{]}\PY{p}{,} \PY{n}{hybi}\PY{p}{)}\PY{p}{)}
             \PY{n}{dP} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{,} \PY{n}{P}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} norm\PYZus{}output = dp\PYZus{}norm * L\PYZus{}V/G so dp\PYZus{}norm = norm\PYZus{}output * G/L\PYZus{}V}
             \PY{n}{dP\PYZus{}NORM} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PYZbs{}
             \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PYZbs{}
                       \PY{n}{G}\PY{p}{)}\PY{p}{,}\PYZbs{}
             \PY{n}{L\PYZus{}V}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} dp\PYZus{}tilde = dp/dp\PYZus{}norm}
             \PY{n}{dP\PYZus{}TILD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dP}\PY{p}{,} \PY{n}{dP\PYZus{}NORM}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} WATER.1) Calculate water vertical integral from level 1 to level 30}
             \PY{n}{WATVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]} \PY{o}{+} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]} \PY{o}{+} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}
             \PY{n}{WATINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{WATVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} WATER.2) Calculate forcing on the right\PYZhy{}hand side (Net Evaporation\PYZhy{}Precipitation)}
             \PY{c+c1}{\PYZsh{} E\PYZhy{}P is already normalized to units W.m\PYZhy{}2 in the output vector}
             \PY{c+c1}{\PYZsh{} so all we need to do is input\PYZhy{}unnormalize LHF that is taken from the input vector}
             \PY{n}{LHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{303}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} Note that total precipitation = PRECT + 1e\PYZhy{}3*PRECTEND in the CAM model}
             \PY{c+c1}{\PYZsh{} PRECTEND already multiplied by 1e\PYZhy{}3 in output vector so no need to redo it}
             \PY{n}{PREC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{154}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{155}\PY{p}{]}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} WATER.FINAL) Residual = E\PYZhy{}P\PYZhy{}DWATER/DT}
             \PY{n}{WATRES} \PY{o}{=} \PY{n}{LHF}\PY{o}{\PYZhy{}}\PY{n}{PREC}\PY{o}{\PYZhy{}}\PY{n}{WATINT}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.1) Calculate net energy input from phase change and precipitation}
             \PY{c+c1}{\PYZsh{} PHAS = Lf/Lv*((PRECST+PRECSTEN)\PYZhy{}(PRECT+PRECTEND))}
             \PY{n}{PHAS} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                   \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{156}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{157}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                   \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{154}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{155}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                           \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                              \PY{n}{L\PYZus{}V}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.2) Calculate net energy input from radiation, sensible heat flux and turbulent KE}
             \PY{c+c1}{\PYZsh{} 2.1) RAD = FSNT\PYZhy{}FSNS\PYZhy{}FLNT+FLNS}
             \PY{n}{RAD} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PYZbs{}
                     \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{151}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                     \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{153}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{152}\PY{p}{]}\PY{p}{)}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} 2.2) Unnormalize sensible heat flux}
             \PY{n}{SHF} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[}\PY{l+m+mi}{302}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} 2.3) Net turbulent kinetic energy dissipative heating is the column\PYZhy{}integrated }
             \PY{c+c1}{\PYZsh{} turbulent kinetic energy energy dissipative heating}
             \PY{n}{KEDVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{120}\PY{p}{:}\PY{l+m+mi}{150}\PY{p}{]}\PY{p}{)}
             \PY{n}{KEDINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{KEDVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.3) Calculate tendency of normalized column water vapor due to phase change}
             \PY{c+c1}{\PYZsh{} 3.1) Column water vapor is the column integral of specific humidity}
             \PY{n}{PHQVEC} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
             \PY{n}{PHQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{PHQVEC}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} 3.2) Multiply by L\PYZus{}S/L\PYZus{}V to normalize (explanation above)}
             \PY{n}{SPDQINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PYZbs{}
                                                          \PY{n}{PHQINT}\PY{p}{,} \PY{n}{LHF}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                             \PY{n}{L\PYZus{}S}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{L\PYZus{}V}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.4) Same operation for liquid water tendency but multiplied by L\PYZus{}F/L\PYZus{}V}
             \PY{n}{SPDQCINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(}\PYZbs{}
                                           \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PYZbs{}
                                                  \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                                  \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                           \PY{n}{L\PYZus{}F}\PY{p}{)}\PY{p}{,}\PYZbs{}
                              \PY{n}{L\PYZus{}V}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.5) Same operation for temperature tendency}
             \PY{n}{DTINT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{dP\PYZus{}TILD}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{90}\PY{p}{:}\PY{l+m+mi}{120}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} ENTHALPY.FINAL) Residual = SPDQ+SPDQC+DTINT\PYZhy{}RAD\PYZhy{}SHF\PYZhy{}PHAS}
             \PY{n}{ENTRES} \PY{o}{=} \PY{n}{SPDQINT}\PY{o}{+}\PY{n}{SPDQCINT}\PY{o}{+}\PY{n}{DTINT}\PY{o}{\PYZhy{}}\PY{n}{RAD}\PY{o}{\PYZhy{}}\PY{n}{SHF}\PY{o}{\PYZhy{}}\PY{n}{PHAS}\PY{o}{\PYZhy{}}\PY{n}{KEDINT}
             
             \PY{k}{if} \PY{n}{outtype}\PY{o}{==}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{graph}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}
             
                 \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
                 \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
                 \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
                 \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{121}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{WATRES}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ Residual}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[W.m\PYZca{}}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZhy{}2\PYZcb{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
         
                 \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{122}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{ENTRES}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Enthalpy}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ Residual}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[W.m\PYZca{}}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{\PYZhy{}2\PYZcb{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             
             \PY{k}{elif} \PY{n}{outtype}\PY{o}{==}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{list}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}
             
                 \PY{k}{return} \PY{n}{WATRES}\PY{p}{,}\PY{n}{ENTRES} 
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}67}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
         \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{,} \PY{l+m+mf}{13.5}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{XMAX} \PY{o}{=} \PY{l+m+mi}{180}\PY{p}{;} \PY{n}{bins} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{XMAX}\PY{p}{,} \PY{l+m+mi}{100}\PY{p}{)}
         
         \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{validgen}\PY{p}{)}
         
         \PY{k}{for} \PY{n}{index} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{5}\PY{p}{)}\PY{p}{:}
             \PY{k}{if} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}uncons\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{U}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{1}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{2}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}lagr001\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W001}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{3}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}lagr05\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W05}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{4}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}lagr099\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W099}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
         
             \PY{n}{res} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{p}{(}\PY{n}{pred}\PY{o}{\PYZhy{}}\PY{n}{yval}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{;}
             
             \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{index}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{res}\PY{p}{,} \PY{n}{bins}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label} \PY{o}{=} \PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ m}\PY{l+s+si}{\PYZpc{}i}\PY{l+s+s1}{\PYZsq{}} \PY{o}{\PYZpc{}}\PY{k}{np}.mean(res)+\PYZsq{} std\PYZpc{}i\PYZsq{} \PYZpc{}np.std(res))
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Nb samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{)}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{XMAX}\PY{p}{)}\PY{p}{)}\PY{p}{;}
             \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper center}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fontsize} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{)}\PY{p}{;} 
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_60_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}68}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
         \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{,} \PY{l+m+mf}{13.5}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{XMAX} \PY{o}{=} \PY{l+m+mi}{100}\PY{p}{;} \PY{n}{bins} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{XMAX}\PY{p}{,} \PY{n}{XMAX}\PY{p}{,} \PY{l+m+mi}{100}\PY{p}{)}
         
         \PY{n}{xval}\PY{p}{,} \PY{n}{yval} \PY{o}{=} \PY{n+nb}{next}\PY{p}{(}\PY{n}{validgen}\PY{p}{)}
         
         \PY{k}{for} \PY{n}{index} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{5}\PY{p}{)}\PY{p}{:}
             \PY{k}{if} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}uncons\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{U}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{1}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{2}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}lagr001\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W001}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{3}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}lagr05\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W05}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
             \PY{k}{elif} \PY{n}{index}\PY{o}{==}\PY{l+m+mi}{4}\PY{p}{:} \PY{n}{pred} \PY{o}{=} \PY{n}{lru\PYZus{}lagr099\PYZus{}5dens}\PY{o}{.}\PY{n}{predict\PYZus{}on\PYZus{}batch}\PY{p}{(}\PY{n}{xval}\PY{p}{)}\PY{p}{;} \PY{n}{lab} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{W099}\PY{l+s+s1}{\PYZsq{}}\PY{p}{;}
         
             \PY{n}{watres}\PY{p}{,}\PY{n}{entres} \PY{o}{=} \PY{n}{massent\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{pred}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{hyai}\PY{o}{=}\PY{n}{hyai}\PY{p}{,}\PY{n}{hybi}\PY{o}{=}\PY{n}{hybi}\PY{p}{,}\PY{n}{outtype}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{list}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}\PY{p}{;}
         
             \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{index}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{watres}\PY{p}{,} \PY{n}{bins}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label} \PY{o}{=} \PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ mSQ}\PY{l+s+si}{\PYZpc{}i}\PY{l+s+s1}{\PYZsq{}} \PY{o}{\PYZpc{}}\PY{k}{np}.mean(watres**2)+\PYZsq{} stdSQ\PYZpc{}i\PYZsq{} \PYZpc{}np.std(watres**2))
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Nb samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{50}\PY{p}{)}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{XMAX}\PY{p}{,} \PY{n}{XMAX}\PY{p}{)}\PY{p}{)}\PY{p}{;}
             \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper left}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fontsize} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{)}\PY{p}{;}
             
             \PY{n}{ax} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{index}\PY{o}{+}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{n}{ax}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{entres}\PY{p}{,} \PY{n}{bins}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label} \PY{o}{=} \PY{n}{lab}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ mSQ}\PY{l+s+si}{\PYZpc{}i}\PY{l+s+s1}{\PYZsq{}} \PY{o}{\PYZpc{}}\PY{k}{np}.mean(entres**2)+\PYZsq{} stdSQ\PYZpc{}i\PYZsq{} \PYZpc{}np.std(entres**2))
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Nb samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{50}\PY{p}{)}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{XMAX}\PY{p}{,} \PY{n}{XMAX}\PY{p}{)}\PY{p}{)}\PY{p}{;}
             \PY{n}{ax}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper left}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{bbox\PYZus{}to\PYZus{}anchor}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mf}{1.05}\PY{p}{)}\PY{p}{,}
                   \PY{n}{ncol}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{,} \PY{n}{fancybox}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{shadow}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fontsize} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{)}\PY{p}{;} 
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_61_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{step-6-check-positivity-of-water-species}{%
\paragraph{Step 6: Check positivity of water
species}\label{step-6-check-positivity-of-water-species}}

There are two necessary steps:\\
1) Load the water species concentrations ``before physics'' from the
input vector and unnormalize them\\
2) Invert the output normalization to get the water concentrations
``after physics''

\[
\delta q_{v,i,l}\left(p\right)=\frac{L_{v}\Delta p_{\mathrm{norm}}}{g}\frac{q_{v,i,l}^{a}\left(p\right)-q_{v,i,l}^{b}\left(p\right)}{\Delta t}\ \Rightarrow\ q_{v,i,l}^{a}\left(p\right)=q_{v,i,l}^{b}\left(p\right)+\frac{g\Delta t}{L_{v}\Delta p_{\mathrm{norm}}}\delta q_{v,i,l}\left(p\right)
\]

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}145}]:} \PY{k}{def} \PY{n+nf}{watpos\PYZus{}check}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{fsub}\PY{o}{=}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{o}{=}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{o}{=}\PY{n}{normq}\PY{p}{,}\PY{n}{dt}\PY{o}{=}\PY{l+m+mi}{30}\PY{o}{*}\PY{l+m+mi}{60}\PY{p}{)}\PY{p}{:}
              
              \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
          
              \PY{c+c1}{\PYZsh{} 1) Extract water species concentrations from inputs}
              \PY{n}{QVB} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{QLB} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]}\PY{p}{)}
              \PY{n}{QSB} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{add}\PY{p}{(} \PY{n}{np}\PY{o}{.}\PY{n}{multiply}\PY{p}{(} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{,} \PY{n}{fdiv}\PY{p}{[} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{fsub}\PY{p}{[} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]}\PY{p}{)}
          
              \PY{c+c1}{\PYZsh{} 2) Inverse output normalization and get water concentration after physics}
              \PY{n}{QVA} \PY{o}{=} \PY{n}{QVB} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dt}\PY{o}{*}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]} \PY{p}{,} \PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{QLA} \PY{o}{=} \PY{n}{QLB} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dt}\PY{o}{*}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{30}\PY{p}{:}\PY{l+m+mi}{60}\PY{p}{]} \PY{p}{,} \PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
              \PY{n}{QSA} \PY{o}{=} \PY{n}{QSB} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{divide}\PY{p}{(} \PY{n}{dt}\PY{o}{*}\PY{n}{y}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{60}\PY{p}{:}\PY{l+m+mi}{90}\PY{p}{]} \PY{p}{,} \PY{n}{normq}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{30}\PY{p}{]}\PY{p}{)}
          
              \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
              \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{rc}
              \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{text}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{usetex}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{rc}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{family}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{serif}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{num}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}\PY{p}{,} \PY{n}{dpi}\PY{o}{=}\PY{l+m+mi}{80}\PY{p}{,} \PY{n}{facecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{w}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{edgecolor}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{k}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{231}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{n}{QVA}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ vapor}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ concentration}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{232}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{n}{QLA}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Liquid}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ concentration}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{233}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{n}{QSA}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Ice}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ concentration}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
              
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{234}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{p}{(}\PY{n}{QVA}\PY{o}{\PYZhy{}}\PY{n}{QVB}\PY{p}{)}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ vapor}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ change}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of samples}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{235}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{p}{(}\PY{n}{QLA}\PY{o}{\PYZhy{}}\PY{n}{QLB}\PY{p}{)}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Liquid}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ water}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ change}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
          
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{236}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{l+m+mf}{1e3}\PY{o}{*}\PY{p}{(}\PY{n}{QSA}\PY{o}{\PYZhy{}}\PY{n}{QSB}\PY{p}{)}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+sa}{r}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZdl{}}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{mathrm}\PY{l+s+s2}{\PYZob{}}\PY{l+s+s2}{Ice}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ change}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{ }\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{left[g/kg}\PY{l+s+s2}{\PYZbs{}}\PY{l+s+s2}{right]\PYZcb{}\PYZdl{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}\PY{p}{;} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{fontsize}\PY{o}{=}\PY{l+m+mi}{14}\PY{p}{)}
              
              \PY{n}{plt}\PY{o}{.}\PY{n}{subplots\PYZus{}adjust}\PY{p}{(}\PY{n}{left}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{bottom}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{wspace}\PY{o}{=}\PY{k+kc}{None}\PY{p}{,} \PY{n}{hspace}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}146}]:} \PY{n}{watpos\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{yval}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{dt}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_64_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}154}]:} \PY{n}{watpos\PYZus{}check}\PY{p}{(}\PY{n}{xval}\PY{p}{,}\PY{n}{pred6}\PY{p}{,}\PY{n}{fsub}\PY{p}{,}\PY{n}{fdiv}\PY{p}{,}\PY{n}{normq}\PY{p}{,}\PY{n}{dt}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_65_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{last-step-save-trained-models-as-h5-files}{%
\paragraph{Last step: Save trained models as h5
files}\label{last-step-save-trained-models-as-h5-files}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}74}]:} \PY{o}{\PYZpc{}}\PY{k}{cd} \PYZdl{}TRAINDIR/HDF5\PYZus{}DATA
         \PY{o}{!}pwd
         \PY{c+c1}{\PYZsh{}lru\PYZus{}lagr05\PYZus{}5dens.save(\PYZsq{}lru\PYZus{}lagr05\PYZus{}5dens.h5\PYZsq{})}
         \PY{c+c1}{\PYZsh{}lru\PYZus{}lagr001\PYZus{}5dens.save(\PYZsq{}lru\PYZus{}lagr001\PYZus{}5dens.h5\PYZsq{})}
         \PY{c+c1}{\PYZsh{}lru\PYZus{}lagr099\PYZus{}5dens.save(\PYZsq{}lru\PYZus{}lagr099\PYZus{}5dens.h5\PYZsq{})}
         \PY{c+c1}{\PYZsh{}lru\PYZus{}uncons\PYZus{}5dens.save(\PYZsq{}lru\PYZus{}uncons\PYZus{}5dens.h5\PYZsq{})}
         \PY{c+c1}{\PYZsh{}lru\PYZus{}cons\PYZus{}5dens.save(\PYZsq{}lru\PYZus{}cons\PYZus{}5dens.h5\PYZsq{})}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/data/Tom.Beucler/SPCAM\_PHYS/HDF5\_DATA
/data/Tom.Beucler/SPCAM\_PHYS/HDF5\_DATA

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}55}]:} \PY{n}{rmsp\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{save\PYZus{}weights}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tmp.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}66}]:} \PY{n}{lru\PYZus{}cons\PYZus{}5dens}\PY{o}{.}\PY{n}{load\PYZus{}weights}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tmp.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}



    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
